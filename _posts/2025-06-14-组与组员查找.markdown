---
layout:     post
title:      "ç»„ä¸ç»„å‘˜çš„æŸ¥æ‰¾"
subtitle:   ""
date:       2025-06-14
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - Django
    - pgsql
---

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Django å•å…ƒæµ‹è¯•ä»£ç ç¤ºä¾‹ï¼Œç”¨äºæµ‹è¯•ä½ è¿™ä¸ªâ€œæ‰¾å‡ºæ ‡ç­¾é›†åˆå®Œå…¨ä¸€è‡´çš„ `TagGroup`â€é€»è¾‘ï¼Œ**ä¸ä½¿ç”¨åŸç”Ÿ SQLï¼Œä»…ä½¿ç”¨ Django ORM**ï¼ˆä¾èµ– PostgreSQL çš„ `ArrayAgg`ï¼‰ã€‚

------

## âœ… æ¨¡å‹å‡è®¾ï¼ˆç”¨äºæµ‹è¯•ï¼‰

```python
# models.py
from django.db import models

class TagGroup(models.Model):
    name = models.CharField(max_length=100)

class TagDetail(models.Model):
    tag_group = models.ForeignKey(TagGroup, on_delete=models.CASCADE, related_name='details')
    name = models.CharField(max_length=100)
```

------

## âœ… æŸ¥è¯¢å‡½æ•°ï¼ˆéœ€å…ˆå¼•å…¥ï¼‰

```python
# utils.py æˆ– services.py
from django.db.models import ArrayAgg
from yourapp.models import TagGroup, TagDetail

def get_same_tag_groups(group_id):
    target_names = list(
        TagDetail.objects
        .filter(tag_group_id=group_id)
        .order_by('name')
        .values_list('name', flat=True)
    )

    if not target_names:
        return []

    groups = (
        TagGroup.objects
        .annotate(tag_names=ArrayAgg('details__name', ordering='details__name'))
        .filter(tag_names=target_names)
        .values_list('id', flat=True)
    )

    return list(groups)
```

------

## âœ… å•å…ƒæµ‹è¯•ä»£ç 

```python
# tests.py
from django.test import TestCase
from yourapp.models import TagGroup, TagDetail
from yourapp.utils import get_same_tag_groups

class TagGroupMatchingTest(TestCase):
    def setUp(self):
        # Group A: apple, banana
        self.group_a = TagGroup.objects.create(name='Group A')
        TagDetail.objects.bulk_create([
            TagDetail(tag_group=self.group_a, name='apple'),
            TagDetail(tag_group=self.group_a, name='banana'),
        ])

        # Group B: banana, apple (same as A but unordered)
        self.group_b = TagGroup.objects.create(name='Group B')
        TagDetail.objects.bulk_create([
            TagDetail(tag_group=self.group_b, name='banana'),
            TagDetail(tag_group=self.group_b, name='apple'),
        ])

        # Group C: apple only
        self.group_c = TagGroup.objects.create(name='Group C')
        TagDetail.objects.create(tag_group=self.group_c, name='apple')

        # Group D: apple, banana, cherry (extra tag)
        self.group_d = TagGroup.objects.create(name='Group D')
        TagDetail.objects.bulk_create([
            TagDetail(tag_group=self.group_d, name='apple'),
            TagDetail(tag_group=self.group_d, name='banana'),
            TagDetail(tag_group=self.group_d, name='cherry'),
        ])

    def test_matching_groups(self):
        matching_ids = get_same_tag_groups(self.group_a.id)
        expected_ids = {self.group_a.id, self.group_b.id}

        self.assertSetEqual(set(matching_ids), expected_ids)

    def test_no_match_for_partial(self):
        matching_ids = get_same_tag_groups(self.group_c.id)
        self.assertSetEqual(set(matching_ids), {self.group_c.id})

    def test_no_match_for_extra(self):
        matching_ids = get_same_tag_groups(self.group_d.id)
        self.assertSetEqual(set(matching_ids), {self.group_d.id})
```

------

## âœ… å¦‚ä½•è¿è¡Œæµ‹è¯•

ç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯ PostgreSQLï¼Œå¹¶å·²é…ç½®å¥½ Django æ•°æ®åº“ï¼š

```bash
python manage.py test yourapp
```

------

## âœ… å¯é€‰ï¼šåªæŸ¥å…¶ä»– groupï¼ˆä¸å«è‡ªèº«ï¼‰

å¦‚æœä½ ä¸æƒ³è®©ç»“æœåŒ…å«è‡ªå·±ï¼ˆå³åªæŸ¥â€œå…¶å®ƒç­‰ä»·ç»„â€ï¼‰ï¼Œåœ¨ `filter` ååŠ ä¸Šï¼š

```python
.exclude(id=group_id)
```

------

éœ€è¦æˆ‘ç»™ä½ è¿™ä¸ªæµ‹è¯•åœºæ™¯çš„è¿ç§»è„šæœ¬ã€`pytest` ç‰ˆæœ¬æˆ–æ›´å¤§è§„æ¨¡å‹åŠ›æµ‹è¯•è„šæœ¬å—ï¼Ÿ

ä½ çš„å½“å‰å®ç°å·²ç»æ˜¯ **çº¯ ORM + é«˜æ•ˆå†…å­˜é›†åˆå¯¹æ¯”**ï¼Œé€‚åˆä¸­ç­‰è§„æ¨¡ï¼ˆä¸Šä¸‡ï¼‰æ•°æ®ä½¿ç”¨ã€‚ä½†å¦‚æœä½ å¸Œæœ›è¿›ä¸€æ­¥**ä¼˜åŒ–æ€§èƒ½**ã€**å‡å°‘æ•°æ®åº“æ‰«æé‡æˆ–å†…å­˜æ¶ˆè€—**ï¼Œå¯ä»¥è€ƒè™‘å¦‚ä¸‹å‡ ä¸ªæ–¹å‘ã€‚

------

## âœ… å½“å‰ä¼˜åŒ–ç¨‹åº¦å›é¡¾

ä½ å½“å‰æ–¹æ¡ˆå·²ç»æœ‰ä»¥ä¸‹ä¼˜åŒ–ç‚¹ï¼š

| ä¼˜åŒ–ç‚¹             | æ˜¯å¦å…·å¤‡ | è¯´æ˜                                       |
| ------------------ | -------- | ------------------------------------------ |
| åªåŠ è½½å¿…è¦å­—æ®µ     | âœ…        | `.only('name')` é™å®šå­—æ®µ                   |
| æ‰¹é‡é¢„åŠ è½½         | âœ…        | `prefetch_related(Prefetch(...))` é¿å… N+1 |
| ç»“æ„å¯¹æ¯”ä¼˜åŒ–       | âœ…        | ç”¨ `set()` å‡å°‘æ’åºç­‰é¢å¤–è¿ç®—              |
| æå‰æ’é™¤ä¸ç­‰é•¿é›†åˆ | âœ…        | `len(names) != target_count`               |

------

## ğŸš€ å¯é€‰ä¼˜åŒ–æ–¹å‘ï¼ˆè¿›é˜¶ï¼‰

### 1. âœ… **é™åˆ¶å€™é€‰ç»„èŒƒå›´ï¼ˆç”¨ annotation èšåˆè¿‡æ»¤ï¼‰**

> ä¸ç”¨åŠ è½½æ‰€æœ‰ groupï¼ŒåªåŠ è½½â€œå¯èƒ½åŒ¹é…â€çš„ groupï¼Œæå‰ç”¨æ•°æ®åº“è¿‡æ»¤æ‰æ•°é‡ä¸å¯¹çš„ groupã€‚

ç¤ºä¾‹ï¼š

```python
from django.db.models import Count

# å…ˆè¿‡æ»¤å‡ºæ ‡ç­¾æ•°é‡ç›¸ç­‰çš„ç»„ï¼ˆå‡å°‘ prefetch çš„é‡ï¼‰
groups = TagGroup.objects.annotate(tag_count=Count('details')).filter(tag_count=target_count)
groups = groups.prefetch_related(Prefetch('details', queryset=TagDetail.objects.only('name')))
```

è¿™æ ·ä½ åª prefetch æ•°é‡ç›¸åŒçš„ç»„ï¼Œ**æ˜¾è‘—å‡å°‘å†…å­˜éå†å’Œè¯·æ±‚é‡**ã€‚

------

### 2. âœ… **æ’åº + tuple æ¯”è¾ƒï¼ˆé¿å… set æ„é€ å¼€é”€ï¼‰**

å¦‚æœä½ ä¿è¯æ ‡ç­¾åç§°åœ¨æ¯ç»„å†…å”¯ä¸€ï¼Œ**ä¸”æ•°é‡ä¸å¤§**ï¼Œä½ ä¹Ÿå¯ä»¥å°†æ ‡ç­¾å**æ’åºä¸ºå…ƒç»„**è¿›è¡Œå¯¹æ¯”ï¼ˆåŠ å¿« hash æ¯”è¾ƒï¼‰ï¼š

```python
target_signature = tuple(sorted(target_names))

for group in groups:
    signature = tuple(sorted(d.name for d in group.details.all()))
    if signature == target_signature:
        matched_group_ids.append(group.id)
```

è¿™ç§æ–¹å¼å¯¹æ¯”ä¸¤ä¸ªå…ƒç»„æ¯”å¯¹ä¸¤ä¸ª set æ›´å¿«ï¼Œå°¤å…¶æ˜¯åœ¨æ ‡ç­¾æ•°é‡è¾ƒå°æ—¶ï¼ˆ5-30 ä¸ªä»¥å†…ï¼‰ï¼Œé€Ÿåº¦å¯èƒ½å¿«ä¸€å€å·¦å³ã€‚

------

### 3. âœ… **æå‰ç¼“å­˜ç›®æ ‡ç­¾å**

é¿å…å¤šæ¬¡æ„å»º target æ•°æ®ç»“æ„ï¼Œå°¤å…¶ä½ åç»­å¯èƒ½è¦å¤šæ¬¡ç”¨ï¼š

```python
# å·²æœ‰ï¼štarget_names = set(...)
target_signature = tuple(sorted(target_names))
```

------

### 4. âœ… **å°†ç»“æœæ”¹ä¸º generatorï¼ˆæµå¼éå†ï¼‰**

å¦‚æœä½ ä¸éœ€è¦ä¸€æ¬¡æ€§æ‹¿åˆ°æ‰€æœ‰ IDï¼Œè€Œæ˜¯é€ä¸ªè¿”å›ï¼Œå¯ä»¥å°†å…¶æ”¹ä¸ºç”Ÿæˆå™¨ï¼š

```python
def get_groups_with_same_tag_names(group_id):
    ...
    for group in groups:
        ...
        if names == target_names:
            yield group.id
```

ç„¶åè°ƒç”¨å¤„ä½¿ç”¨ï¼š

```python
for group_id in get_groups_with_same_tag_names(...):
    print(group_id)
```

è¿™æ ·å¯ä»¥èŠ‚çœå¤§é‡å†…å­˜ï¼ˆé€‚ç”¨äºç™¾ä¸‡ç»„ä»¥ä¸Šçš„æå¤§æ•°æ®é‡ï¼‰ã€‚

------

### 5. âŒ ä¸æ¨èçš„ä¼˜åŒ–ï¼šhash è¿›æ•°æ®åº“

ä½ å¯èƒ½ä¼šè€ƒè™‘ç»™æ¯ä¸ª TagGroup çš„æ ‡ç­¾åé›†åˆåŠ ä¸Š hashï¼ˆå¦‚ `md5(sorted(tag_names))`ï¼‰æ¥åŠ é€Ÿè¿‡æ»¤ï¼Œä½†è¿™å±äºï¼š

- å†™æ—¶å¢åŠ é¢å¤–ç»´æŠ¤è´Ÿæ‹…ï¼›
- æ ‡ç­¾å˜æ›´æ—¶åŒæ­¥ç»´æŠ¤å¤æ‚ï¼›
- ä¸å¦‚çº¯ Python å¤„ç†çµæ´»ã€‚

ä»…åœ¨è¶…å¤§è§„æ¨¡æ•°æ®ï¼ˆåƒä¸‡ä»¥ä¸Šï¼‰éœ€è¦è€ƒè™‘ã€‚

------

## âœ… æ¨èæœ€ç»ˆä¼˜åŒ–ç‰ˆï¼ˆç»„åˆ Count + Prefetchï¼‰

```python
from django.db.models import Count, Prefetch
from .models import TagGroup, TagDetail

def get_groups_with_same_tag_names(group_id):
    target_names = set(
        TagDetail.objects.filter(tag_group_id=group_id).values_list('name', flat=True)
    )
    target_count = len(target_names)
    target_signature = tuple(sorted(target_names))

    groups = TagGroup.objects.annotate(tag_count=Count('details')).filter(tag_count=target_count)
    groups = groups.prefetch_related(
        Prefetch('details', queryset=TagDetail.objects.only('name'))
    )

    matched_group_ids = []

    for group in groups:
        signature = tuple(sorted(d.name for d in group.details.all()))
        if signature == target_signature:
            matched_group_ids.append(group.id)

    return matched_group_ids
```

------

å¦‚ä½ å¸Œæœ›æŠŠè¿™å°è£…ä¸ºå¯é“¾å¼ä½¿ç”¨çš„ ORM æ–¹æ³•ï¼ˆå¦‚ `.with_same_tag_names_as(group_id)`ï¼‰ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ åšè‡ªå®šä¹‰ `QuerySet`ã€‚

æ˜¯å¦éœ€è¦æˆ‘å¸®ä½ å°è£…ä¸ºæ›´é€šç”¨çš„å·¥å…·ï¼Ÿ

æ˜¯çš„ï¼ä½ ç°åœ¨è¿™æ®µä»£ç å·²ç»æ˜¯**Django ORM ä¸­è¾ƒé«˜æ•ˆçš„å®ç°**ï¼Œä½†å¦‚æœè¦è¿›ä¸€æ­¥åŠ é€Ÿï¼Œæˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢**åšç»“æ„æ€§ä¼˜åŒ–**ï¼Œæœ€å¤§ç¨‹åº¦å‡å°‘æŸ¥è¯¢é‡ã€æé«˜ PostgreSQL æ‰§è¡Œæ•ˆç‡ â€”â€” **ç‰¹åˆ«æ˜¯åœ¨æ•°æ®é›†æ•°é‡å’Œæ ‡ç­¾ç»„éå¸¸åºå¤§çš„æƒ…å†µä¸‹**ã€‚

------

## âœ… ä½ å½“å‰åšå¾—å¾ˆå¥½çš„åœ°æ–¹

- ä½¿ç”¨äº† `Subquery` + `OuterRef` æ‹¿åˆ°æ¯ä¸ªæ•°æ®é›†çš„æœ€æ–°ç‰ˆæœ¬ï¼›
- ç”¨ `ArrayAgg(... ordering=..., distinct=True)` æ„é€ æœ‰åºæ ‡ç­¾é›†åˆï¼›
- é¿å…äº† Python ç«¯å¾ªç¯ï¼Œå…¨éƒ¨é€»è¾‘å°½é‡åœ¨æ•°æ®åº“å®Œæˆã€‚

------

## ğŸš€ ä¼˜åŒ–æ–¹å‘ï¼ˆè¯¦ç»†è¯´æ˜ï¼‰

### âœ… 1. ç”¨ `Exists + Filtered Subquery` æ›¿ä»£ `ArrayAgg` èšåˆæ¯”è¾ƒï¼ˆæ›´å¿«ï¼‰

#### é—®é¢˜ï¼š

ä½ ç°åœ¨ç”¨ `ArrayAgg` ä¼šè®© PostgreSQL åšå­—ç¬¦ä¸²æ•°ç»„æ„é€ å†æ¯”è¾ƒï¼Œ**è¿™æ˜¯å…¸å‹çš„â€œèšåˆ + è¿‡æ»¤æ¯”å¯¹â€**ï¼Œæœ‰ä¸€å®šå¼€é”€ã€‚

#### æ›¿ä»£æ–¹æ¡ˆï¼š

æ”¹ç”¨ `Exists()` + `Group by + Having` æ€è·¯ï¼ˆå³æ¯”å¯¹ tag_group çš„æ ‡ç­¾é›†åˆæ˜¯å¦ç›¸åŒï¼‰ã€‚

ä½†ç”±äºä½ ä¸æƒ³å†™ SQLï¼Œè¿™é‡Œç»™å‡º**å…¼é¡¾ ORM å’Œæ€§èƒ½**çš„å¯è¡Œæ–¹æ¡ˆï¼š

------

### âœ… 2. ä¸ºæ¯ä¸ªæ ‡ç­¾ç»„æ„é€ â€œæ ‡ç­¾ç­¾åâ€ï¼ˆåªè¯»ä¼˜åŒ–ï¼Œä¸å­˜å­—æ®µï¼‰

æˆ‘ä»¬æ„é€ æ¯ä¸ªæ ‡ç­¾ç»„çš„å”¯ä¸€æ ‡è¯†ï¼ˆç­¾åï¼‰ï¼Œä½œä¸º**å¯æ¯”è¾ƒå¯¹è±¡**ï¼Œé¿å… ArrayAggï¼š

```python
# ä¸ºæ¯ä¸ª TagGroup æ„é€ ç­¾å â€”â€” æ’åºæ ‡ç­¾åå†è¿æ¥
def get_tag_signature(tag_group_id):
    return ','.join(
        TagDetail.objects
        .filter(tag_group_id=tag_group_id)
        .order_by('name')
        .values_list('name', flat=True)
    )
```

> æ ‡ç­¾é›†åˆ `{x, y, z}` ä¸ `{z, x, y}` ç”Ÿæˆçš„ç­¾åä¸€æ · â‡’ å¯ç›´æ¥å­—ç¬¦ä¸²å¯¹æ¯”ï¼

------

### âœ… 3. æŸ¥è¯¢é˜¶æ®µé¿å…èšåˆï¼Œå¯¹æ¯”ç­¾åï¼ˆå­—ç¬¦ä¸²æ¯”è¾ƒå¿«äºæ•°ç»„ï¼‰

æ›¿æ¢åŸ `ArrayAgg` ä¸ºæå‰æ„é€ ç­¾åçš„æ–¹å¼ï¼š

```python
from django.db.models import Subquery, OuterRef
from yourapp.models import Dataset, DatasetVersion, TagDetail

def get_datasets_with_same_latest_tag_signature(dataset_id):
    # Step 1: è·å–ç›®æ ‡æ ‡ç­¾ç»„ ID
    latest_tag_group_id = (
        DatasetVersion.objects
        .filter(dataset_id=dataset_id)
        .order_by('-version')
        .values_list('tag_group_id', flat=True)
        .first()
    )

    if not latest_tag_group_id:
        return []

    # Step 2: è·å–ç›®æ ‡ç­¾å
    target_signature = get_tag_signature(latest_tag_group_id)

    if not target_signature:
        return []

    # Step 3: æ‰¾å‡ºæ¯ä¸ªæ•°æ®é›†çš„æœ€æ–°ç‰ˆæœ¬ tag_group
    latest_tag_group_subquery = Subquery(
        DatasetVersion.objects
        .filter(dataset=OuterRef('pk'))
        .order_by('-version')
        .values('tag_group_id')[:1]
    )

    # Step 4: æ¯”å¯¹æ ‡ç­¾ç­¾åï¼ˆåœ¨ Python ä¾§ä¸€æ¬¡æ€§æ‹‰å– tag_group_ids å¹¶æ˜ å°„ç­¾åï¼‰
    # æ›´é€‚åˆä¸­ç­‰è§„æ¨¡ï¼šå‡ åƒç»„æ—¶æ€§èƒ½ä¼˜äºæ•°æ®åº“ç«¯èšåˆ

    from django.db.models import F

    datasets = (
        Dataset.objects
        .annotate(latest_tag_group_id=latest_tag_group_subquery)
        .values('id', 'latest_tag_group_id')
    )

    # æ‰¹é‡å–æ‰€æœ‰ group_id çš„ç­¾åï¼ˆé¿å…å¾ªç¯è°ƒç”¨ get_tag_signatureï¼‰
    from collections import defaultdict
    tag_group_ids = {d['latest_tag_group_id'] for d in datasets if d['latest_tag_group_id']}
    group_signature_map = {
        group_id: get_tag_signature(group_id)
        for group_id in tag_group_ids
    }

    matching_ids = [
        d['id']
        for d in datasets
        if group_signature_map.get(d['latest_tag_group_id']) == target_signature
    ]

    return matching_ids
```

------

### âœ… æ€§èƒ½ä¼˜åŠ¿è¯´æ˜ï¼š

| æ–¹æ³•                 | ä¼˜ç‚¹                   | é€‚ç”¨åœºæ™¯                                      |
| -------------------- | ---------------------- | --------------------------------------------- |
| åŸå§‹ ArrayAgg        | å…¨ ORMï¼Œæ— æ‰‹åŠ¨ç­¾åé€»è¾‘ | æ•°æ®é›†è¾ƒå°‘ï¼ˆ<1000ï¼‰æ—¶è¶³å¤Ÿå¿«                   |
| ç­¾åæ˜ å°„æ³•ï¼ˆæ¨èï¼‰   | æå¿«ï¼Œæ— èšåˆï¼Œé¿å…é‡ç®— | æ•°æ®é›†æˆåƒä¸Šä¸‡æ—¶æ€§èƒ½æ›´ä¼˜ï¼Œé¿å…å¤§å­—æ®µèšåˆ      |
| é¢„è®¡ç®—å­—æ®µï¼ˆä¸‹ä¸€æ­¥ï¼‰ | æŸ¥è¯¢æœ€å¿«ï¼Œä»…å­—ç¬¦ä¸²åŒ¹é… | æ•°æ®ä¸é¢‘ç¹å˜æ›´ï¼Œå¯å­˜ `signature` å­—æ®µå¹¶åŠ ç´¢å¼• |

------

## âœ… Bonusï¼ˆé¢å¤–æè‡´ä¼˜åŒ–ï¼‰

å¦‚ä½ å…è®¸ä¸º `TagGroup` æ·»åŠ åªè¯»å­—æ®µï¼Œå¯åœ¨ `TagGroup` ä¸­æ·»åŠ ä¸€ä¸ª `signature` å­—æ®µï¼Œç”¨äºç»´æŠ¤æ ‡ç­¾é›†åˆå“ˆå¸Œï¼š

```python
class TagGroup(models.Model):
    ...
    signature = models.CharField(max_length=500, db_index=True)  # å¯è‡ªåŠ¨æ›´æ–°
```

å¹¶ä½¿ç”¨ `post_save` ä¿¡å·æˆ– save() å†…éƒ¨æ›´æ–°ã€‚

æŸ¥è¯¢ç›´æ¥å˜æˆï¼š

```python
Dataset.objects.filter(latest_version__tag_group__signature=target_signature)
```

è¿™ä¸ªæ–¹æ³•æœ€å¿«ï¼Œé€‚åˆè¯»å¤šå†™å°‘åœºæ™¯ã€‚

------

## âœ… å°ç»“

| æ–¹æ¡ˆ                           | é€Ÿåº¦   | Django åŸç”Ÿ | é€‚ç”¨åœºæ™¯     |
| ------------------------------ | ------ | ----------- | ------------ |
| `ArrayAgg` + ORMï¼ˆä½ å½“å‰ä½¿ç”¨ï¼‰ | ğŸŸ¡ ä¸­   | âœ… æ˜¯        | ä¸­ç­‰æ•°æ®é›†   |
| ğŸ†• TagGroup ç­¾åå¯¹æ¯”ï¼ˆæ¨èï¼‰    | ğŸŸ¢ å¿«   | âœ… æ˜¯        | å¤§æ•°æ®é›†     |
| æ·»åŠ å­—æ®µ `signature`           | ğŸŸ¢ æœ€å¿« | âœ… æ˜¯        | å†™å°‘è¯»å¤šåœºæ™¯ |

------

å¦‚æœä½ å¸Œæœ›æˆ‘å¸®ä½ å°è£…ç¬¬ 2 ä¸ªæ–¹æ¡ˆä¸ºå¯å¤ç”¨å‡½æ•°/ç®¡ç†å™¨ï¼Œæˆ–ç»™å‡ºä¸€ä¸ª benchmark æµ‹è¯•å·¥å…·ï¼ˆå¯¹æ¯”è€—æ—¶ï¼‰ï¼Œæˆ‘å¯ä»¥ç»§ç»­æä¾›ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ

```python
# utils/tag_matching.py
import time

from django.contrib.postgres.aggregates import ArrayAgg
from django.db.models import Subquery, OuterRef, Q
from .models import Dataset, DatasetVersion, TagDetail

def build_tag_group_signature(tag_group_id):
    """æ„é€ æ ‡ç­¾ç»„çš„ç­¾åï¼ˆæŒ‰ name æ’åºè¿æ¥ï¼‰"""
    return ','.join(
        TagDetail.objects
        .filter(tag_group_id=tag_group_id)
        .order_by('name')
        .values_list('name', flat=True)
    )

def get_datasets_with_same_latest_tag_signature(dataset_id):
    """
    è¿”å›æ‰€æœ‰å…¶æœ€æ–°ç‰ˆæœ¬çš„æ ‡ç­¾é›†åˆä¸ç»™å®š dataset æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾é›†åˆå®Œå…¨ä¸€è‡´çš„ Dataset ID åˆ—è¡¨ã€‚
    ä¸ä½¿ç”¨ ArrayAggï¼Œä½¿ç”¨æ ‡ç­¾ç­¾åå­—ç¬¦ä¸²æ¯”è¾ƒã€‚
    """
    latest_tag_group_id = (
        DatasetVersion.objects
        .filter(dataset_id=dataset_id)
        .order_by('-version')
        .values_list('tag_group_id', flat=True)
        .first()
    )

    if not latest_tag_group_id:
        return []

    target_signature = build_tag_group_signature(latest_tag_group_id)
    if not target_signature:
        return []

    latest_tag_group_subquery = Subquery(
        DatasetVersion.objects
        .filter(dataset=OuterRef('pk'))
        .order_by('-version')
        .values('tag_group_id')[:1]
    )

    annotated_datasets = Dataset.objects.annotate(latest_tag_group_id=latest_tag_group_subquery)

    group_ids = set(
        annotated_datasets
        .values_list('latest_tag_group_id', flat=True)
    )
    group_signatures = {
        gid: build_tag_group_signature(gid)
        for gid in group_ids if gid
    }

    matched_ids = [
        ds.id for ds in annotated_datasets
        if group_signatures.get(ds.latest_tag_group_id) == target_signature
    ]

    return matched_ids

def benchmark_tag_matching(dataset_id):
    """å¯¹æ¯” ArrayAgg æ–¹æ¡ˆä¸æ ‡ç­¾ç­¾åæ–¹æ¡ˆçš„æ€§èƒ½"""
    def match_with_arrayagg():
        latest_tag_group_id = (
            DatasetVersion.objects
            .filter(dataset_id=dataset_id)
            .order_by('-version')
            .values_list('tag_group_id', flat=True)
            .first()
        )

        if not latest_tag_group_id:
            return []

        target_tags = list(
            TagDetail.objects
            .filter(tag_group_id=latest_tag_group_id)
            .order_by('name')
            .values_list('name', flat=True)
        )

        if not target_tags:
            return []

        latest_subquery = Subquery(
            DatasetVersion.objects
            .filter(dataset=OuterRef('pk'))
            .order_by('-version')
            .values('tag_group_id')[:1]
        )

        result = Dataset.objects.annotate(
            latest_tag_group_id=latest_subquery
        ).annotate(
            latest_tag_names=ArrayAgg(
                'versions__tag_group__details__name',
                filter=Q(versions__tag_group_id=OuterRef('latest_tag_group_id')),
                ordering='versions__tag_group__details__name',
                distinct=True
            )
        ).filter(latest_tag_names=target_tags).values_list('id', flat=True)

        return list(result)

    print("Benchmarking: Dataset ID =", dataset_id)

    start = time.time()
    result1 = get_datasets_with_same_latest_tag_signature(dataset_id)
    end = time.time()
    print(f"Signature Match Time: {end - start:.4f}s, Matches: {len(result1)}")

    start = time.time()
    result2 = match_with_arrayagg()
    end = time.time()
    print(f"ArrayAgg Match Time: {end - start:.4f}s, Matches: {len(result2)}")

    if set(result1) == set(result2):
        print("âœ… Results match")
    else:
        print("âŒ Results differ")

```

