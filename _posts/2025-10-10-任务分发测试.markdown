---
layout:     post
title:      "ä»»åŠ¡åˆ†å‘æµ‹è¯•"
subtitle:   ""
date:       2025-10-10
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - celery
---

ğŸ‘Œæ˜ç™½äº†ï¼Œä½ çš„æ„æ€æ˜¯ï¼š

- **ä½ å·²ç»å†™å¥½ `delay_on_commit`**ï¼ˆç»™å•ä¸ª task ç”¨çš„ï¼Œä¸éœ€è¦æˆ‘é‡å†™ï¼‰ã€‚
- çˆ¶ä»»åŠ¡é‡Œé¢åªè¦åˆç†åœ° **å¾ªç¯è°ƒç”¨ä½ çš„ `delay_on_commit`**ï¼Œå°±èƒ½å®Œæˆã€Œä¸€æ‰¹ä¸€æ‰¹å‘é€å­ä»»åŠ¡ã€+ã€Œè®°å½•å­ä»»åŠ¡ä¿¡æ¯ã€+ã€Œåœ¨åˆé€‚çš„æ—¶æœºæ”¶é›†ç»“æœã€çš„é€»è¾‘ã€‚

------

### åœ¨çˆ¶ä»»åŠ¡é‡Œå¸¸è§çš„ä¸¤ç§â€œèŠ‚å¥â€

#### 1. ä¸€ä¸ªä¸€ä¸ªå‘ï¼ˆé€ä¸ª delay_on_commitï¼‰

```python
@app.task
def parent_task():
    results = []
    for item in get_items():
        # ä½¿ç”¨ä½ ç°æœ‰çš„ delay_on_commit
        r = subtask.delay_on_commit(item.id)
        results.append(r)

    # åœ¨äº‹åŠ¡æäº¤åï¼Œresults é‡Œä¼šæœ‰ AsyncResult
    transaction.on_commit(lambda: record_results(results))
```

è¿™é‡Œ `record_results(results)` å°±æ˜¯ä½ è‡ªå·±çš„é€»è¾‘ï¼Œå¯èƒ½æ˜¯ï¼š

```python
def record_results(results):
    for r in results:
        MyTaskLog.objects.create(task_id=r.id, ...)
```

------

#### 2. ä¸€æ‰¹ä¸€æ‰¹å‘ï¼ˆç±»ä¼¼ groupï¼Œä½†ä¸ç”¨ groupï¼‰

```python
@app.task
def parent_task():
    batch = []
    results = []

    for item in get_items():
        batch.append(subtask.s(item.id))
        if len(batch) >= 10:   # æ¯”å¦‚æ¯ 10 ä¸ªå­ä»»åŠ¡ä¸€æ‰¹
            for sig in batch:
                results.append(sig.delay_on_commit())  # ç”¨ä½ ç°æœ‰çš„ API
            batch = []

    # æœ€åä¸€æ‰¹
    for sig in batch:
        results.append(sig.delay_on_commit())

    # äº‹åŠ¡æäº¤åå†ç»Ÿä¸€å¤„ç†
    transaction.on_commit(lambda: record_results(results))
```

è¿™æ ·ï¼Œä½ å°±èƒ½æ§åˆ¶ **å‘é€èŠ‚å¥**ï¼ˆä¸€æ¬¡ 1 ä¸ª / 10 ä¸ª / N ä¸ªï¼‰ï¼Œè€Œä¸”å­ä»»åŠ¡ä»ç„¶é€šè¿‡ä½ å†™å¥½çš„ `delay_on_commit` å‘å‡ºã€‚

------

### ç»“æœæ”¶é›†

å‘é€åä½ é€šå¸¸è¦ã€Œç­‰å­ä»»åŠ¡è·‘å®Œå†æ”¶é›†ç»“æœã€ï¼š

```python
def collect_results(results):
    # results æ˜¯ AsyncResult çš„åˆ—è¡¨
    values = [r.get() for r in results]  # ä¼šé˜»å¡ç›´åˆ°å­ä»»åŠ¡éƒ½å®Œæˆ
    return values
```

åœ¨çˆ¶ä»»åŠ¡é‡Œç”¨ï¼š

```python
transaction.on_commit(lambda: collect_results(results))
```

å¦‚æœä½ ä¸æƒ³é˜»å¡ï¼Œå¯ä»¥åªè®°å½• `task_id` åˆ°æ•°æ®åº“ï¼Œåé¢å•ç‹¬ç”¨ `AsyncResult(task_id)` å»æ”¶ã€‚

------

âœ… ç»“è®ºï¼š
 ä½ å®Œå…¨å¯ä»¥åœ¨çˆ¶ä»»åŠ¡é‡Œ **ç›´æ¥è°ƒç”¨ä½ å†™å¥½çš„ `delay_on_commit`**ï¼Œ

- å•ä¸ªå¾ªç¯å°±æ˜¯é€ä¸ªå‘ï¼Œ
- æ‰¹é‡å¾ªç¯å°±æ˜¯ä¸€æ¬¡å‘å¤šä¸ªï¼Œ
- æƒ³æ”¶ç»“æœå°±ç”¨ `AsyncResult.get()`ï¼Œ
- æƒ³åªè¿½è¸ªå°±å­˜ `task_id`ã€‚

------

å•Šï¼Œç†è§£äº† ğŸ‘

ä½ ç°åœ¨çš„éœ€æ±‚æ˜¯ **æ‰¹å¤„ç† + ä¸²è¡ŒèŠ‚å¥æ§åˆ¶**ï¼š

- çˆ¶ä»»åŠ¡é‡Œåˆ†æ‰¹å‘é€å­ä»»åŠ¡ã€‚
- æ¯ä¸€æ‰¹å­ä»»åŠ¡å¿…é¡»ç­‰å…¨éƒ¨å®Œæˆ â†’ æ”¶é›†ç»“æœ â†’ è®°å½•æ•°æ®åº“ã€‚
- ç„¶åå†ç»§ç»­ä¸‹ä¸€æ‰¹ï¼Œé¿å…ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰å­ä»»åŠ¡ä¸¢ç»™ worker æŠŠ worker å µæ­»ã€‚

è¿™å…¶å®æ˜¯ã€Œåˆ†æ‰¹ group + ç­‰å¾…ã€çš„æ¨¡å¼ï¼Œç”¨ä½ ç°æœ‰çš„ `delay_on_commit` ä¹Ÿèƒ½åšåˆ°ã€‚

------

### ç¤ºä¾‹å®ç°

```python
from celery import group
from django.db import transaction
from myapp.models import MyTaskLog


@app.task
def parent_task(items, batch_size=10):
    """
    items: å­ä»»åŠ¡çš„å‚æ•°åˆ—è¡¨
    batch_size: æ¯æ‰¹å¤„ç†å¤šå°‘ä¸ªå­ä»»åŠ¡
    """

    results = []

    # åˆ†æ‰¹
    for i in range(0, len(items), batch_size):
        batch_items = items[i:i+batch_size]

        batch_results = []
        for item in batch_items:
            # ç”¨ä½ è‡ªå·±å†™å¥½çš„ delay_on_commit
            r = subtask.delay_on_commit(item)
            batch_results.append(r)

        def after_commit(batch_results=batch_results):
            # ç­‰äº‹åŠ¡æäº¤åæ‰èƒ½çœŸæ­£å‘å­ä»»åŠ¡
            # è¿™é‡Œå¯ä»¥é˜»å¡ç­‰å¾…å­ä»»åŠ¡å®Œæˆ
            values = [r.get() for r in batch_results]   # ç­‰è¿™ä¸€æ‰¹éƒ½è·‘å®Œ
            for v in values:
                MyTaskLog.objects.create(result=v)      # è®°å½•ç»“æœ

        # åœ¨äº‹åŠ¡æäº¤åæ‰§è¡Œæ‰¹æ¬¡
        transaction.on_commit(after_commit)

        # æ³¨æ„ï¼šè¿™é‡Œ transaction.on_commit çš„å›è°ƒæ˜¯åœ¨å½“å‰äº‹åŠ¡æäº¤æ—¶æ‰§è¡Œ
        # å¦‚æœ parent_task æœ¬èº«æ²¡æœ‰ç”¨äº‹åŠ¡ï¼Œå¯ä»¥ç›´æ¥åŒæ­¥è°ƒç”¨ after_commit()
        after_commit()

        # è¿™ä¸€æ‰¹å®Œæˆåå†è¿›å…¥ä¸‹ä¸€æ‰¹
        results.extend(batch_results)

    return [r.id for r in results]
```

------

### èŠ‚å¥æ§åˆ¶çš„è¦ç‚¹

1. **æ‰¹æ¬¡å‘é€**
    æ¯æ‰¹ `batch_size` ä¸ªå­ä»»åŠ¡ï¼Œç”¨ `delay_on_commit` å‘å‡ºã€‚
2. **ç­‰å¾…æ‰¹æ¬¡å®Œæˆ**
    ç”¨ `[r.get() for r in batch_results]` ç­‰å¾… worker æŠŠè¿™ä¸€æ‰¹è·‘å®Œã€‚
    è¿™ä¼šé˜»å¡çˆ¶ä»»åŠ¡ï¼Œç›´åˆ°è¿™ä¸€æ‰¹å®Œæˆã€‚
3. **è®°å½•ç»“æœ**
    åœ¨æ‰¹æ¬¡å®Œæˆåï¼Œä¿å­˜ç»“æœï¼ˆæˆ– task_id + çŠ¶æ€ï¼‰åˆ°æ•°æ®åº“ã€‚
4. **ç»§ç»­ä¸‹ä¸€æ‰¹**
    åªæœ‰å½“å‰æ‰¹è·‘å®Œï¼Œæ‰ä¼šå‘ä¸‹ä¸€æ‰¹ï¼Œä¿è¯ worker ä¸ä¼šä¸€æ¬¡æ€§è¢«å æ»¡ã€‚

------

### å¦‚æœçˆ¶ä»»åŠ¡è‡ªå·±ä¸åœ¨äº‹åŠ¡é‡Œ

å¦‚æœ `parent_task` åªæ˜¯æ™®é€š Celery ä»»åŠ¡ï¼Œæ²¡æœ‰äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼Œ`delay_on_commit` å°±ç›¸å½“äºç›´æ¥ `apply_async`ã€‚
 è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç›´æ¥ï¼š

```python
batch_results = [subtask.delay_on_commit(item) for item in batch_items]
values = [r.get() for r in batch_results]
```

å°±èƒ½åšåˆ° **ä¸€æ‰¹ä¸€æ‰¹è·‘ + ç­‰ç»“æœ**ã€‚

