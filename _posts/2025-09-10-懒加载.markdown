---
layout:     post
title:      "æ‡’åŠ è½½"
subtitle:   ""
date:       2025-09-10
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - python
---

ğŸ‘Œ æ˜ç™½äº†ï¼Œä½ ç°åœ¨çš„æƒ…å†µæ˜¯ï¼š

- åœ¨ `permission_class` é‡Œï¼Œä½ éœ€è¦è°ƒç”¨ `get_data(model, only=..., defer=...)`ï¼Œè¿™äº›å‚æ•°æ˜¯åŠ¨æ€çš„ï¼ˆå‡½æ•°ä¼ å‚ï¼‰ã€‚
- ä½†ä½ çš„ç±»é‡Œæœ¬èº«ä¹Ÿæœ‰å±æ€§ `only`ï¼ˆæˆ–è€…å…¶ä»–å‚æ•°åï¼‰ï¼Œå®ƒæ˜¯ç»™åˆ«çš„åœ°æ–¹ç”¨çš„ï¼Œä¸æ˜¯ç»™ `get_data` çš„ã€‚
- ä½ æ‹…å¿ƒåå­—å†²çªï¼Œæˆ–è€…æƒ³åŒºåˆ†æ¸…æ¥šï¼š**ç±»å±æ€§é‡Œçš„ only â‰  get_data é‡Œçš„ only**ã€‚

------

### âœ… æ ¸å¿ƒæ€è·¯

æŠŠ **æƒé™ç±»é…ç½®ç”¨çš„å‚æ•°** å’Œ **ä¸šåŠ¡é€»è¾‘ç”¨çš„å‚æ•°** åˆ†å¼€å­˜å‚¨ï¼Œä¸è¦æ··æ·†ã€‚
 å¸¸è§æ–¹å¼æœ‰å‡ ç§ï¼š

------

### æ–¹æ¡ˆ 1ï¼šæ˜ç¡®åŒºåˆ†ã€Œæ•°æ®åŠ è½½å‚æ•°ã€ä¸ã€Œå…¶ä»–å±æ€§ã€

ç»™ `get_data` ç”¨çš„å‚æ•°ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ª dict é‡Œï¼Œæ¯”å¦‚ `data_options`ï¼š

```python
class LazyPermission(BasePermission):
    model = None
    data_options = {}   # ä¸“é—¨ç»™ get_data ç”¨
    _a = None

    @classmethod
    def get_a(cls):
        if cls._a is None:
            cls._a = get_data(cls.model, **cls.data_options)
        return cls._a

    def has_permission(self, request, view):
        data = self.get_a()
        return True
```

ç„¶åå­ç±»è¿™æ ·å†™ï¼š

```python
class PermissionA(LazyPermission):
    model = "modelA"
    data_options = {"only": ["field1", "field2"], "defer": ["big_field"]}

    # è¿™ä¸ª only å°±ä¸ä¼šå½±å“ get_data
    only = "è¿™æ˜¯ç»™åˆ«çš„åœ°æ–¹ç”¨çš„"
```

è¿™æ ·ï¼Œ`data_options["only"]` åªä½œç”¨åœ¨ `get_data`ï¼Œä¸ä¼šå’Œç±»å±æ€§çš„ `only` æ··æ·†ã€‚

------

### æ–¹æ¡ˆ 2ï¼šç”¨ `get_data_params()` æ–¹æ³•ï¼ˆæ›´çµæ´»ï¼‰

è®©å­ç±»é€šè¿‡æ–¹æ³•æ¥å†³å®šå¦‚ä½•ç»™ `get_data` ä¼ å‚ï¼š

```python
class LazyPermission(BasePermission):
    model = None
    _a = None

    @classmethod
    def get_data_params(cls):
        """å­ç±»å¯é‡å†™ï¼Œè¿”å›ä¼ ç»™ get_data çš„å‚æ•°"""
        return {}

    @classmethod
    def get_a(cls):
        if cls._a is None:
            cls._a = get_data(cls.model, **cls.get_data_params())
        return cls._a

    def has_permission(self, request, view):
        data = self.get_a()
        return True
```

å­ç±»å°±èƒ½çµæ´»æ§åˆ¶ï¼š

```python
class PermissionA(LazyPermission):
    model = "modelA"
    only = "åˆ«çš„åœ°æ–¹ç”¨"

    @classmethod
    def get_data_params(cls):
        return {"only": ["field1"], "defer": ["big_field"]}
```

------

### æ–¹æ¡ˆ 3ï¼šé¿å…åå­—å†²çªï¼ˆå‘½åç©ºé—´ï¼‰

å¦‚æœä½ éè¦ç›´æ¥åœ¨ç±»å±æ€§é‡Œå†™ `only` å’Œ `defer`ï¼Œé‚£å°±ç”¨å‰ç¼€åŒºåˆ†ï¼Œæ¯”å¦‚ï¼š

```python
class PermissionA(LazyPermission):
    model = "modelA"
    data_only = ["field1"]
    data_defer = ["big_field"]
    only = "åˆ«çš„åœ°æ–¹ç”¨"

    @classmethod
    def get_data_params(cls):
        return {"only": cls.data_only, "defer": cls.data_defer}
```

------

ğŸ“Œ æ€»ç»“ï¼š
 å¦‚æœä½ è¦æ”¯æŒå¾ˆå¤šå‚æ•°ï¼Œ**æ–¹æ¡ˆ 1ï¼ˆdict å‚æ•°ï¼‰**æœ€ç®€å•ï¼Œ
 å¦‚æœå‚æ•°æ˜¯åŠ¨æ€é€»è¾‘ï¼Œ**æ–¹æ¡ˆ 2ï¼ˆget_data_params æ–¹æ³•ï¼‰**æœ€æ¸…æ™°ï¼Œ
 å¦‚æœä½ ä¸æƒ³æ”¹å¤ªå¤šä»£ç ï¼Œ**æ–¹æ¡ˆ 3ï¼ˆå‰ç¼€åŒºåˆ†ï¼‰**æœ€ç›´æ¥ã€‚

------

å¥½å˜ âœ…ï¼Œæˆ‘å¸®ä½ æ•´ç†ä¸€ä¸ª **æœ€ç»ˆç‰ˆ `LazyPermission` åŸºç±»**ï¼Œä¸“é—¨ä¸º DRF çš„ `permission_classes` ä½¿ç”¨ï¼Œæ”¯æŒï¼š

1. **æ‡’åŠ è½½**ï¼šåªæœ‰ç¬¬ä¸€æ¬¡çœŸæ­£æ ¡éªŒæƒé™æ—¶æ‰ä¼šåŠ è½½æ•°æ®ã€‚
2. **å‚æ•°éš”ç¦»**ï¼šå­ç±»é‡Œå¯ä»¥åŒæ—¶æœ‰ `only` / `defer` ç­‰æ™®é€šå±æ€§ï¼Œä¸ä¼šå’Œ `get_data` çš„å‚æ•°å†²çªã€‚
3. **é€šç”¨æ€§**ï¼šå­ç±»åªéœ€è®¾ç½® `model` å’Œ `data_options`ï¼Œå°±èƒ½ä½¿ç”¨ã€‚

------

### ğŸ”‘ åŸºç±»å®ç°

```python
from rest_framework.permissions import BasePermission

def get_data(model, only=None, defer=None):
    """æ¨¡æ‹Ÿæ•°æ®åº“å–æ•°"""
    print(f"åŠ è½½ {model} æ•°æ®, only={only}, defer={defer}")
    return {"model": model, "only": only, "defer": defer}


class LazyPermission(BasePermission):
    """
    é€šç”¨æ‡’åŠ è½½ Permission åŸºç±»
    - å­ç±»è®¾ç½® model (å¿…å¡«)
    - å­ç±»è®¾ç½® data_options (å¯é€‰, dictï¼Œä¼ ç»™ get_data)
    - ç±»çº§åˆ«ç¼“å­˜æ•°æ® (åªåŠ è½½ä¸€æ¬¡)
    """
    model = None
    data_options = {}   # ç»™ get_data ç”¨çš„å‚æ•°
    _data_cache = None  # ç¼“å­˜ï¼Œé¿å…é‡å¤åŠ è½½

    @classmethod
    def get_data(cls):
        """æ‡’åŠ è½½æ•°æ®ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼‰"""
        if cls._data_cache is None:
            cls._data_cache = get_data(cls.model, **cls.data_options)
        return cls._data_cache

    def has_permission(self, request, view):
        """
        DRF çš„æƒé™æ£€æŸ¥æ¥å£
        - é»˜è®¤è¿”å› Trueï¼Œå¯åœ¨å­ç±»é‡Œé‡å†™é€»è¾‘
        """
        data = self.get_data()
        # TODO: æ ¹æ® data æ ¡éªŒ request / view
        return True
```

------

### ğŸ”‘ å­ç±»ä½¿ç”¨ç¤ºä¾‹

```python
class PermissionA(LazyPermission):
    model = "ModelA"
    data_options = {"only": ["id", "name"], "defer": ["big_field"]}

    # ä¸šåŠ¡ç”¨çš„å…¶ä»–å±æ€§ï¼Œä¸ä¼šå¹²æ‰° get_data
    only = "è¿™æ˜¯ç»™åˆ«çš„åœ°æ–¹ç”¨çš„"

    def has_permission(self, request, view):
        data = self.get_data()
        print("PermissionA æ­£åœ¨ä½¿ç”¨æ•°æ®:", data)
        return True


class PermissionB(LazyPermission):
    model = "ModelB"
    data_options = {"only": ["email"], "defer": []}

    # å…¶ä»–é€»è¾‘
    custom_flag = True
```

------

### ğŸ”‘ ç”¨æ³•

```python
# åœ¨ View é‡Œç”¨
from rest_framework.views import APIView

class MyView(APIView):
    permission_classes = [PermissionA, PermissionB]

    def get(self, request):
        return Response({"msg": "ok"})
```

- é¡¹ç›®å¯åŠ¨æ—¶ä¸ä¼šåŠ è½½ `get_data`ã€‚
- ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œæ‰ä¼šæ‰“å° `åŠ è½½ ModelX æ•°æ®...`ã€‚
- åç»­è¯·æ±‚ç›´æ¥ç”¨ç¼“å­˜ï¼Œä¸ä¼šé‡å¤åŠ è½½ã€‚
- å­ç±»å¯ä»¥åŒæ—¶å®šä¹‰ `only`ã€`custom_flag` ç­‰æ™®é€šå±æ€§ï¼Œä¸å½±å“ `data_options`ã€‚

------

ğŸ‘Œ æ˜ç™½äº†ï¼Œä½ å·²ç»æœ‰ä¸€ä¸ªåŸºç¡€çš„æƒé™ç±»ï¼ˆå‡è®¾å« `BasePermissionX`ï¼‰ï¼Œç°åœ¨æ–°éœ€æ±‚æ˜¯ï¼š

- åªåœ¨å­ç±»é‡Œæ·»åŠ  **æ‡’åŠ è½½ `get_data`** çš„èƒ½åŠ›ï¼›
- ä¸è¦ä¿®æ”¹å·²æœ‰çš„åŸºç±»ï¼›
- ä¿è¯åŸæœ‰å­ç±»ä¸å—å½±å“ï¼Œåªæœ‰æ–°çš„å­ç±»éœ€è¦æ—¶æ‰ç”¨ã€‚

------

### âœ… è§£å†³æ–¹æ¡ˆ

ä½ å¯ä»¥æ–°å»ºä¸€ä¸ª **Mixin ç±»**ï¼Œä¸“é—¨å¤„ç†æ‡’åŠ è½½é€»è¾‘ï¼Œç„¶ååœ¨æ–°çš„æƒé™ç±»é‡Œ **å¤šé‡ç»§æ‰¿**ï¼Œè¿™æ ·ä¸ä¼šç ´åå·²æœ‰çš„åŸºç±»ã€‚

------

### ğŸ”‘ æ‡’åŠ è½½ Mixin

```python
def get_data(model, only=None, defer=None):
    """æ¨¡æ‹Ÿæ•°æ®åº“å–æ•°"""
    print(f"åŠ è½½ {model} æ•°æ®, only={only}, defer={defer}")
    return {"model": model, "only": only, "defer": defer}


class LazyPermissionMixin:
    """
    ç»™æƒé™ç±»å¢åŠ æ‡’åŠ è½½èƒ½åŠ›
    - éœ€è¦å­ç±»å®šä¹‰ model å’Œ data_options
    - é»˜è®¤å¯ç”¨ç±»çº§ç¼“å­˜ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼‰
    """
    model = None
    data_options = {}
    _data_cache = None

    @classmethod
    def get_lazy_data(cls):
        if cls._data_cache is None:
            cls._data_cache = get_data(cls.model, **cls.data_options)
        return cls._data_cache
```

------

### ğŸ”‘ ç»§æ‰¿å·²æœ‰åŸºç±» + Mixin

å‡è®¾ä½ åŸæ¥æœ‰ä¸€ä¸ªåŸºç±»ï¼š

```python
from rest_framework.permissions import BasePermission

class MyBasePermission(BasePermission):
    def has_permission(self, request, view):
        # åŸæœ‰é€»è¾‘
        return True
```

ç°åœ¨ä½ åªéœ€è¦åœ¨æ–°æƒé™ç±»é‡Œç”¨ Mixinï¼š

```python
class PermissionA(LazyPermissionMixin, MyBasePermission):
    model = "ModelA"
    data_options = {"only": ["id", "name"], "defer": ["big_field"]}

    def has_permission(self, request, view):
        data = self.get_lazy_data()  # æ‡’åŠ è½½æ•°æ®
        print("PermissionA ä½¿ç”¨æ•°æ®:", data)
        return super().has_permission(request, view)
```

------

### ğŸ”‘ ç”¨æ³•

```python
class MyView(APIView):
    permission_classes = [PermissionA]  # æ‡’åŠ è½½ç‰ˆæœ¬
```

- æ—§çš„ `MyBasePermission` å’Œå®ƒçš„å­ç±»å®Œå…¨ä¸éœ€è¦ä¿®æ”¹ã€‚
- æ–°çš„æƒé™ç±»åªè¦å¤šç»§æ‰¿ `LazyPermissionMixin` å°±è‡ªåŠ¨æœ‰æ‡’åŠ è½½åŠŸèƒ½ã€‚
- ç¼“å­˜é€»è¾‘åªå½±å“ç”¨äº† `Mixin` çš„å­ç±»ï¼Œä¸ä¼šæ±¡æŸ“å…¨å±€ã€‚

------

å¥½ âœ…ï¼Œæˆ‘å¸®ä½ æŠŠ `LazyPermissionMixin` æ‰©å±•ä¸€ä¸‹ï¼Œæ”¯æŒ **ç¼“å­˜å¼€å…³**ï¼š

- `use_cache = True` â†’ é»˜è®¤æ‡’åŠ è½½å¹¶ç¼“å­˜ï¼ˆç¬¬ä¸€æ¬¡åŠ è½½åå¤ç”¨ï¼‰ã€‚
- `use_cache = False` â†’ æ¯æ¬¡è°ƒç”¨ `get_lazy_data` éƒ½é‡æ–°åŠ è½½ã€‚

è¿™æ ·ä½ åœ¨ä¸åŒçš„æƒé™ç±»é‡Œå¯ä»¥çµæ´»é€‰æ‹©ã€‚

------

### ğŸ”‘ æ”¹é€ åçš„ `LazyPermissionMixin`

```python
def get_data(model, only=None, defer=None):
    """æ¨¡æ‹Ÿæ•°æ®åº“å–æ•°"""
    print(f"åŠ è½½ {model} æ•°æ®, only={only}, defer={defer}")
    return {"model": model, "only": only, "defer": defer}


class LazyPermissionMixin:
    """
    ç»™æƒé™ç±»å¢åŠ æ‡’åŠ è½½èƒ½åŠ›
    - å­ç±»éœ€è¦å®šä¹‰ model å’Œ data_options
    - use_cache æ§åˆ¶æ˜¯å¦å¯ç”¨ç¼“å­˜
    """
    model = None
    data_options = {}
    use_cache = True
    _data_cache = None

    @classmethod
    def get_lazy_data(cls):
        if cls.use_cache:
            if cls._data_cache is None:
                cls._data_cache = get_data(cls.model, **cls.data_options)
            return cls._data_cache
        else:
            # æ¯æ¬¡éƒ½é‡æ–°åŠ è½½
            return get_data(cls.model, **cls.data_options)
```

------

### ğŸ”‘ ç¤ºä¾‹ï¼šç»§æ‰¿å·²æœ‰çš„åŸºç±»

å‡è®¾ä½ åŸæ¥çš„åŸºç±»ï¼š

```python
from rest_framework.permissions import BasePermission

class MyBasePermission(BasePermission):
    def has_permission(self, request, view):
        # åŸæœ‰é€»è¾‘
        return True
```

------

### ğŸ”‘ æ–°çš„æƒé™ç±»ï¼ˆä¸¤ç§ç”¨æ³•ï¼‰

```python
# ä½¿ç”¨ç¼“å­˜ï¼ˆé»˜è®¤ï¼‰
class PermissionA(LazyPermissionMixin, MyBasePermission):
    model = "ModelA"
    data_options = {"only": ["id", "name"], "defer": ["big_field"]}

    def has_permission(self, request, view):
        data = self.get_lazy_data()
        print("PermissionA ä½¿ç”¨æ•°æ®:", data)
        return super().has_permission(request, view)


# ä¸ä½¿ç”¨ç¼“å­˜ï¼ˆæ¯æ¬¡è¯·æ±‚éƒ½åŠ è½½ï¼‰
class PermissionB(LazyPermissionMixin, MyBasePermission):
    model = "ModelB"
    data_options = {"only": ["email"]}
    use_cache = False   # å…³é—­ç¼“å­˜

    def has_permission(self, request, view):
        data = self.get_lazy_data()
        print("PermissionB ä½¿ç”¨æ•°æ®:", data)
        return super().has_permission(request, view)
```

------

### ğŸ”‘ ç”¨æ³•

```python
class MyView(APIView):
    permission_classes = [PermissionA, PermissionB]
```

- å¦‚æœç”¨ `PermissionA`ï¼šç¬¬ä¸€æ¬¡è¯·æ±‚ä¼šæ‰“å°â€œåŠ è½½ ModelA...â€ï¼Œåç»­è¯·æ±‚ç›´æ¥ç”¨ç¼“å­˜ã€‚
- å¦‚æœç”¨ `PermissionB`ï¼šæ¯æ¬¡è¯·æ±‚éƒ½ä¼šæ‰“å°â€œåŠ è½½ ModelB...â€ã€‚

------

ğŸ‘Œ å¥½çš„ï¼Œæˆ‘ä»¬åœ¨ `LazyPermissionMixin` ä¸Šå†åŠ ä¸€ä¸ª **ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰** åŠŸèƒ½ï¼š

- `use_cache = True` æ—¶å¯ç”¨ç¼“å­˜ï¼›
- `cache_ttl`ï¼ˆç§’æ•°ï¼Œé»˜è®¤ `None` è¡¨ç¤ºæ°¸ä¹…ç¼“å­˜ï¼‰ï¼›
- å¦‚æœè¶…è¿‡ TTLï¼Œä¼šè‡ªåŠ¨é‡æ–°åŠ è½½æ•°æ®ã€‚

------

### ğŸ”‘ æ”¹é€ åçš„ `LazyPermissionMixin`

```python
import time

def get_data(model, only=None, defer=None):
    """æ¨¡æ‹Ÿæ•°æ®åº“å–æ•°"""
    print(f"åŠ è½½ {model} æ•°æ®, only={only}, defer={defer}")
    return {"model": model, "only": only, "defer": defer, "loaded_at": time.time()}


class LazyPermissionMixin:
    """
    ç»™æƒé™ç±»å¢åŠ æ‡’åŠ è½½èƒ½åŠ›
    - å­ç±»å®šä¹‰ model å’Œ data_options
    - use_cache æ§åˆ¶æ˜¯å¦å¯ç”¨ç¼“å­˜
    - cache_ttl ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼ŒNone è¡¨ç¤ºä¸è¿‡æœŸ
    """
    model = None
    data_options = {}
    use_cache = True
    cache_ttl = None  # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’

    _data_cache = None
    _cache_time = None

    @classmethod
    def get_lazy_data(cls):
        if not cls.use_cache:
            # æ¯æ¬¡éƒ½é‡æ–°åŠ è½½
            return get_data(cls.model, **cls.data_options)

        now = time.time()
        expired = (
            cls.cache_ttl is not None
            and cls._cache_time is not None
            and now - cls._cache_time > cls.cache_ttl
        )

        if cls._data_cache is None or expired:
            cls._data_cache = get_data(cls.model, **cls.data_options)
            cls._cache_time = now

        return cls._data_cache
```

------

### ğŸ”‘ ç¤ºä¾‹

```python
from rest_framework.permissions import BasePermission

class MyBasePermission(BasePermission):
    def has_permission(self, request, view):
        return True


# ä½¿ç”¨æ°¸ä¹…ç¼“å­˜
class PermissionA(LazyPermissionMixin, MyBasePermission):
    model = "ModelA"
    data_options = {"only": ["id", "name"]}
    use_cache = True
    cache_ttl = None  # æ°¸ä¹…ç¼“å­˜


# ä½¿ç”¨ç¼“å­˜ + 30 ç§’è¿‡æœŸ
class PermissionB(LazyPermissionMixin, MyBasePermission):
    model = "ModelB"
    data_options = {"only": ["email"]}
    use_cache = True
    cache_ttl = 30  # 30 ç§’è¿‡æœŸ


# ä¸ä½¿ç”¨ç¼“å­˜
class PermissionC(LazyPermissionMixin, MyBasePermission):
    model = "ModelC"
    data_options = {"defer": ["large_field"]}
    use_cache = False
```

------

### ğŸ”‘ è¡Œä¸º

- **PermissionA**
   ç¬¬ä¸€æ¬¡è¯·æ±‚åŠ è½½ä¸€æ¬¡ï¼Œä»¥åæ°¸è¿œç”¨ç¼“å­˜ã€‚
- **PermissionB**
   ç¬¬ä¸€æ¬¡è¯·æ±‚åŠ è½½ï¼Œ30 ç§’å†…çš„è¯·æ±‚ç›´æ¥ç”¨ç¼“å­˜ï¼›
   è¶…è¿‡ 30 ç§’åå†æ¬¡è¯·æ±‚ä¼šé‡æ–°åŠ è½½ã€‚
- **PermissionC**
   æ¯æ¬¡è¯·æ±‚éƒ½ä¼šé‡æ–°åŠ è½½ã€‚

------

