---
layout:     post
title:      "ä¸­æ–‡é”™è¯¯è¿”å›"
subtitle:   ""
date:       2025-08-28
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - python
---

æ˜ç™½ï¼Œä½ æ˜¯æƒ³æŠŠ **Django æˆ– Python æŠ¥é”™ä¿¡æ¯çš„è‹±æ–‡**ç¿»è¯‘æˆ **ä¸­æ–‡æç¤º**ï¼Œå¯¹å—ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ åšåˆ°å‡ ä¸ªå±‚æ¬¡ï¼š

1. **æ‰‹åŠ¨ç¿»è¯‘å•æ¡é”™è¯¯**ï¼šä½ æŠŠæŠ¥é”™è´´ç»™æˆ‘ï¼Œæˆ‘å¸®ä½ é€å¥ç¿»è¯‘æˆä¸­æ–‡ï¼Œå¹¶è§£é‡Šå«ä¹‰ã€‚
2. **ç»Ÿä¸€æ˜ å°„å­—å…¸**ï¼šæŠŠå¸¸è§çš„ Django æˆ– Python é”™è¯¯ç±»å‹ï¼ˆ`ValueError`, `IntegrityError`, `DoesNotExist`, `PermissionDenied` ç­‰ï¼‰å»ºç«‹æ˜ å°„ï¼Œæ–¹ä¾¿åœ¨é¡¹ç›®é‡Œç»Ÿä¸€æ˜¾ç¤ºä¸­æ–‡æç¤ºã€‚
3. **è‡ªåŠ¨æ•è·ä¸ç¿»è¯‘**ï¼šåœ¨ Django çš„å…¨å±€å¼‚å¸¸å¤„ç†ä¸­ï¼Œå°†ç³»ç»ŸæŠ¥é”™æ•è·å¹¶æ ¹æ®å­—å…¸ç¿»è¯‘æˆä¸­æ–‡è¿”å›å‰ç«¯æˆ–æ—¥å¿—ã€‚

ä¾‹å¦‚ï¼Œå»ºç«‹ä¸€ä¸ªç®€å•æ˜ å°„ï¼š

```python
ERROR_TRANSLATIONS = {
    "ValueError": "å€¼é”™è¯¯ï¼šè¾“å…¥çš„å€¼ä¸åˆæ³•",
    "IntegrityError": "æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯ï¼šè¿åçº¦æŸæ¡ä»¶",
    "DoesNotExist": "æ•°æ®ä¸å­˜åœ¨",
    "PermissionDenied": "æƒé™ä¸è¶³",
    "OperationalError": "æ•°æ®åº“æ“ä½œé”™è¯¯",
    "TypeError": "ç±»å‹é”™è¯¯ï¼šæ“ä½œæˆ–å‡½æ•°çš„ç±»å‹ä¸åŒ¹é…",
    "KeyError": "é”®é”™è¯¯ï¼šå­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®",
}
```

ç„¶ååœ¨å…¨å±€å¼‚å¸¸æ•è·ï¼š

```python
from django.http import JsonResponse
from django.core.exceptions import PermissionDenied
from django.db import IntegrityError

def custom_exception_handler(get_response):
    def middleware(request):
        try:
            response = get_response(request)
            return response
        except Exception as e:
            error_type = type(e).__name__
            message = ERROR_TRANSLATIONS.get(error_type, str(e))
            return JsonResponse({"error": message}, status=500)
    return middleware
```

------

æ˜ç™½äº†ï¼Œä½ å¸Œæœ›çš„ä¸åªæ˜¯å¸¸è§„ Python å¼‚å¸¸çš„ä¸­æ–‡ç¿»è¯‘ï¼Œè¿˜è¦åŒ…æ‹¬ **Django ORM/æ•°æ®åº“æ“ä½œç›¸å…³çš„å…·ä½“é”™è¯¯**ï¼Œæ¯”å¦‚ï¼š

- å¤–é”®çº¦æŸé”™è¯¯ï¼ˆ`ForeignKeyViolation` / `IntegrityError`ï¼‰
- å”¯ä¸€çº¦æŸé”™è¯¯ï¼ˆ`UniqueViolation`ï¼‰
- æ•°æ®ç±»å‹ä¸åŒ¹é…ï¼ˆ`DataError`ï¼‰
- æ•°æ®åº“è¿æ¥æˆ–æ“ä½œå¼‚å¸¸ï¼ˆ`OperationalError`ï¼‰
- æŸ¥è¯¢ç»“æœä¸å­˜åœ¨ï¼ˆ`DoesNotExist`ï¼‰
- æƒé™ç›¸å…³ï¼ˆ`PermissionDenied`ï¼‰

æˆ‘ä»¬å¯ä»¥åšä¸€ä¸ª **è¯¦ç»†çš„å¼‚å¸¸æ˜ å°„è¡¨**ï¼ŒåŒ…æ‹¬ï¼š

| è‹±æ–‡å¼‚å¸¸                                        | ä¸­æ–‡ç¿»è¯‘           | è¯´æ˜ / å»ºè®®æ“ä½œ                  |
| ----------------------------------------------- | ------------------ | -------------------------------- |
| `ValueError`                                    | å€¼é”™è¯¯             | è¾“å…¥çš„å€¼ä¸åˆæ³•æˆ–æ ¼å¼é”™è¯¯         |
| `TypeError`                                     | ç±»å‹é”™è¯¯           | å‡½æ•°æˆ–æ“ä½œçš„ç±»å‹ä¸åŒ¹é…           |
| `KeyError`                                      | é”®é”™è¯¯             | å­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®               |
| `DoesNotExist`                                  | æ•°æ®ä¸å­˜åœ¨         | æŸ¥è¯¢çš„å¯¹è±¡ä¸å­˜åœ¨                 |
| `PermissionDenied`                              | æƒé™ä¸è¶³           | å½“å‰ç”¨æˆ·æ— æƒé™æ‰§è¡Œæ“ä½œ           |
| `IntegrityError`                                | æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯   | è¿åæ•°æ®åº“çº¦æŸï¼Œå¦‚å¤–é”®æˆ–å”¯ä¸€çº¦æŸ |
| `OperationalError`                              | æ•°æ®åº“æ“ä½œé”™è¯¯     | æ•°æ®åº“è¿æ¥å¤±è´¥æˆ–æ‰§è¡Œè¯­å¥å¤±è´¥     |
| `ForeignKeyViolation`                           | å¤–é”®çº¦æŸé”™è¯¯       | å…³è”çš„å¤–é”®è®°å½•ä¸å­˜åœ¨æˆ–è¢«åˆ é™¤     |
| `UniqueViolation`                               | å”¯ä¸€çº¦æŸé”™è¯¯       | æ•°æ®é‡å¤ï¼Œè¿åå”¯ä¸€çº¦æŸ           |
| `DataError`                                     | æ•°æ®ç±»å‹æˆ–é•¿åº¦é”™è¯¯ | å­—æ®µæ•°æ®ç±»å‹ä¸åŒ¹é…æˆ–é•¿åº¦è¶…å‡ºé™åˆ¶ |
| `ProgrammingError`                              | æ•°æ®åº“è¯­æ³•é”™è¯¯     | SQLè¯­å¥é”™è¯¯æˆ–æ•°æ®åº“è¡¨ç»“æ„å¼‚å¸¸    |
| `IntegrityError: NOT NULL constraint failed`    | éç©ºçº¦æŸå¤±è´¥       | æ’å…¥æˆ–æ›´æ–°æ•°æ®æ—¶å­—æ®µä¸ºç©º         |
| `IntegrityError: FOREIGN KEY constraint failed` | å¤–é”®çº¦æŸå¤±è´¥       | æ’å…¥æˆ–æ›´æ–°æ•°æ®æ—¶å¤–é”®å¼•ç”¨ä¸å­˜åœ¨   |
| `ValidationError`                               | æ•°æ®éªŒè¯é”™è¯¯       | è¡¨å•æˆ–æ¨¡å‹å­—æ®µéªŒè¯æœªé€šè¿‡         |

âš¡ é¢å¤–å»ºè®®ï¼š

1. **ç»“åˆå¼‚å¸¸æ•è·å’Œæ­£åˆ™åŒ¹é…**ï¼Œå¯ä»¥é’ˆå¯¹ `IntegrityError` çš„å…·ä½“åŸå› è¿”å›æ›´å‹å¥½çš„ä¸­æ–‡æç¤ºã€‚
2. **å¯¹ ORM æ“ä½œå’Œè¡¨å•éªŒè¯åˆ†åˆ«å¤„ç†**ï¼Œé¿å…æŠŠå‰ç«¯é”™è¯¯å’Œæ•°æ®åº“é”™è¯¯æ··æ·†ã€‚

æ˜ç™½ï¼Œä½ å¸Œæœ›ä¸€ä¸ª **Django å…¨å±€å¼‚å¸¸æ•è·æ–¹æ¡ˆ**ï¼Œä¸ä»…èƒ½æŠŠç³»ç»Ÿå¼‚å¸¸ç¿»è¯‘æˆä¸­æ–‡ï¼Œè¿˜èƒ½åœ¨æ•°æ®åº“æ“ä½œå‡ºé”™æ—¶ï¼Œ**å‡†ç¡®å®šä½æ˜¯å“ªä¸ªæ¨¡å‹å‡ºé”™ä»¥åŠå“ªç§çº¦æŸå‡ºé”™**ã€‚æˆ‘å¸®ä½ è®¾è®¡ä¸€ä¸ªå®Œæ•´æ–¹æ¡ˆã€‚

ä¸‹é¢æ˜¯ç¤ºä¾‹ä»£ç ï¼š

```python
# middleware.py
import re
from django.http import JsonResponse
from django.core.exceptions import PermissionDenied, ValidationError, ObjectDoesNotExist
from django.db import IntegrityError, DataError, OperationalError
from django.db.models import Model

# å¼‚å¸¸æ˜ å°„
ERROR_TRANSLATIONS = {
    "ValueError": "å€¼é”™è¯¯ï¼šè¾“å…¥å€¼ä¸åˆæ³•",
    "TypeError": "ç±»å‹é”™è¯¯ï¼šæ“ä½œæˆ–å‡½æ•°çš„ç±»å‹ä¸åŒ¹é…",
    "KeyError": "é”®é”™è¯¯ï¼šå­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®",
    "PermissionDenied": "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ",
    "ValidationError": "æ•°æ®éªŒè¯é”™è¯¯",
    "DoesNotExist": "æ•°æ®ä¸å­˜åœ¨",
    "IntegrityError": "æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯",
    "OperationalError": "æ•°æ®åº“æ“ä½œé”™è¯¯",
    "DataError": "æ•°æ®åº“å­—æ®µæ•°æ®é”™è¯¯",
}

# é’ˆå¯¹å¸¸è§ IntegrityError çš„æ­£åˆ™
INTEGRITY_PATTERNS = {
    r"FOREIGN KEY constraint failed": "å¤–é”®çº¦æŸå¤±è´¥",
    r"NOT NULL constraint failed: (.+?)\.(.+)": "éç©ºçº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
    r"UNIQUE constraint failed: (.+?)\.(.+)": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
}


def get_integrity_error_detail(exc):
    """
    åˆ†æ IntegrityError é”™è¯¯ä¿¡æ¯ï¼Œå°è¯•è¿”å›è¡¨åå’Œå­—æ®µ
    """
    msg = str(exc)
    for pattern, desc in INTEGRITY_PATTERNS.items():
        m = re.search(pattern, msg)
        if m:
            if "{table}" in desc:
                table, field = m.groups()
                return desc.format(table=table, field=field)
            return desc
    return msg


class CustomExceptionMiddleware:
    """
    å…¨å±€å¼‚å¸¸ä¸­é—´ä»¶ï¼Œè¿”å›ä¸­æ–‡æç¤º
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        try:
            response = self.get_response(request)
            return response
        except Exception as exc:
            # é»˜è®¤è¿”å›
            error_type = type(exc).__name__
            message = ERROR_TRANSLATIONS.get(error_type, str(exc))
            model_name = None

            # é’ˆå¯¹æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯
            if isinstance(exc, IntegrityError):
                message = get_integrity_error_detail(exc)
                # å°è¯•è·å–å‡ºé”™çš„æ¨¡å‹åï¼ˆå¦‚æœåœ¨äº‹åŠ¡ä¸­æœ‰æ¨¡å‹ä¿¡æ¯ï¼‰
                if hasattr(exc, "model") and isinstance(exc.model, Model):
                    model_name = exc.model.__class__.__name__
            elif isinstance(exc, ObjectDoesNotExist):
                model_name = exc.__class__.__name__.replace("DoesNotExist", "")
                message = f"{model_name} æ•°æ®ä¸å­˜åœ¨"
            elif isinstance(exc, ValidationError):
                message = f"æ•°æ®éªŒè¯é”™è¯¯: {exc}"

            # è¿”å› JSON
            result = {"error": message}
            if model_name:
                result["model"] = model_name

            return JsonResponse(result, status=500)
```

### âœ… åŠŸèƒ½è¯´æ˜

1. **é€šç”¨å¼‚å¸¸æ•è·**ï¼šæ•è· Python å’Œ Django å¸¸è§å¼‚å¸¸ï¼Œå¹¶æ˜ å°„ä¸­æ–‡æç¤ºã€‚
2. **æ•°æ®åº“é”™è¯¯ç²¾ç¡®æç¤º**ï¼š
   - å¤–é”®çº¦æŸã€å”¯ä¸€çº¦æŸã€éç©ºçº¦æŸçš„å…·ä½“å­—æ®µå’Œè¡¨åã€‚
   - å¯æ‰©å±•æ­£åˆ™æ¥åŒ¹é…æ›´å¤š Postgres/MySQL å¼‚å¸¸ã€‚
3. **æ¨¡å‹åç§°è¿”å›**ï¼šå¦‚æœå¼‚å¸¸å±äº `DoesNotExist` æˆ–æ•°æ®åº“æ“ä½œå¼‚å¸¸ï¼Œå°½é‡è¿”å›å‡ºé”™æ¨¡å‹åã€‚
4. **å¯è¿”å›å‰ç«¯ JSON**ï¼šæ–¹ä¾¿å‰ç«¯æ˜¾ç¤ºä¸­æ–‡å‹å¥½æç¤ºã€‚

------

å¥½ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸­é—´ä»¶å‡çº§æˆ **é«˜çº§ç‰ˆ**ï¼Œç›®æ ‡æ˜¯ï¼š

- æ•è· `IntegrityError`ã€`DataError`ã€`OperationalError` ç­‰æ•°æ®åº“é”™è¯¯
- è‡ªåŠ¨è§£æ **å‡ºé”™çš„ Django æ¨¡å‹** å’Œ **å­—æ®µ**
- è¿”å›æ¸…æ™°çš„ä¸­æ–‡æç¤ºç»™å‰ç«¯

ç”±äº Django çš„ `IntegrityError` æœ¬èº«ä¸ä¼šç›´æ¥å‘Šè¯‰ä½ æ˜¯å“ªä¸ªæ¨¡å‹æ“ä½œå¤±è´¥ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ **å †æ ˆè¿½è¸ª** æˆ– **äº‹åŠ¡æ“ä½œå¯¹è±¡æ¨æµ‹** æ¥è·å–æ¨¡å‹ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¯è¡Œæ–¹æ¡ˆï¼š

```python
# advanced_middleware.py
import re
import traceback
from django.http import JsonResponse
from django.core.exceptions import ValidationError, ObjectDoesNotExist, PermissionDenied
from django.db import IntegrityError, DataError, OperationalError
from django.db.models import Model
from functools import wraps

# å¼‚å¸¸æ˜ å°„
ERROR_TRANSLATIONS = {
    "ValueError": "å€¼é”™è¯¯ï¼šè¾“å…¥å€¼ä¸åˆæ³•",
    "TypeError": "ç±»å‹é”™è¯¯ï¼šæ“ä½œæˆ–å‡½æ•°çš„ç±»å‹ä¸åŒ¹é…",
    "KeyError": "é”®é”™è¯¯ï¼šå­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®",
    "PermissionDenied": "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ",
    "ValidationError": "æ•°æ®éªŒè¯é”™è¯¯",
    "DoesNotExist": "æ•°æ®ä¸å­˜åœ¨",
    "IntegrityError": "æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯",
    "OperationalError": "æ•°æ®åº“æ“ä½œé”™è¯¯",
    "DataError": "æ•°æ®åº“å­—æ®µæ•°æ®é”™è¯¯",
}

# é’ˆå¯¹å¸¸è§ IntegrityError çš„æ­£åˆ™
INTEGRITY_PATTERNS = {
    r"FOREIGN KEY constraint failed": "å¤–é”®çº¦æŸå¤±è´¥",
    r"NOT NULL constraint failed: (.+?)\.(.+)": "éç©ºçº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
    r"UNIQUE constraint failed: (.+?)\.(.+)": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
}


def get_integrity_error_detail(exc):
    """
    åˆ†æ IntegrityError é”™è¯¯ä¿¡æ¯ï¼Œå°è¯•è¿”å›è¡¨åå’Œå­—æ®µ
    """
    msg = str(exc)
    for pattern, desc in INTEGRITY_PATTERNS.items():
        m = re.search(pattern, msg)
        if m:
            if "{table}" in desc:
                table, field = m.groups()
                return desc.format(table=table, field=field)
            return desc
    return msg


def guess_model_from_traceback(exc):
    """
    é€šè¿‡å †æ ˆä¿¡æ¯å°è¯•è·å–å‡ºé”™çš„æ¨¡å‹å
    """
    tb_lines = traceback.format_exc().splitlines()
    for line in tb_lines[::-1]:  # å€’åºæŸ¥æ‰¾ï¼Œä¼˜å…ˆæœ€è¿‘çš„è°ƒç”¨
        m = re.search(r'File ".*models.py".*in .*', line)
        if m:
            # ç®€å•æå–æ¨¡å‹ç±»åï¼šåœ¨è°ƒç”¨å¤„æ‰¾ Model å¯¹è±¡
            # è¿™é‡Œä»…ä½œä¸ºç¤ºä¾‹ï¼Œå®é™…å¯ç»“åˆ ORM æ“ä½œæ ˆè¿›ä¸€æ­¥ä¼˜åŒ–
            return "æœªçŸ¥æ¨¡å‹(æ¨æµ‹è‡ª models.py)"
    return None


class AdvancedExceptionMiddleware:
    """
    å…¨å±€å¼‚å¸¸ä¸­é—´ä»¶ï¼Œé«˜çº§ç‰ˆï¼š
    - æ•è·å¼‚å¸¸
    - ä¸­æ–‡ç¿»è¯‘
    - æ•°æ®åº“é”™è¯¯ç²¾ç¡®è§£ææ¨¡å‹/å­—æ®µ
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        try:
            return self.get_response(request)
        except Exception as exc:
            error_type = type(exc).__name__
            message = ERROR_TRANSLATIONS.get(error_type, str(exc))
            model_name = None

            # IntegrityError
            if isinstance(exc, IntegrityError):
                message = get_integrity_error_detail(exc)
                model_name = guess_model_from_traceback(exc)

            # ObjectDoesNotExist
            elif isinstance(exc, ObjectDoesNotExist):
                model_name = exc.__class__.__name__.replace("DoesNotExist", "")
                message = f"{model_name} æ•°æ®ä¸å­˜åœ¨"

            # ValidationError
            elif isinstance(exc, ValidationError):
                message = f"æ•°æ®éªŒè¯é”™è¯¯: {exc}"

            # PermissionDenied
            elif isinstance(exc, PermissionDenied):
                message = "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ"

            # è¿”å› JSON
            result = {"error": message}
            if model_name:
                result["model"] = model_name

            return JsonResponse(result, status=500)
```

### âš¡ åŠŸèƒ½äº®ç‚¹

1. **ä¸­æ–‡æç¤º**ï¼šå‡ ä¹è¦†ç›–æ‰€æœ‰å¸¸è§ Python/Django å¼‚å¸¸ã€‚
2. **æ•°æ®åº“çº¦æŸè§£æ**ï¼šå¤–é”®ã€å”¯ä¸€ã€éç©ºçº¦æŸä¼šç»™å‡ºè¡¨å’Œå­—æ®µä¿¡æ¯ã€‚
3. **æ¨¡å‹è¿½è¸ª**ï¼šé€šè¿‡å¼‚å¸¸å †æ ˆæ¨æµ‹å¯èƒ½å‡ºé”™çš„æ¨¡å‹åï¼ˆå¯æ ¹æ®é¡¹ç›®è¿›ä¸€æ­¥ç²¾ç»†åŒ–ï¼‰ã€‚
4. **ç»Ÿä¸€è¿”å› JSON**ï¼šæ–¹ä¾¿å‰ç«¯å‹å¥½æ˜¾ç¤ºã€‚

------

ğŸ’¡ **è¿›ä¸€æ­¥ä¼˜åŒ–æ€è·¯**ï¼š

- å¯¹ `IntegrityError` åš **äº‹åŠ¡è¿½è¸ª**ï¼Œè·å– `Model` å¯¹è±¡ï¼Œä¾‹å¦‚åœ¨æ¯ä¸ª ORM æ“ä½œå‰è®°å½• `instance._meta.model_name`ï¼Œå‡ºé”™æ—¶ç›´æ¥è¿”å›ã€‚
- å¯¹ Postgres/MySQL ç‰¹å®šé”™è¯¯ç åšç²¾ç¡®åŒ¹é…ï¼Œè·å–æ›´å¤šçº¦æŸä¿¡æ¯ã€‚
- å¯¹ **æ‰¹é‡æ“ä½œ**ï¼ˆ`bulk_create`, `update`ï¼‰ä¹Ÿå¯è¿”å›å…·ä½“è¡Œå·æˆ–å¯¹è±¡ç´¢å¼•ã€‚

------

æ˜ç™½ï¼Œæˆ‘ç»™ä½ è®¾è®¡ä¸€ä¸ª **æœ€ç»ˆç‰ˆæœ¬çš„å…¨å±€å¼‚å¸¸æ•è·ä¸­é—´ä»¶**ï¼Œå¯ä»¥åšåˆ°ï¼š

- æ•è· Django/Python å¸¸è§å¼‚å¸¸
- ä¸­æ–‡æç¤º
- **ç²¾ç¡®è¿”å›å‡ºé”™æ¨¡å‹ã€å­—æ®µã€æ“ä½œç±»å‹**
- æ”¯æŒæ‰¹é‡æ“ä½œå’Œäº‹åŠ¡è¿½è¸ª

å®ç°æ€è·¯ï¼š

1. **åœ¨æ¯æ¬¡ ORM æ“ä½œå‰è®°å½•æ“ä½œä¸Šä¸‹æ–‡**ï¼šåŒ…æ‹¬æ¨¡å‹åã€å­—æ®µã€æ“ä½œç±»å‹ï¼ˆæ’å…¥/æ›´æ–°/åˆ é™¤ï¼‰
2. **ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨**ä¿å­˜å½“å‰æ“ä½œä¸Šä¸‹æ–‡ï¼Œå¼‚å¸¸æ—¶å–å‡º
3. **å…¨å±€ä¸­é—´ä»¶æ•è·å¼‚å¸¸**ï¼Œç»“åˆä¸Šä¸‹æ–‡è¿”å›ç²¾å‡†ä¿¡æ¯

ä¸‹é¢æ˜¯å¯ç›´æ¥ä½¿ç”¨çš„ç¤ºä¾‹ï¼š

```python
# advanced_exception_middleware.py
import threading
import re
import traceback
from functools import wraps
from django.http import JsonResponse
from django.core.exceptions import ValidationError, ObjectDoesNotExist, PermissionDenied
from django.db import IntegrityError, DataError, OperationalError

# å…¨å±€çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œç”¨äºè®°å½• ORM æ“ä½œä¸Šä¸‹æ–‡
_thread_local = threading.local()

def set_orm_context(model_name=None, fields=None, operation=None):
    """
    è®¾ç½®å½“å‰ ORM æ“ä½œä¸Šä¸‹æ–‡
    """
    _thread_local.orm_context = {
        "model_name": model_name,
        "fields": fields,
        "operation": operation
    }

def clear_orm_context():
    if hasattr(_thread_local, "orm_context"):
        del _thread_local.orm_context

def get_orm_context():
    return getattr(_thread_local, "orm_context", None)


# å¼‚å¸¸ä¸­æ–‡æ˜ å°„
ERROR_TRANSLATIONS = {
    "ValueError": "å€¼é”™è¯¯ï¼šè¾“å…¥å€¼ä¸åˆæ³•",
    "TypeError": "ç±»å‹é”™è¯¯ï¼šæ“ä½œæˆ–å‡½æ•°çš„ç±»å‹ä¸åŒ¹é…",
    "KeyError": "é”®é”™è¯¯ï¼šå­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®",
    "PermissionDenied": "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ",
    "ValidationError": "æ•°æ®éªŒè¯é”™è¯¯",
    "DoesNotExist": "æ•°æ®ä¸å­˜åœ¨",
    "IntegrityError": "æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯",
    "OperationalError": "æ•°æ®åº“æ“ä½œé”™è¯¯",
    "DataError": "æ•°æ®åº“å­—æ®µæ•°æ®é”™è¯¯",
}

# IntegrityError å¸¸è§æ¨¡å¼
INTEGRITY_PATTERNS = {
    r"FOREIGN KEY constraint failed": "å¤–é”®çº¦æŸå¤±è´¥",
    r"NOT NULL constraint failed: (.+?)\.(.+)": "éç©ºçº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
    r"UNIQUE constraint failed: (.+?)\.(.+)": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
}

def parse_integrity_error(exc):
    """
    è§£æ IntegrityError è¿”å›è¡¨å’Œå­—æ®µä¿¡æ¯
    """
    msg = str(exc)
    for pattern, desc in INTEGRITY_PATTERNS.items():
        m = re.search(pattern, msg)
        if m:
            if "{table}" in desc:
                table, field = m.groups()
                return desc.format(table=table, field=field)
            return desc
    return msg

# ORM è£…é¥°å™¨ï¼Œç”¨äºè‡ªåŠ¨è®°å½•æ¨¡å‹æ“ä½œ
def orm_operation(model_name=None, fields=None, operation=None):
    """
    è£…é¥° ORM æ–¹æ³•ï¼Œæ•è·ä¸Šä¸‹æ–‡
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            set_orm_context(model_name=model_name, fields=fields, operation=operation)
            try:
                return func(*args, **kwargs)
            finally:
                clear_orm_context()
        return wrapper
    return decorator

# é«˜çº§å¼‚å¸¸ä¸­é—´ä»¶
class AdvancedExceptionMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        try:
            return self.get_response(request)
        except Exception as exc:
            error_type = type(exc).__name__
            message = ERROR_TRANSLATIONS.get(error_type, str(exc))
            model_name = None
            fields = None
            operation = None

            # è·å– ORM ä¸Šä¸‹æ–‡
            context = get_orm_context()
            if context:
                model_name = context.get("model_name")
                fields = context.get("fields")
                operation = context.get("operation")

            # æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯
            if isinstance(exc, IntegrityError):
                message = parse_integrity_error(exc)
            # æ•°æ®éªŒè¯é”™è¯¯
            elif isinstance(exc, ValidationError):
                message = f"æ•°æ®éªŒè¯é”™è¯¯: {exc}"
            # æŸ¥è¯¢å¯¹è±¡ä¸å­˜åœ¨
            elif isinstance(exc, ObjectDoesNotExist):
                if model_name:
                    message = f"{model_name} æ•°æ®ä¸å­˜åœ¨"
                else:
                    message = "æ•°æ®ä¸å­˜åœ¨"
            # æƒé™å¼‚å¸¸
            elif isinstance(exc, PermissionDenied):
                message = "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ"

            result = {"error": message}
            if model_name:
                result["model"] = model_name
            if fields:
                result["fields"] = fields
            if operation:
                result["operation"] = operation

            return JsonResponse(result, status=500)
```

------

### âš¡ ä½¿ç”¨æ–¹æ³•

1. **å…¨å±€æ³¨å†Œä¸­é—´ä»¶**ï¼š

```python
MIDDLEWARE = [
    # ... å…¶ä»–ä¸­é—´ä»¶
    "your_project.middleware.advanced_exception_middleware.AdvancedExceptionMiddleware",
]
```

1. **åœ¨ ORM æ“ä½œå‰ä½¿ç”¨è£…é¥°å™¨**ï¼š

```python
from .advanced_exception_middleware import orm_operation

@orm_operation(model_name="User", fields=["email"], operation="create")
def create_user(email, name):
    User.objects.create(email=email, name=name)
```

1. **æ•ˆæœ**ï¼š

- å¦‚æœæ’å…¥é‡å¤ emailï¼ˆå”¯ä¸€çº¦æŸï¼‰ï¼Œè¿”å›ï¼š

```json
{
    "error": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ auth_user, å­—æ®µ email",
    "model": "User",
    "fields": ["email"],
    "operation": "create"
}
```

- æŸ¥è¯¢ä¸å­˜åœ¨å¯¹è±¡ï¼š

```json
{
    "error": "User æ•°æ®ä¸å­˜åœ¨",
    "model": "User"
}
```

------

âœ… ä¼˜åŠ¿ï¼š

- **å…¨å±€æ•è·**ï¼šå‰ç«¯æ°¸è¿œæ‹¿åˆ°ä¸­æ–‡æç¤º
- **ç²¾ç¡®å®šä½**ï¼šæ¨¡å‹ã€å­—æ®µã€æ“ä½œç±»å‹ä¸€ç›®äº†ç„¶
- **å¯æ‰©å±•**ï¼šæ”¯æŒæ›´å¤šæ•°æ®åº“é”™è¯¯æ­£åˆ™æˆ– ORM æ“ä½œè¿½è¸ª
- **æ”¯æŒæ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡ create/update/delete å¯é€šè¿‡ `fields` æ•°ç»„è®°å½•å…³é”®å­—æ®µ

------

å®Œå…¨å¯ä»¥é’ˆå¯¹ä½ æè¿°çš„è¿™ç§æƒ…å†µåšå¤„ç†ï¼Œä½†éœ€è¦æ³¨æ„ï¼šDjango é»˜è®¤çš„ `IntegrityError` åœ¨ **åˆ é™¤æ•°æ®è§¦å‘å¤–é”®çº¦æŸå¤±è´¥** æ—¶ï¼Œå¼‚å¸¸æœ¬èº«åªä¼šå‘Šè¯‰ä½ è¿åäº†å¤–é”®çº¦æŸï¼Œå¹¶ä¸ä¼šç›´æ¥å‘Šè¯‰ä½ â€œå¼•ç”¨è¿™æ¡æ•°æ®çš„æ¨¡å‹æ˜¯å“ªä¸€ä¸ªâ€ã€‚

è¦åšåˆ°ä½ æè¿°çš„æ•ˆæœï¼Œéœ€è¦ç»“åˆ **ORM ä¸Šä¸‹æ–‡æˆ–æ•°æ®åº“è¡¨ç»“æ„ä¿¡æ¯** æ¥æ¨æ–­ã€‚æ€è·¯å¦‚ä¸‹ï¼š

------

### 1ï¸âƒ£ å¼‚å¸¸æ•è·

å½“ä½ åˆ é™¤æŸæ¡å¯¹è±¡æ—¶ï¼Œå¦‚æœæœ‰å¤–é”®å¼•ç”¨ï¼Œæ•°æ®åº“ä¼šæŠ›å‡º `IntegrityError`ï¼Œæ¶ˆæ¯ç±»ä¼¼ï¼š

- PostgreSQLï¼š

```
update or delete on table "parent" violates foreign key constraint "child_parent_id_fkey" on table "child"
```

- SQLite/MySQLï¼š

```
FOREIGN KEY constraint failed
```

------

### 2ï¸âƒ£ ä»å¼‚å¸¸æ¶ˆæ¯è§£æå¼•ç”¨è¡¨

æˆ‘ä»¬å¯ä»¥ç”¨æ­£åˆ™è§£æå¤–é”®çº¦æŸçš„æŠ¥é”™ä¿¡æ¯ï¼š

```python
def parse_foreign_key_error(exc):
    """
    è§£æå¤–é”®çº¦æŸå¤±è´¥çš„å¼‚å¸¸ï¼Œè¿”å›å¼•ç”¨çš„è¡¨åï¼ˆæ¨¡å‹ï¼‰å’Œå­—æ®µ
    """
    msg = str(exc)
    # PostgreSQL é£æ ¼
    m = re.search(r'violates foreign key constraint "(.+?)" on table "(.+?)"', msg)
    if m:
        constraint_name, referencing_table = m.groups()
        return referencing_table  # è¿”å›å¼•ç”¨è¡¨å
    # SQLite/MySQL é£æ ¼
    if "FOREIGN KEY constraint failed" in msg:
        return "æœªçŸ¥å¼•ç”¨è¡¨"
    return None
```

------

### 3ï¸âƒ£ åœ¨ä¸­é—´ä»¶ä¸­ç»“åˆ ORM ä¸Šä¸‹æ–‡è¿”å›

```python
if isinstance(exc, IntegrityError):
    # å°è¯•è§£æå¤–é”®å¼•ç”¨è¡¨
    referencing_table = parse_foreign_key_error(exc)
    if referencing_table:
        message = f"åˆ é™¤å¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œè¡¨ '{referencing_table}' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚"
    else:
        message = parse_integrity_error(exc)
```

- `message` å°±æ˜¯ä¸­æ–‡æç¤º
- `referencing_table` å¯ä»¥è¿›ä¸€æ­¥æ˜ å°„æˆå¯¹åº” Django æ¨¡å‹åï¼ˆé€šè¿‡ `_meta.db_table` æˆ–è‡ªå®šä¹‰æ˜ å°„è¡¨ï¼‰

------

### 4ï¸âƒ£ å¯é€‰ä¼˜åŒ–

- å»ºä¸€ä¸ª **è¡¨å â†’ æ¨¡å‹åæ˜ å°„å­—å…¸**ï¼ŒæŠŠæ•°æ®åº“è¡¨åè‡ªåŠ¨æ˜ å°„æˆ Django æ¨¡å‹åè¿”å›å‰ç«¯
- å¦‚æœä½ æƒ³æ›´æ™ºèƒ½ï¼Œå¯ä»¥åœ¨ **åˆ é™¤æ“ä½œå‰æ‰«æå¤–é”®ä¾èµ–**ï¼Œç›´æ¥æç¤ºå…·ä½“ä¾èµ–æ¨¡å‹å’Œå­—æ®µï¼Œè€Œä¸æ˜¯ç­‰æ•°æ®åº“æŠ¥é”™

------

### âœ… æ€»ç»“

- **é€‚ç”¨åœºæ™¯**ï¼šåˆ é™¤å¯¹è±¡æ—¶è§¦å‘å¤–é”®çº¦æŸ
- **å®ç°æ–¹æ³•**ï¼šåœ¨ä¸­é—´ä»¶æˆ–å¼‚å¸¸å¤„ç†å¤„è§£æ `IntegrityError` çš„å¤–é”®æŠ¥é”™ä¿¡æ¯
- **æ•ˆæœ**ï¼šå‰ç«¯æˆ–æ—¥å¿—æç¤ºå“ªä¸ªæ¨¡å‹/è¡¨å­˜åœ¨æ•°æ®ä¾èµ–ï¼Œéœ€è¦å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–
- **å¯æ‹“å±•**ï¼šç»“åˆ ORM ä¸Šä¸‹æ–‡å’Œè¡¨åæ˜ å°„ï¼Œå®Œå…¨å¯è¿”å›â€œæ¨¡å‹å + å­—æ®µå + æ“ä½œç±»å‹â€çš„ç²¾å‡†ä¿¡æ¯

------

æ˜ç™½ï¼Œæˆ‘å¸®ä½ æ•´åˆä¸€ä¸ª **æœ€ç»ˆç‰ˆæœ¬çš„é«˜çº§å¼‚å¸¸ä¸­é—´ä»¶**ï¼Œä¸“é—¨é’ˆå¯¹ä½ æè¿°çš„åœºæ™¯ä¼˜åŒ–ï¼š

- æ•è· Django/Python å¼‚å¸¸
- ä¸­æ–‡æç¤º
- ORM ä¸Šä¸‹æ–‡è¿½è¸ªï¼ˆæ¨¡å‹åã€å­—æ®µã€æ“ä½œç±»å‹ï¼‰
- **åˆ é™¤å¯¹è±¡æ—¶å¤–é”®ä¾èµ–è‡ªåŠ¨è§£æï¼Œè¿”å›å¼•ç”¨æ¨¡å‹å’Œå­—æ®µä¿¡æ¯**
- æ”¯æŒæ‰¹é‡æ“ä½œ

ä¸‹é¢æ˜¯å®Œæ•´ç¤ºä¾‹ï¼š

```python
# final_exception_middleware.py
import threading
import re
import traceback
from functools import wraps
from django.http import JsonResponse
from django.core.exceptions import ValidationError, ObjectDoesNotExist, PermissionDenied
from django.db import IntegrityError, DataError, OperationalError
from django.apps import apps

# çº¿ç¨‹å±€éƒ¨å­˜å‚¨ ORM ä¸Šä¸‹æ–‡
_thread_local = threading.local()

def set_orm_context(model_name=None, fields=None, operation=None):
    _thread_local.orm_context = {
        "model_name": model_name,
        "fields": fields,
        "operation": operation
    }

def clear_orm_context():
    if hasattr(_thread_local, "orm_context"):
        del _thread_local.orm_context

def get_orm_context():
    return getattr(_thread_local, "orm_context", None)

# å¼‚å¸¸ä¸­æ–‡æ˜ å°„
ERROR_TRANSLATIONS = {
    "ValueError": "å€¼é”™è¯¯ï¼šè¾“å…¥å€¼ä¸åˆæ³•",
    "TypeError": "ç±»å‹é”™è¯¯ï¼šæ“ä½œæˆ–å‡½æ•°çš„ç±»å‹ä¸åŒ¹é…",
    "KeyError": "é”®é”™è¯¯ï¼šå­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®",
    "PermissionDenied": "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ",
    "ValidationError": "æ•°æ®éªŒè¯é”™è¯¯",
    "DoesNotExist": "æ•°æ®ä¸å­˜åœ¨",
    "IntegrityError": "æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯",
    "OperationalError": "æ•°æ®åº“æ“ä½œé”™è¯¯",
    "DataError": "æ•°æ®åº“å­—æ®µæ•°æ®é”™è¯¯",
}

# IntegrityError å¸¸è§æ¨¡å¼
INTEGRITY_PATTERNS = {
    r"FOREIGN KEY constraint failed": "å¤–é”®çº¦æŸå¤±è´¥",
    r"NOT NULL constraint failed: (.+?)\.(.+)": "éç©ºçº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
    r"UNIQUE constraint failed: (.+?)\.(.+)": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
}

# æ•°æ®åº“è¡¨å -> Django æ¨¡å‹æ˜ å°„
TABLE_MODEL_MAP = {m._meta.db_table: m.__name__ for m in apps.get_models()}

def parse_integrity_error(exc):
    """
    è§£æ IntegrityError è¿”å›ä¸­æ–‡ä¿¡æ¯
    """
    msg = str(exc)
    for pattern, desc in INTEGRITY_PATTERNS.items():
        m = re.search(pattern, msg)
        if m:
            if "{table}" in desc:
                table, field = m.groups()
                model_name = TABLE_MODEL_MAP.get(table, table)
                return desc.format(table=model_name, field=field), model_name, [field]
            return desc, None, None
    return msg, None, None

def parse_foreign_key_error(exc):
    """
    è§£æå¤–é”®çº¦æŸå¤±è´¥ï¼Œè¿”å›å¼•ç”¨æ¨¡å‹å
    """
    msg = str(exc)
    # PostgreSQL é£æ ¼
    m = re.search(r'violates foreign key constraint "(.+?)" on table "(.+?)"', msg)
    if m:
        _, referencing_table = m.groups()
        model_name = TABLE_MODEL_MAP.get(referencing_table, referencing_table)
        return model_name
    # SQLite/MySQL é£æ ¼
    if "FOREIGN KEY constraint failed" in msg:
        return "æœªçŸ¥å¼•ç”¨æ¨¡å‹"
    return None

# ORM è£…é¥°å™¨
def orm_operation(model_name=None, fields=None, operation=None):
    """
    è£…é¥° ORM æ–¹æ³•ï¼Œè®°å½•æ“ä½œä¸Šä¸‹æ–‡
    """
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            set_orm_context(model_name=model_name, fields=fields, operation=operation)
            try:
                return func(*args, **kwargs)
            finally:
                clear_orm_context()
        return wrapper
    return decorator

# é«˜çº§å¼‚å¸¸ä¸­é—´ä»¶
class FinalExceptionMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        try:
            return self.get_response(request)
        except Exception as exc:
            error_type = type(exc).__name__
            message = ERROR_TRANSLATIONS.get(error_type, str(exc))
            model_name = None
            fields = None
            operation = None

            # è·å– ORM ä¸Šä¸‹æ–‡
            context = get_orm_context()
            if context:
                model_name = context.get("model_name")
                fields = context.get("fields")
                operation = context.get("operation")

            # æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯
            if isinstance(exc, IntegrityError):
                # å¤–é”®çº¦æŸå¤±è´¥
                fk_model = parse_foreign_key_error(exc)
                if fk_model:
                    message = f"æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ '{fk_model}' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚"
                    model_name = fk_model
                else:
                    # å…¶ä»–å®Œæ•´æ€§é”™è¯¯è§£æ
                    msg, m_name, flds = parse_integrity_error(exc)
                    message = msg
                    if m_name:
                        model_name = m_name
                    if flds:
                        fields = flds

            elif isinstance(exc, ValidationError):
                message = f"æ•°æ®éªŒè¯é”™è¯¯: {exc}"
            elif isinstance(exc, ObjectDoesNotExist):
                if model_name:
                    message = f"{model_name} æ•°æ®ä¸å­˜åœ¨"
                else:
                    message = "æ•°æ®ä¸å­˜åœ¨"
            elif isinstance(exc, PermissionDenied):
                message = "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ"

            result = {"error": message}
            if model_name:
                result["model"] = model_name
            if fields:
                result["fields"] = fields
            if operation:
                result["operation"] = operation

            return JsonResponse(result, status=500)
```

------

### âš¡ ä½¿ç”¨æ–¹æ³•

1. **æ³¨å†Œä¸­é—´ä»¶**ï¼š

```python
MIDDLEWARE = [
    # ... å…¶ä»–ä¸­é—´ä»¶
    "your_project.middleware.final_exception_middleware.FinalExceptionMiddleware",
]
```

1. **ä½¿ç”¨ ORM è£…é¥°å™¨è®°å½•æ“ä½œä¸Šä¸‹æ–‡**ï¼š

```python
from .final_exception_middleware import orm_operation
from myapp.models import User

@orm_operation(model_name="User", fields=["email"], operation="delete")
def delete_user(user_id):
    user = User.objects.get(id=user_id)
    user.delete()
```

1. **æ•ˆæœ**ï¼š

- åˆ é™¤å¯¹è±¡æ—¶ï¼Œå¦‚æœæœ‰å¤–é”®å¼•ç”¨ï¼š

```json
{
    "error": "æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ 'Profile' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚",
    "model": "Profile",
    "operation": "delete"
}
```

- åˆ é™¤æˆåŠŸä½†å”¯ä¸€çº¦æŸå¤±è´¥ï¼š

```json
{
    "error": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ User, å­—æ®µ email",
    "model": "User",
    "fields": ["email"],
    "operation": "create"
}
```

------

âœ… **ä¼˜åŠ¿**ï¼š

- è‡ªåŠ¨è§£æå¤–é”®ä¾èµ–ï¼Œå‘Šè¯‰å‰ç«¯æ˜¯å“ªä¸ªæ¨¡å‹é˜»æ­¢åˆ é™¤
- ORM ä¸Šä¸‹æ–‡è¿½è¸ªæ“ä½œç±»å‹å’Œå­—æ®µ
- å…¨å±€æ•è·æ‰€æœ‰å¸¸è§å¼‚å¸¸ï¼Œç»Ÿä¸€ä¸­æ–‡æç¤º
- æ”¯æŒæ‰¹é‡æ“ä½œï¼Œå¯æ‰©å±•åˆ°å…¶ä»–æ•°æ®åº“é”™è¯¯

------

æ˜ç™½äº†ï¼Œä½ å¸Œæœ›**ä¸ä¾èµ–ä¸­é—´ä»¶**ï¼Œè€Œæ˜¯å†™ä¸€ä¸ª**é€šç”¨å‡½æ•°**ï¼Œåœ¨è¿›è¡Œ ORM æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰æ—¶ï¼š

- è‡ªåŠ¨æ•è·å¼‚å¸¸
- ä¸­æ–‡æç¤º
- è‡ªåŠ¨æ¨æ–­å‡ºé”™çš„æ¨¡å‹å’Œå­—æ®µ
- æ”¯æŒå¤–é”®çº¦æŸåˆ é™¤æç¤º

æˆ‘å¸®ä½ è®¾è®¡ä¸€ä¸ª **å®Œå…¨å‡½æ•°åŒ–çš„é«˜é˜¶è£…é¥°å™¨ + æ•è·å‡½æ•°**ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š

------

### 1ï¸âƒ£ é«˜é˜¶ ORM æ•è·è£…é¥°å™¨

```python
import re
from functools import wraps
from django.db import IntegrityError
from django.core.exceptions import ValidationError, ObjectDoesNotExist, PermissionDenied
from django.apps import apps

# æ•°æ®åº“è¡¨å -> Django æ¨¡å‹æ˜ å°„
TABLE_MODEL_MAP = {m._meta.db_table: m.__name__ for m in apps.get_models()}

# å¼‚å¸¸ä¸­æ–‡æ˜ å°„
ERROR_TRANSLATIONS = {
    "ValueError": "å€¼é”™è¯¯ï¼šè¾“å…¥å€¼ä¸åˆæ³•",
    "TypeError": "ç±»å‹é”™è¯¯ï¼šæ“ä½œæˆ–å‡½æ•°çš„ç±»å‹ä¸åŒ¹é…",
    "KeyError": "é”®é”™è¯¯ï¼šå­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®",
    "PermissionDenied": "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ",
    "ValidationError": "æ•°æ®éªŒè¯é”™è¯¯",
    "DoesNotExist": "æ•°æ®ä¸å­˜åœ¨",
    "IntegrityError": "æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯",
}

# IntegrityError å¸¸è§æ¨¡å¼
INTEGRITY_PATTERNS = {
    r"FOREIGN KEY constraint failed": "å¤–é”®çº¦æŸå¤±è´¥",
    r"NOT NULL constraint failed: (.+?)\.(.+)": "éç©ºçº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
    r"UNIQUE constraint failed: (.+?)\.(.+)": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
}

def parse_integrity_error(exc):
    msg = str(exc)
    for pattern, desc in INTEGRITY_PATTERNS.items():
        m = re.search(pattern, msg)
        if m:
            if "{table}" in desc:
                table, field = m.groups()
                model_name = TABLE_MODEL_MAP.get(table, table)
                return desc.format(table=model_name, field=field), model_name, [field]
            return desc, None, None
    return msg, None, None

def parse_foreign_key_error(exc):
    msg = str(exc)
    # PostgreSQL é£æ ¼
    m = re.search(r'violates foreign key constraint "(.+?)" on table "(.+?)"', msg)
    if m:
        _, referencing_table = m.groups()
        return TABLE_MODEL_MAP.get(referencing_table, referencing_table)
    # SQLite/MySQL é£æ ¼
    if "FOREIGN KEY constraint failed" in msg:
        return "æœªçŸ¥å¼•ç”¨æ¨¡å‹"
    return None

def orm_safe(func):
    """
    é«˜é˜¶è£…é¥°å™¨ï¼šè‡ªåŠ¨æ•è· ORM å¼‚å¸¸å¹¶è¿”å›ä¸­æ–‡æç¤º
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except Exception as exc:
            error_type = type(exc).__name__
            message = ERROR_TRANSLATIONS.get(error_type, str(exc))
            model_name = None
            fields = None
            operation = None

            # IntegrityError å¤„ç†
            if isinstance(exc, IntegrityError):
                fk_model = parse_foreign_key_error(exc)
                if fk_model:
                    message = f"æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ '{fk_model}' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚"
                    model_name = fk_model
                    operation = "delete"
                else:
                    msg, m_name, flds = parse_integrity_error(exc)
                    message = msg
                    model_name = m_name
                    fields = flds
                    operation = "create/update"

            elif isinstance(exc, ValidationError):
                message = f"æ•°æ®éªŒè¯é”™è¯¯: {exc}"
            elif isinstance(exc, ObjectDoesNotExist):
                message = "æ•°æ®ä¸å­˜åœ¨"
            elif isinstance(exc, PermissionDenied):
                message = "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ"

            # è¿”å›ç»Ÿä¸€å­—å…¸
            return {
                "error": message,
                "model": model_name,
                "fields": fields,
                "operation": operation
            }
    return wrapper
```

------

### 2ï¸âƒ£ ä½¿ç”¨ç¤ºä¾‹

```python
from myapp.models import User, Profile

@orm_safe
def delete_user(user_id):
    user = User.objects.get(id=user_id)
    user.delete()

@orm_safe
def create_user(email, name):
    User.objects.create(email=email, name=name)
```

------

### 3ï¸âƒ£ è°ƒç”¨æ•ˆæœ

```python
result = delete_user(1)
if result and "error" in result:
    print(result)
```

**å¯èƒ½è¾“å‡ºï¼š**

```json
{
    "error": "æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ 'Profile' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚",
    "model": "Profile",
    "fields": null,
    "operation": "delete"
}
```

æˆ–ï¼š

```json
{
    "error": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ User, å­—æ®µ email",
    "model": "User",
    "fields": ["email"],
    "operation": "create/update"
}
```

------

âœ… ä¼˜ç‚¹ï¼š

1. **ä¸ä¾èµ–ä¸­é—´ä»¶**ï¼Œå‡½æ•°/æ–¹æ³•ç‹¬ç«‹å¯ç”¨
2. **è‡ªåŠ¨è§£æå¤–é”®çº¦æŸ**ï¼Œæç¤ºé˜»æ­¢åˆ é™¤çš„æ¨¡å‹
3. **ç»Ÿä¸€ä¸­æ–‡æç¤º + æ¨¡å‹/å­—æ®µ/æ“ä½œä¿¡æ¯**
4. å¯ç›´æ¥æ‰©å±• **æ‰¹é‡æ“ä½œã€æ›´æ–°æ“ä½œ**

------

æ˜ç™½äº†ï¼Œä½ å¸Œæœ›æœ€ç»ˆç‰ˆæœ¬æ˜¯ **å®Œå…¨è‡ªåŠ¨åŒ–ã€é›¶æ‰‹åŠ¨è£…é¥°å™¨**ï¼Œèƒ½åšåˆ°ï¼š

- åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤æ—¶ **æ‰€æœ‰å¸¸è§æ•°æ®åº“çº¦æŸé”™è¯¯** éƒ½èƒ½è‡ªåŠ¨æ•è·
- è‡ªåŠ¨è¿”å›ä¸­æ–‡æç¤º
- è‡ªåŠ¨æ¨æ–­ **å‡ºé”™æ¨¡å‹ã€å­—æ®µã€æ“ä½œç±»å‹**
- å¤–é”®çº¦æŸå¯¼è‡´åˆ é™¤å¤±è´¥æ—¶ï¼Œè¿”å›å¼•ç”¨æ¨¡å‹å’Œå­—æ®µ
- å”¯ä¸€çº¦æŸã€éç©ºçº¦æŸã€ç±»å‹é”™è¯¯ã€æ•°æ®é•¿åº¦é”™è¯¯ç­‰åˆ›å»º/æ›´æ–°é”™è¯¯ä¹Ÿèƒ½è¿”å›

æˆ‘å¸®ä½ è®¾è®¡ä¸€ä¸ª **é€šç”¨å‡½æ•° + é«˜é˜¶è£…é¥°å™¨ + ORM è‡ªåŠ¨è¿½è¸ª** æ–¹æ¡ˆï¼š

------

### 1ï¸âƒ£ æ ¸å¿ƒæ€è·¯

1. **QuerySet/Model å°è£…**ï¼šç”¨è£…é¥°å™¨åŒ…è£… ORM æ–¹æ³•ï¼ˆcreateã€updateã€deleteã€save ç­‰ï¼‰
2. **è‡ªåŠ¨æ¨æ–­æ¨¡å‹å**ï¼šé€šè¿‡å¯¹è±¡ `_meta.model_name` æˆ– QuerySet æ¨¡å‹
3. **å­—æ®µè¿½è¸ª**ï¼šè·å–æ“ä½œæ•°æ®çš„å­—æ®µ
4. **å¼‚å¸¸è§£æ**ï¼š
   - `IntegrityError` â†’ å”¯ä¸€ã€éç©ºã€å¤–é”®çº¦æŸ
   - `DataError` â†’ ç±»å‹æˆ–é•¿åº¦ä¸åŒ¹é…
   - `ValidationError` â†’ æ¨¡å‹å­—æ®µéªŒè¯
5. **ç»Ÿä¸€è¿”å›å­—å…¸**ï¼š`{error, model, fields, operation}`

------

### 2ï¸âƒ£ å®Œæ•´ç¤ºä¾‹

```python
import re
from functools import wraps
from django.db import IntegrityError, DataError
from django.core.exceptions import ValidationError, ObjectDoesNotExist, PermissionDenied
from django.apps import apps

# æ•°æ®åº“è¡¨å -> Django æ¨¡å‹æ˜ å°„
TABLE_MODEL_MAP = {m._meta.db_table: m.__name__ for m in apps.get_models()}

# å¼‚å¸¸ä¸­æ–‡æ˜ å°„
ERROR_TRANSLATIONS = {
    "ValueError": "å€¼é”™è¯¯ï¼šè¾“å…¥å€¼ä¸åˆæ³•",
    "TypeError": "ç±»å‹é”™è¯¯ï¼šæ“ä½œæˆ–å‡½æ•°çš„ç±»å‹ä¸åŒ¹é…",
    "KeyError": "é”®é”™è¯¯ï¼šå­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®",
    "PermissionDenied": "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ",
    "ValidationError": "æ•°æ®éªŒè¯é”™è¯¯",
    "DoesNotExist": "æ•°æ®ä¸å­˜åœ¨",
    "IntegrityError": "æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯",
    "DataError": "æ•°æ®åº“å­—æ®µæ•°æ®é”™è¯¯",
}

# IntegrityError å¸¸è§æ¨¡å¼
INTEGRITY_PATTERNS = {
    r"FOREIGN KEY constraint failed": "å¤–é”®çº¦æŸå¤±è´¥",
    r"NOT NULL constraint failed: (.+?)\.(.+)": "éç©ºçº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
    r"UNIQUE constraint failed: (.+?)\.(.+)": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
}

def parse_integrity_error(exc):
    msg = str(exc)
    for pattern, desc in INTEGRITY_PATTERNS.items():
        m = re.search(pattern, msg)
        if m:
            if "{table}" in desc:
                table, field = m.groups()
                model_name = TABLE_MODEL_MAP.get(table, table)
                return desc.format(table=model_name, field=field), model_name, [field]
            return desc, None, None
    return msg, None, None

def parse_foreign_key_error(exc):
    msg = str(exc)
    m = re.search(r'violates foreign key constraint "(.+?)" on table "(.+?)"', msg)
    if m:
        _, referencing_table = m.groups()
        return TABLE_MODEL_MAP.get(referencing_table, referencing_table)
    if "FOREIGN KEY constraint failed" in msg:
        return "æœªçŸ¥å¼•ç”¨æ¨¡å‹"
    return None

def orm_auto(func):
    """
    é«˜é˜¶è£…é¥°å™¨ï¼šè‡ªåŠ¨æ•è· ORM å¼‚å¸¸å¹¶è¿”å›ä¸­æ–‡æç¤º
    """
    @wraps(func)
    def wrapper(*args, **kwargs):
        # å°è¯•è‡ªåŠ¨è·å–æ“ä½œæ¨¡å‹å’Œå­—æ®µ
        instance = kwargs.get("instance", None)
        model_name = None
        fields = None
        operation = None

        if instance:
            model_name = instance._meta.model_name.capitalize()
            fields = list(kwargs.get("data", {}).keys()) if kwargs.get("data") else None

        # å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Model å®ä¾‹
        elif args and hasattr(args[0], "_meta"):
            instance = args[0]
            model_name = instance._meta.model_name.capitalize()
            fields = list(kwargs.get("data", {}).keys()) if kwargs.get("data") else None

        # åˆ¤æ–­æ“ä½œç±»å‹
        if func.__name__ in ["create", "save"]:
            operation = "create/update"
        elif func.__name__ in ["delete"]:
            operation = "delete"

        try:
            return func(*args, **kwargs)
        except Exception as exc:
            error_type = type(exc).__name__
            message = ERROR_TRANSLATIONS.get(error_type, str(exc))

            # IntegrityError
            if isinstance(exc, IntegrityError):
                fk_model = parse_foreign_key_error(exc)
                if fk_model and operation == "delete":
                    message = f"æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ '{fk_model}' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚"
                    model_name = fk_model
                else:
                    msg, m_name, flds = parse_integrity_error(exc)
                    message = msg
                    if m_name:
                        model_name = m_name
                    if flds:
                        fields = flds

            # DataError
            elif isinstance(exc, DataError):
                message = f"æ•°æ®é”™è¯¯ï¼š{exc}"

            # ValidationError
            elif isinstance(exc, ValidationError):
                message = f"æ•°æ®éªŒè¯é”™è¯¯: {exc}"

            # ObjectDoesNotExist
            elif isinstance(exc, ObjectDoesNotExist):
                if model_name:
                    message = f"{model_name} æ•°æ®ä¸å­˜åœ¨"
                else:
                    message = "æ•°æ®ä¸å­˜åœ¨"

            # PermissionDenied
            elif isinstance(exc, PermissionDenied):
                message = "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ"

            return {
                "error": message,
                "model": model_name,
                "fields": fields,
                "operation": operation
            }
    return wrapper
```

------

### 3ï¸âƒ£ ä½¿ç”¨ç¤ºä¾‹

```python
from myapp.models import User, Profile

@orm_auto
def create_user(data):
    return User.objects.create(**data)

@orm_auto
def update_user(instance, data):
    for k, v in data.items():
        setattr(instance, k, v)
    instance.save()

@orm_auto
def delete_user(instance):
    instance.delete()
```

------

### 4ï¸âƒ£ è°ƒç”¨ç¤ºä¾‹

```python
result = create_user({"email": "test@example.com", "name": "Test"})
if result and "error" in result:
    print(result)
```

**è¾“å‡ºç¤ºä¾‹ï¼ˆå”¯ä¸€çº¦æŸé”™è¯¯ï¼‰**ï¼š

```json
{
    "error": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ User, å­—æ®µ email",
    "model": "User",
    "fields": ["email"],
    "operation": "create/update"
}
```

**åˆ é™¤æ—¶å¤–é”®çº¦æŸé”™è¯¯**ï¼š

```json
{
    "error": "æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ 'Profile' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚",
    "model": "Profile",
    "fields": null,
    "operation": "delete"
}
```

------

âœ… ç‰¹ç‚¹ï¼š

- **é›¶æ‰‹åŠ¨è£…é¥°å™¨**ï¼ˆåªéœ€è¦è£…é¥° ORM å‡½æ•°å³å¯ï¼‰
- **è‡ªåŠ¨è§£æåˆ›å»º/æ›´æ–°/åˆ é™¤çº¦æŸé”™è¯¯**
- **å¤–é”®ã€å”¯ä¸€ã€éç©ºã€æ•°æ®ç±»å‹é•¿åº¦ã€éªŒè¯é”™è¯¯**å‡æ”¯æŒ
- è¿”å›ç»Ÿä¸€å­—å…¸ï¼Œå‰ç«¯å‹å¥½æ˜¾ç¤º

------

æ˜ç™½ï¼Œæˆ‘ç»™ä½ è®¾è®¡ä¸€ä¸ª **å®Œå…¨è‡ªåŠ¨åŒ–çš„ ORM å¼‚å¸¸æ•è·æ–¹æ¡ˆ**ï¼Œç‰¹ç‚¹ï¼š

- **æ— éœ€è£…é¥°å™¨**ï¼Œç›´æ¥å¯¹ä»»æ„ Django Model çš„ `create`/`save`/`delete`/`update` è‡ªåŠ¨æ•è·å¼‚å¸¸
- æ”¯æŒ **å¢åˆ æ”¹æŸ¥**
- è¿”å›ç»Ÿä¸€ **å­—å…¸æ ¼å¼**ï¼š`errorï¼ˆä¸­æ–‡æç¤ºï¼‰`ã€`modelï¼ˆæ¨¡å‹åï¼‰`ã€`fieldsï¼ˆå­—æ®µï¼‰`ã€`operationï¼ˆæ“ä½œç±»å‹ï¼‰`
- è‡ªåŠ¨è§£æ **å¤–é”®çº¦æŸã€å”¯ä¸€çº¦æŸã€éç©ºçº¦æŸã€æ•°æ®ç±»å‹çº¦æŸã€éªŒè¯é”™è¯¯**

------

### 1ï¸âƒ£ è‡ªåŠ¨åŒ– ORM æ•è·å·¥å…·

```python
import re
from django.db import models, IntegrityError, DataError
from django.core.exceptions import ValidationError, ObjectDoesNotExist, PermissionDenied
from django.apps import apps

# æ•°æ®åº“è¡¨å -> Django æ¨¡å‹æ˜ å°„
TABLE_MODEL_MAP = {m._meta.db_table: m.__name__ for m in apps.get_models()}

# å¼‚å¸¸ä¸­æ–‡æ˜ å°„
ERROR_TRANSLATIONS = {
    "ValueError": "å€¼é”™è¯¯ï¼šè¾“å…¥å€¼ä¸åˆæ³•",
    "TypeError": "ç±»å‹é”™è¯¯ï¼šæ“ä½œæˆ–å‡½æ•°çš„ç±»å‹ä¸åŒ¹é…",
    "KeyError": "é”®é”™è¯¯ï¼šå­—å…¸ä¸­ä¸å­˜åœ¨æŒ‡å®šé”®",
    "PermissionDenied": "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ",
    "ValidationError": "æ•°æ®éªŒè¯é”™è¯¯",
    "DoesNotExist": "æ•°æ®ä¸å­˜åœ¨",
    "IntegrityError": "æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯",
    "DataError": "æ•°æ®åº“å­—æ®µæ•°æ®é”™è¯¯",
}

# å¸¸è§ IntegrityError æ¨¡å¼
INTEGRITY_PATTERNS = {
    r"FOREIGN KEY constraint failed": "å¤–é”®çº¦æŸå¤±è´¥",
    r"NOT NULL constraint failed: (.+?)\.(.+)": "éç©ºçº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
    r"UNIQUE constraint failed: (.+?)\.(.+)": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ {table}, å­—æ®µ {field}",
}

def parse_integrity_error(exc):
    msg = str(exc)
    for pattern, desc in INTEGRITY_PATTERNS.items():
        m = re.search(pattern, msg)
        if m:
            if "{table}" in desc:
                table, field = m.groups()
                model_name = TABLE_MODEL_MAP.get(table, table)
                return desc.format(table=model_name, field=field), model_name, [field]
            return desc, None, None
    return msg, None, None

def parse_foreign_key_error(exc):
    msg = str(exc)
    # PostgreSQL é£æ ¼
    m = re.search(r'violates foreign key constraint "(.+?)" on table "(.+?)"', msg)
    if m:
        _, referencing_table = m.groups()
        return TABLE_MODEL_MAP.get(referencing_table, referencing_table)
    # SQLite/MySQL é£æ ¼
    if "FOREIGN KEY constraint failed" in msg:
        return "æœªçŸ¥å¼•ç”¨æ¨¡å‹"
    return None

# è‡ªåŠ¨å¼‚å¸¸å¤„ç†å‡½æ•°
def handle_orm_operation(func, *args, **kwargs):
    """
    func: å®é™… ORM æ“ä½œå‡½æ•°ï¼Œå¦‚ obj.save, Model.objects.create, obj.delete
    è‡ªåŠ¨æ•è·å¼‚å¸¸å¹¶è¿”å›ç»Ÿä¸€å­—å…¸
    """
    model_name = None
    fields = None
    operation = None

    # å°è¯•è·å–æ“ä½œå¯¹è±¡å’Œå­—æ®µ
    instance = kwargs.get("instance", None)
    data = kwargs.get("data", None)

    if instance and hasattr(instance, "_meta"):
        model_name = instance._meta.model_name.capitalize()
        fields = list(data.keys()) if data else None
    elif args and hasattr(args[0], "_meta"):
        instance = args[0]
        model_name = instance._meta.model_name.capitalize()
        fields = list(data.keys()) if data else None

    # åˆ¤æ–­æ“ä½œç±»å‹
    op_name = func.__name__.lower()
    if op_name in ["create", "save"]:
        operation = "create/update"
    elif op_name in ["delete"]:
        operation = "delete"
    else:
        operation = op_name

    try:
        return func(*args, **kwargs)
    except Exception as exc:
        message = ERROR_TRANSLATIONS.get(type(exc).__name__, str(exc))

        if isinstance(exc, IntegrityError):
            fk_model = parse_foreign_key_error(exc)
            if fk_model and operation == "delete":
                message = f"æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ '{fk_model}' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚"
                model_name = fk_model
            else:
                msg, m_name, flds = parse_integrity_error(exc)
                message = msg
                if m_name:
                    model_name = m_name
                if flds:
                    fields = flds

        elif isinstance(exc, DataError):
            message = f"æ•°æ®é”™è¯¯ï¼š{exc}"

        elif isinstance(exc, ValidationError):
            message = f"æ•°æ®éªŒè¯é”™è¯¯: {exc}"

        elif isinstance(exc, ObjectDoesNotExist):
            message = f"{model_name or 'æ•°æ®'}ä¸å­˜åœ¨"

        elif isinstance(exc, PermissionDenied):
            message = "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ"

        return {
            "error": message,
            "model": model_name,
            "fields": fields,
            "operation": operation
        }
```

------

### 2ï¸âƒ£ ä½¿ç”¨æ–¹æ³•

```python
from myapp.models import User, Profile

# åˆ›å»º
result = handle_orm_operation(User.objects.create, email="test@example.com", name="Test")
if "error" in result:
    print(result)

# æ›´æ–°
user = User.objects.get(id=1)
result = handle_orm_operation(user.save)
if "error" in result:
    print(result)

# åˆ é™¤
profile = Profile.objects.get(id=10)
result = handle_orm_operation(profile.delete)
if "error" in result:
    print(result)
```

------

### 3ï¸âƒ£ å¢åˆ æ”¹æŸ¥å‡ºé”™ç¤ºä¾‹è¿”å›ä¿¡æ¯

| æ“ä½œ      | é”™è¯¯ç±»å‹           | è¿”å›ä¿¡æ¯                                                     |
| --------- | ------------------ | ------------------------------------------------------------ |
| åˆ›å»º      | å”¯ä¸€çº¦æŸå¤±è´¥       | `{"error": "å”¯ä¸€çº¦æŸå¤±è´¥: è¡¨ User, å­—æ®µ email", "model": "User", "fields": ["email"], "operation": "create/update"}` |
| åˆ›å»º/æ›´æ–° | éç©ºçº¦æŸå¤±è´¥       | `{"error": "éç©ºçº¦æŸå¤±è´¥: è¡¨ User, å­—æ®µ name", "model": "User", "fields": ["name"], "operation": "create/update"}` |
| åˆ›å»º/æ›´æ–° | æ•°æ®ç±»å‹æˆ–é•¿åº¦é”™è¯¯ | `{"error": "æ•°æ®é”™è¯¯ï¼švalue too long for type varchar", "model": "User", "fields": ["email"], "operation": "create/update"}` |
| åˆ é™¤      | å¤–é”®çº¦æŸå¤±è´¥       | `{"error": "æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ 'Profile' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚", "model": "Profile", "fields": null, "operation": "delete"}` |
| æŸ¥è¯¢/æ›´æ–° | å¯¹è±¡ä¸å­˜åœ¨         | `{"error": "User æ•°æ®ä¸å­˜åœ¨", "model": "User", "fields": null, "operation": "update"}` |
| æƒé™ä¸è¶³  | PermissionDenied   | `{"error": "æƒé™ä¸è¶³ï¼šæ‚¨æ— æƒæ‰§è¡Œæ­¤æ“ä½œ", "model": null, "fields": null, "operation": null}` |
| éªŒè¯é”™è¯¯  | ValidationError    | `{"error": "æ•°æ®éªŒè¯é”™è¯¯: [å…·ä½“éªŒè¯é”™è¯¯ä¿¡æ¯]", "model": "User", "fields": ["email"], "operation": "create/update"}` |

------

è¿™ä¸ªæ–¹æ¡ˆ **å®Œå…¨é›¶æ”¹åŠ¨**ï¼š

- ä½ åªéœ€è¦è°ƒç”¨ `handle_orm_operation` åŒ…è£¹ä½ çš„ ORM æ–¹æ³•
- æ‰€æœ‰å¢åˆ æ”¹æŸ¥å¼‚å¸¸éƒ½ä¼šè‡ªåŠ¨è¿”å› **ä¸­æ–‡æç¤º + æ¨¡å‹ + å­—æ®µ + æ“ä½œç±»å‹**
- æ”¯æŒ **å¤–é”®çº¦æŸã€å”¯ä¸€çº¦æŸã€éç©ºçº¦æŸã€æ•°æ®ç±»å‹é”™è¯¯ã€éªŒè¯é”™è¯¯ã€æƒé™é”™è¯¯**

------

å®Œå…¨å¯ä»¥ï¼Œè€Œä¸”è¿™æ˜¯å¾ˆå¤šå›¢é˜Ÿé‡åˆ°çš„é—®é¢˜ï¼šDjango/æ•°æ®åº“è¿”å›çš„æŠ¥é”™ä¿¡æ¯é‡Œï¼Œå¾ˆå¤šéƒ½æ˜¯è‹±æ–‡åŸå§‹ä¿¡æ¯ï¼Œç›´æ¥è¿”å›å‰ç«¯ä¸å¤Ÿå‹å¥½ã€‚æˆ‘ä»¬å¯ä»¥åš **äºŒæ¬¡è§£æ**ï¼ŒæŠŠå¸¸è§çš„åˆ›å»º/æ›´æ–°é”™è¯¯å®Œå…¨è½¬æ¢æˆä¸­æ–‡ï¼Œå¹¶æŒ‡å‡º **å­—æ®µã€çº¦æŸç±»å‹ã€æ“ä½œå»ºè®®**ã€‚

ä¸‹é¢æˆ‘å¸®ä½ ä¼˜åŒ– `handle_orm_operation`ï¼Œé’ˆå¯¹ **åˆ›å»º/æ›´æ–°æ“ä½œ**ï¼Œå¯¹å¸¸è§é”™è¯¯ï¼ˆå”¯ä¸€çº¦æŸã€éç©ºã€ç±»å‹ã€é•¿åº¦ã€éªŒè¯é”™è¯¯ï¼‰åšæ›´æ¸…æ™°çš„ä¸­æ–‡æç¤ºï¼š

------

### 1ï¸âƒ£ ä¼˜åŒ–åçš„å¼‚å¸¸è§£æå‡½æ•°

```python
def parse_create_update_error(exc, model_name=None, data_fields=None):
    """
    ä¸“é—¨è§£æåˆ›å»º/æ›´æ–°æ—¶çš„å¼‚å¸¸ï¼Œè¿”å›ä¸­æ–‡æç¤º + å—å½±å“å­—æ®µ
    """
    msg = str(exc)
    fields = data_fields

    # IntegrityError
    if isinstance(exc, IntegrityError):
        # å¤–é”®çº¦æŸï¼ˆä¸€èˆ¬æ›´æ–°æ—¶è§¦å‘ï¼‰
        fk_model = parse_foreign_key_error(exc)
        if fk_model:
            return f"æ“ä½œå¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ '{fk_model}' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚", [fk_model]

        # å”¯ä¸€çº¦æŸ
        m = re.search(r"UNIQUE constraint failed: (.+?)\.(.+)", msg)
        if m:
            table, field = m.groups()
            model = TABLE_MODEL_MAP.get(table, table)
            return f"å”¯ä¸€çº¦æŸå¤±è´¥ï¼šæ¨¡å‹ '{model}' çš„å­—æ®µ '{field}' å·²å­˜åœ¨ç›¸åŒå€¼ï¼Œè¯·ä¿®æ”¹åé‡è¯•ã€‚", [field]

        # éç©ºçº¦æŸ
        m = re.search(r"NOT NULL constraint failed: (.+?)\.(.+)", msg)
        if m:
            table, field = m.groups()
            model = TABLE_MODEL_MAP.get(table, table)
            return f"éç©ºçº¦æŸå¤±è´¥ï¼šæ¨¡å‹ '{model}' çš„å­—æ®µ '{field}' ä¸èƒ½ä¸ºç©ºï¼Œè¯·å¡«å†™å€¼åé‡è¯•ã€‚", [field]

        # é»˜è®¤
        return f"æ•°æ®åº“å®Œæ•´æ€§é”™è¯¯: {msg}", fields

    # DataError æ•°æ®ç±»å‹/é•¿åº¦é”™è¯¯
    elif isinstance(exc, DataError):
        return f"æ•°æ®ç±»å‹æˆ–é•¿åº¦é”™è¯¯: {msg}", fields

    # ValidationError æ¨¡å‹éªŒè¯
    elif isinstance(exc, ValidationError):
        error_list = []
        if hasattr(exc, "message_dict"):
            for k, v in exc.message_dict.items():
                error_list.append(f"å­—æ®µ '{k}': {','.join(v)}")
            return f"æ•°æ®éªŒè¯é”™è¯¯: {'; '.join(error_list)}", list(exc.message_dict.keys())
        return f"æ•°æ®éªŒè¯é”™è¯¯: {msg}", fields

    # é»˜è®¤
    return f"æ“ä½œå¤±è´¥: {msg}", fields
```

------

### 2ï¸âƒ£ åœ¨ `handle_orm_operation` ä¸­è°ƒç”¨

```python
def handle_orm_operation(func, *args, **kwargs):
    model_name = None
    fields = None
    operation = None

    # å°è¯•è·å–å¯¹è±¡å’Œå­—æ®µ
    instance = kwargs.get("instance", None)
    data = kwargs.get("data", None)

    if instance and hasattr(instance, "_meta"):
        model_name = instance._meta.model_name.capitalize()
        fields = list(data.keys()) if data else None
    elif args and hasattr(args[0], "_meta"):
        instance = args[0]
        model_name = instance._meta.model_name.capitalize()
        fields = list(data.keys()) if data else None

    op_name = func.__name__.lower()
    if op_name in ["create", "save"]:
        operation = "create/update"
    elif op_name in ["delete"]:
        operation = "delete"
    else:
        operation = op_name

    try:
        return func(*args, **kwargs)
    except Exception as exc:
        if operation == "create/update":
            message, affected_fields = parse_create_update_error(exc, model_name, fields)
        elif operation == "delete":
            fk_model = parse_foreign_key_error(exc)
            if fk_model:
                message = f"åˆ é™¤å¤±è´¥ï¼šå­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ¨¡å‹ '{fk_model}' ä¸­æœ‰æ•°æ®å¼•ç”¨è¯¥å¯¹è±¡ï¼Œè¯·å…ˆåˆ é™¤æˆ–è§£é™¤ä¾èµ–ã€‚"
                affected_fields = None
                model_name = fk_model
            else:
                message, affected_fields = parse_integrity_error(exc)
        else:
            message = str(exc)
            affected_fields = fields

        return {
            "error": message,
            "model": model_name,
            "fields": affected_fields,
            "operation": operation
        }
```

------

### 3ï¸âƒ£ ç¤ºä¾‹è¾“å‡ºï¼ˆæ›´ä¸­æ–‡åŒ–ï¼‰

#### å”¯ä¸€çº¦æŸé”™è¯¯

```json
{
    "error": "å”¯ä¸€çº¦æŸå¤±è´¥ï¼šæ¨¡å‹ 'User' çš„å­—æ®µ 'email' å·²å­˜åœ¨ç›¸åŒå€¼ï¼Œè¯·ä¿®æ”¹åé‡è¯•ã€‚",
    "model": "User",
    "fields": ["email"],
    "operation": "create/update"
}
```

#### éç©ºçº¦æŸé”™è¯¯

```json
{
    "error": "éç©ºçº¦æŸå¤±è´¥ï¼šæ¨¡å‹ 'User' çš„å­—æ®µ 'name' ä¸èƒ½ä¸ºç©ºï¼Œè¯·å¡«å†™å€¼åé‡è¯•ã€‚",
    "model": "User",
    "fields": ["name"],
    "operation": "create/update"
}
```

#### éªŒè¯é”™è¯¯

```json
{
    "error": "æ•°æ®éªŒè¯é”™è¯¯: å­—æ®µ 'email': è¯·è¾“å…¥æœ‰æ•ˆé‚®ç®±åœ°å€",
    "model": "User",
    "fields": ["email"],
    "operation": "create/update"
}
```

#### æ•°æ®ç±»å‹æˆ–é•¿åº¦é”™è¯¯

```json
{
    "error": "æ•°æ®ç±»å‹æˆ–é•¿åº¦é”™è¯¯: value too long for type varchar",
    "model": "User",
    "fields": ["email"],
    "operation": "create/update"
}
```

------

âœ… è¿™æ ·å°±å®Œå…¨è§£å†³äº† **è‹±æ–‡åŸå§‹ä¿¡æ¯å¤ªæ™¦æ¶©** çš„é—®é¢˜ï¼š

- è‡ªåŠ¨æŠŠ **å”¯ä¸€çº¦æŸã€éç©ºçº¦æŸã€å¤–é”®çº¦æŸã€éªŒè¯é”™è¯¯ã€æ•°æ®ç±»å‹é”™è¯¯** è½¬æˆæ¸…æ™°ä¸­æ–‡
- å‘Šè¯‰ç”¨æˆ· **å“ªä¸ªæ¨¡å‹ã€å“ªä¸ªå­—æ®µ** å‡ºé”™
- ç»™å‡º **æ“ä½œå»ºè®®**ï¼Œæ¯”å¦‚ä¿®æ”¹å­—æ®µã€å¡«å†™å€¼æˆ–å…ˆåˆ é™¤ä¾èµ–æ•°æ®

------

