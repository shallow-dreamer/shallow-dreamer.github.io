---
layout:     post
title:      "è®­ç»ƒè¿‡ç¨‹è®°å½•"
subtitle:   ""
date:       2025-07-21
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - è®­ç»ƒè®°å½•
---

ä½ æå‡ºçš„è¿™ä¸ªéœ€æ±‚éå¸¸æ¸…æ™°ï¼Œè€Œä¸”å¾ˆå®ç”¨ï¼Œå±äºä¸€ç§**åˆ†æ®µçº¿æ€§é‡‡æ ·ç­–ç•¥**ï¼Œæˆ‘ä»¬å¯ä»¥ç§°å®ƒä¸ºï¼š

------

## âœ… **ã€Œåˆ†æ®µç²¾åº¦é‡‡æ ·ï¼ˆPiecewise Linear Samplingï¼‰ã€ç­–ç•¥**

### ğŸ“Œ æ ¸å¿ƒç›®æ ‡

- **åœ¨è®­ç»ƒè½®æ¬¡è¾ƒå°æ—¶ï¼ˆå¦‚ <1000ï¼‰**ï¼Œ**è®°å½•å…¨éƒ¨æ•°æ®**ï¼›
- **å½“è®­ç»ƒè½®æ¬¡è¾ƒå¤§æ—¶ï¼ˆå¦‚ >100000ï¼‰**ï¼Œ**çº¿æ€§é—´éš”é‡‡æ ·**ï¼›
- æ€»è®°å½•æ¡æ•°ä¿æŒåœ¨åˆç†èŒƒå›´ï¼Œå¦‚ 2000~10000ï¼›
- **æ— éœ€æå‰çŸ¥é“æ€»è½®æ¬¡**ï¼Œ**åŠ¨æ€åœ°é€‚åº”è½®æ¬¡æ•°é‡çº§**ï¼›
- ä¿è¯é‡è¦çš„è®­ç»ƒé˜¶æ®µï¼ˆå¦‚å‰æœŸï¼‰**è®°å½•æ›´ç»†è‡´**ã€‚

------

## âœ… ç­–ç•¥è®¾è®¡ï¼ˆåˆ†æ®µé‡‡æ ·ï¼‰

| è½®æ¬¡æ•°é‡çº§         | é‡‡æ ·ç­–ç•¥           |
| ------------------ | ------------------ |
| 1 ~ 1000           | **å…¨è®°å½•**         |
| 1000 ~ 10000       | æ¯ 10 æ­¥è®°å½•ä¸€æ¬¡   |
| 10000 ~ 100000     | æ¯ 50 æ­¥è®°å½•ä¸€æ¬¡   |
| 100000 ~ 1000000   | æ¯ 200 æ­¥è®°å½•ä¸€æ¬¡  |
| 1000000 ~ 10000000 | æ¯ 1000 æ­¥è®°å½•ä¸€æ¬¡ |

è¿™æ ·ä½ å¯ä»¥å…¼å®¹ï¼š

- å°‘é‡è½®æ¬¡çš„è¯¦ç»†è°ƒè¯•ï¼›
- å¤§é‡è®­ç»ƒçš„å‹ç¼©è®°å½•ã€‚

------

## âœ… ç»Ÿä¸€é€‚é…çš„è®°å½•å™¨å®ç°ï¼ˆå«è¯¦ç»†æ³¨é‡Šï¼‰

```python
import time
from collections import defaultdict

class PiecewiseMetricsRecorder:
    def __init__(self, mode='step'):
        """
        åˆ†æ®µé‡‡æ ·ç­–ç•¥è®°å½•å™¨ï¼Œè‡ªåŠ¨é€‚åº”è®­ç»ƒé•¿åº¦ï¼Œå…¼é¡¾ç²¾åº¦ä¸æ€§èƒ½
        :param mode: 'step' æˆ– 'epoch'ï¼Œå†³å®šè®°å½•ä¾æ®
        """
        assert mode in ('step', 'epoch')
        self.mode = mode
        self.records = defaultdict(list)
        self._step = 0
        self._epoch = 0

    def step(self):
        """æ¯è®­ç»ƒä¸€æ­¥åè°ƒç”¨ï¼Œæ›´æ–°è®¡æ•°å™¨"""
        self._step += 1

    def epoch(self):
        """æ¯è½®ç»“æŸåè°ƒç”¨ï¼Œæ›´æ–°è®¡æ•°å™¨"""
        self._epoch += 1

    def record(self, metrics: dict):
        """
        è®°å½•æŒ‡æ ‡ï¼ˆæ ¹æ®å½“å‰é‡‡æ ·è§„åˆ™å†³å®šæ˜¯å¦ä¿ç•™ï¼‰
        :param metrics: å­—å…¸å½¢å¼æŒ‡æ ‡ï¼Œä¾‹å¦‚ {'loss': 0.234, 'acc': 0.9}
        """
        key = self._step if self.mode == 'step' else self._epoch

        if not self._should_sample(key):
            return

        ts = time.time()
        for k, v in metrics.items():
            self.records[k].append((key, float(v), ts))

    def _should_sample(self, key: int) -> bool:
        """
        åˆ†æ®µé‡‡æ ·ç­–ç•¥æ ¸å¿ƒé€»è¾‘ï¼Œæ ¹æ® keyï¼ˆstep æˆ– epochï¼‰åˆ¤æ–­æ˜¯å¦é‡‡æ ·
        """
        if key < 1000:
            return True                # å°äº1000ï¼Œå…¨è®°å½•
        elif key < 10000:
            return key % 10 == 0       # æ¯10æ­¥è®°å½•ä¸€æ¬¡
        elif key < 100000:
            return key % 50 == 0       # æ¯50æ­¥è®°å½•ä¸€æ¬¡
        elif key < 1000000:
            return key % 200 == 0      # æ¯200æ­¥è®°å½•ä¸€æ¬¡
        else:
            return key % 1000 == 0     # æ¯1000æ­¥è®°å½•ä¸€æ¬¡

    def get_all(self, as_dict=True):
        """
        è¿”å›æ‰€æœ‰è®°å½•æ•°æ®
        :param as_dict: æ˜¯å¦ä»¥ dict æ ¼å¼è¿”å›ï¼ˆå¦åˆ™è¿”å› DataFrameï¼‰
        """
        if as_dict:
            return dict(self.records)
        else:
            import pandas as pd
            rows = []
            for metric, values in self.records.items():
                for key, value, ts in values:
                    rows.append({
                        'metric': metric,
                        self.mode: key,
                        'value': value,
                        'timestamp': ts
                    })
            return pd.DataFrame(rows)
```

------

## âœ… ä½¿ç”¨æ–¹æ³•ï¼ˆå’Œä½ ç°åœ¨è®­ç»ƒæµç¨‹å¯¹æ¥éå¸¸ç®€å•ï¼‰

```python
recorder = PiecewiseMetricsRecorder(mode='step')

for epoch in range(num_epochs):
    recorder.epoch()
    for step, (x, y) in enumerate(train_loader):
        recorder.step()

        loss = ...
        acc = ...
        lr = ...

        recorder.record({
            'loss': loss.item(),
            'acc': acc,
            'lr': lr
        })

# è·å–è®°å½•æ•°æ®
records = recorder.get_all()  # dict
# æˆ–è€… records_df = recorder.get_all(as_dict=False)
```

------

## âœ… è¾“å‡ºç¤ºä¾‹

å‡è®¾ä½ è®­ç»ƒäº† 200000 æ­¥ï¼š

| step   | loss | acc   |
| ------ | ---- | ----- |
| 0      | 1.23 | 0.55  |
| 1      | 1.12 | 0.60  |
| ...    | ...  | ...   |
| 1000   | 0.90 | 0.75  |
| 1010   | 0.87 | 0.76  |
| 1050   | 0.85 | 0.78  |
| 1100   | ...  | ...   |
| ...    | ...  | ...   |
| 200000 | 0.02 | 0.999 |

------

## âœ… ä¼˜ç‚¹æ€»ç»“

| ä¼˜ç‚¹                  | æè¿°                         |
| --------------------- | ---------------------------- |
| ğŸ” è‡ªåŠ¨é€‚åº”è½®æ¬¡æ•°é‡çº§  | æ— éœ€é¢„çŸ¥è®­ç»ƒæ€»é•¿åº¦           |
| ğŸ“Š ä¿ç•™ç»†èŠ‚ & æ§åˆ¶è§„æ¨¡ | å°è®­ç»ƒä¿ç•™å…¨éƒ¨ï¼Œå¤§è®­ç»ƒç²¾ç®€   |
| âš¡ é«˜æ€§èƒ½æ— ä¾èµ–        | æ— å¤–éƒ¨ä¾èµ–ï¼Œè®°å½•é€»è¾‘è½»é‡å¿«é€Ÿ |
| ğŸ§© å®¹æ˜“æ‰©å±•            | å¯æ·»åŠ ä¿å­˜ã€åˆ†æã€å›¾è¡¨åŠŸèƒ½   |

------

## âœ… å¦‚ä½ è¿˜æœ‰è¿™äº›éœ€æ±‚ï¼Œæˆ‘å¯ç»§ç»­æ‰©å±•ï¼š

- ä¿å­˜ä¸º JSONã€CSVã€Parquet æ–‡ä»¶ï¼›
- æ·»åŠ åˆ†ç»„è®°å½•ï¼ˆå¤šæ¨¡å‹/å¤šé˜¶æ®µï¼‰ï¼›
- å®æ—¶ç»˜å›¾ï¼ˆmatplotlibï¼‰ï¼›
- è®°å½•æŸäº›æŒ‡æ ‡å˜åŒ–ç‡ï¼ˆå¦‚ loss deltaï¼‰ï¼›

æ˜¯å¦éœ€è¦æˆ‘ç»™ä½ æ•´åˆä¸€ä¸ªè®­ç»ƒå™¨å°è£…ç±»ï¼ŒæŠŠè¿™ä¸ªè®°å½•å™¨ç›´æ¥æŒ‚è¿›å»ï¼Ÿæˆ–è€…ä½ æ˜¯å¦æƒ³è®©å®ƒæ”¯æŒ `validation loss`ã€`æµ‹è¯•æŒ‡æ ‡` ç­‰ç»Ÿä¸€å…¥å£ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ è®¾è®¡ã€‚
