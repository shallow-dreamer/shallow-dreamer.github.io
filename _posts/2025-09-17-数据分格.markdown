---
layout:     post
title:      "æ•°æ®åˆ†æ ¼"
subtitle:   ""
date:       2025-09-17
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - python
---

æœ‰ ğŸ‘ï¼Œè¿˜èƒ½å†å¿«ã€‚ä½ ç°åœ¨å…¶å®å·²ç»åˆ°äº† **O(N)** çš„å¤æ‚åº¦ï¼Œä¸éœ€è¦å†éå†åŸºå‡†ç‚¹æ•°ç»„äº†ã€‚ä½†æ˜¯è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

------

## è¿›ä¸€æ­¥ä¼˜åŒ–æ€è·¯

### 1. å»æ‰ `round` â†’ ç”¨æ•´æ•°è¿ç®—

æµ®ç‚¹æ•°è¿ç®—ï¼ˆç‰¹åˆ«æ˜¯ `round`ï¼‰æ¯”æ•´æ•°æ…¢ï¼Œå®¹æ˜“æœ‰ç²¾åº¦é—®é¢˜ã€‚å¯ä»¥ç›´æ¥æŠŠæ•°æ®ç¼©æ”¾æˆæ•´æ•°è¿ç®—ï¼š

å…¬å¼ï¼š

```text
nearest = step * round((x - min) / step)
```

å¦‚æœæŠŠæ•°æ®éƒ½æ”¾å¤§ `1/step` å€ï¼Œæ•´å‹è¿ç®—ä¼šæ›´å¿«ï¼š

```text
scale = 1 / step
nearest = (round((x - min) * scale) / scale) + min
```

ä¾‹å¦‚ï¼š
 `step=0.01 â†’ scale=100`ï¼Œ
 åªéœ€è¦å››èˆäº”å…¥åˆ°æœ€è¿‘çš„æ•´æ•°ï¼Œå†ç¼©æ”¾å›æ¥ã€‚

è¿™æ ·å¤§è§„æ¨¡æ•°æ®æ—¶é€Ÿåº¦ä¼šå¿«å¾ˆå¤šã€‚

------

### 2. NumPy æ•´æ•°å‘é‡åŒ–å®ç°

```python
import numpy as np

def ultra_fast_map(data, min_val, step, tol):
    data = np.asarray(data, dtype=np.float64)
    scale = 1.0 / step
    
    # æ•´æ•°åŒ–ï¼Œé¿å… round æµ®ç‚¹è¯¯å·®
    nearest = (np.rint((data - min_val) * scale) / scale) + min_val
    
    # å®¹å·®åˆ¤æ–­
    mask = np.abs(data - nearest) <= tol
    return np.where(mask, nearest, data)

# ç¤ºä¾‹
data = np.random.uniform(0, 4000, size=10**6)  # ä¸€ç™¾ä¸‡ä¸ªç‚¹
result = ultra_fast_map(data, 0, 0.01, 0.005)
```

è¿™ç§æ–¹æ³• **çº¯å‘é‡åŒ– + æ•´æ•°è¿ç®—**ï¼Œåœ¨ä¸€ç™¾ä¸‡æ•°æ®ç‚¹çº§åˆ«ä¸‹ï¼Œè¿è¡Œåªè¦å‡ åæ¯«ç§’ã€‚

------

### 3. æè‡´ä¼˜åŒ–ï¼ˆNumba / Cythonï¼‰

å¦‚æœæ•°æ®é‡ä¸Šäº¿ï¼Œç”¨ NumPy è¿˜ä¸å¤Ÿï¼Œå¯ä»¥ç”¨ **Numba JIT** ç¼–è¯‘æˆæœ¬åœ°ä»£ç ï¼š

```python
import numpy as np
from numba import njit

@njit
def numba_map(data, min_val, step, tol):
    n = data.shape[0]
    result = np.empty(n, dtype=np.float64)
    scale = 1.0 / step
    for i in range(n):
        x = data[i]
        nearest = round((x - min_val) * scale) / scale + min_val
        if abs(x - nearest) <= tol:
            result[i] = nearest
        else:
            result[i] = x
    return result
```

> `numba_map` å¯¹åƒä¸‡çº§æ•°æ®ä¹Ÿèƒ½åœ¨ç§’çº§è·‘å®Œã€‚

------

âœ… æ€»ç»“ï¼š

- **æœ€å¿«çº¯ Python æ–¹æ¡ˆ**ï¼š`ultra_fast_map`ï¼ˆæ•´æ•°å‘é‡åŒ– NumPyï¼‰ã€‚
- **æè‡´æ€§èƒ½**ï¼šNumba / Cython å†™å¾ªç¯ â†’ ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚

------

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª **ä¸‰ç§æ¨¡å¼**çš„æ¸…æ´—å‡½æ•°ï¼ˆ`"numpy" | "numba" | "cython"`ï¼‰ï¼Œè‡ªåŠ¨æ ¹æ®æ•°æ®é‡é€‰æ‹©æœ€å¿«çš„å®ç°ï¼Ÿ
