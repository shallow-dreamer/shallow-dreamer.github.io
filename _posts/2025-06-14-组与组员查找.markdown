---
layout:     post
title:      "ç»„ä¸ç»„å‘˜çš„æŸ¥æ‰¾"
subtitle:   ""
date:       2025-06-14
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - Django
    - pgsql
---

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Django å•å…ƒæµ‹è¯•ä»£ç ç¤ºä¾‹ï¼Œç”¨äºæµ‹è¯•ä½ è¿™ä¸ªâ€œæ‰¾å‡ºæ ‡ç­¾é›†åˆå®Œå…¨ä¸€è‡´çš„ `TagGroup`â€é€»è¾‘ï¼Œ**ä¸ä½¿ç”¨åŸç”Ÿ SQLï¼Œä»…ä½¿ç”¨ Django ORM**ï¼ˆä¾èµ– PostgreSQL çš„ `ArrayAgg`ï¼‰ã€‚

------

## âœ… æ¨¡å‹å‡è®¾ï¼ˆç”¨äºæµ‹è¯•ï¼‰

```python
# models.py
from django.db import models

class TagGroup(models.Model):
    name = models.CharField(max_length=100)

class TagDetail(models.Model):
    tag_group = models.ForeignKey(TagGroup, on_delete=models.CASCADE, related_name='details')
    name = models.CharField(max_length=100)
```

------

## âœ… æŸ¥è¯¢å‡½æ•°ï¼ˆéœ€å…ˆå¼•å…¥ï¼‰

```python
# utils.py æˆ– services.py
from django.db.models import ArrayAgg
from yourapp.models import TagGroup, TagDetail

def get_same_tag_groups(group_id):
    target_names = list(
        TagDetail.objects
        .filter(tag_group_id=group_id)
        .order_by('name')
        .values_list('name', flat=True)
    )

    if not target_names:
        return []

    groups = (
        TagGroup.objects
        .annotate(tag_names=ArrayAgg('details__name', ordering='details__name'))
        .filter(tag_names=target_names)
        .values_list('id', flat=True)
    )

    return list(groups)
```

------

## âœ… å•å…ƒæµ‹è¯•ä»£ç 

```python
# tests.py
from django.test import TestCase
from yourapp.models import TagGroup, TagDetail
from yourapp.utils import get_same_tag_groups

class TagGroupMatchingTest(TestCase):
    def setUp(self):
        # Group A: apple, banana
        self.group_a = TagGroup.objects.create(name='Group A')
        TagDetail.objects.bulk_create([
            TagDetail(tag_group=self.group_a, name='apple'),
            TagDetail(tag_group=self.group_a, name='banana'),
        ])

        # Group B: banana, apple (same as A but unordered)
        self.group_b = TagGroup.objects.create(name='Group B')
        TagDetail.objects.bulk_create([
            TagDetail(tag_group=self.group_b, name='banana'),
            TagDetail(tag_group=self.group_b, name='apple'),
        ])

        # Group C: apple only
        self.group_c = TagGroup.objects.create(name='Group C')
        TagDetail.objects.create(tag_group=self.group_c, name='apple')

        # Group D: apple, banana, cherry (extra tag)
        self.group_d = TagGroup.objects.create(name='Group D')
        TagDetail.objects.bulk_create([
            TagDetail(tag_group=self.group_d, name='apple'),
            TagDetail(tag_group=self.group_d, name='banana'),
            TagDetail(tag_group=self.group_d, name='cherry'),
        ])

    def test_matching_groups(self):
        matching_ids = get_same_tag_groups(self.group_a.id)
        expected_ids = {self.group_a.id, self.group_b.id}

        self.assertSetEqual(set(matching_ids), expected_ids)

    def test_no_match_for_partial(self):
        matching_ids = get_same_tag_groups(self.group_c.id)
        self.assertSetEqual(set(matching_ids), {self.group_c.id})

    def test_no_match_for_extra(self):
        matching_ids = get_same_tag_groups(self.group_d.id)
        self.assertSetEqual(set(matching_ids), {self.group_d.id})
```

------

## âœ… å¦‚ä½•è¿è¡Œæµ‹è¯•

ç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯ PostgreSQLï¼Œå¹¶å·²é…ç½®å¥½ Django æ•°æ®åº“ï¼š

```bash
python manage.py test yourapp
```

------

## âœ… å¯é€‰ï¼šåªæŸ¥å…¶ä»– groupï¼ˆä¸å«è‡ªèº«ï¼‰

å¦‚æœä½ ä¸æƒ³è®©ç»“æœåŒ…å«è‡ªå·±ï¼ˆå³åªæŸ¥â€œå…¶å®ƒç­‰ä»·ç»„â€ï¼‰ï¼Œåœ¨ `filter` ååŠ ä¸Šï¼š

```python
.exclude(id=group_id)
```

------

éœ€è¦æˆ‘ç»™ä½ è¿™ä¸ªæµ‹è¯•åœºæ™¯çš„è¿ç§»è„šæœ¬ã€`pytest` ç‰ˆæœ¬æˆ–æ›´å¤§è§„æ¨¡å‹åŠ›æµ‹è¯•è„šæœ¬å—ï¼Ÿ

ä½ çš„å½“å‰å®ç°å·²ç»æ˜¯ **çº¯ ORM + é«˜æ•ˆå†…å­˜é›†åˆå¯¹æ¯”**ï¼Œé€‚åˆä¸­ç­‰è§„æ¨¡ï¼ˆä¸Šä¸‡ï¼‰æ•°æ®ä½¿ç”¨ã€‚ä½†å¦‚æœä½ å¸Œæœ›è¿›ä¸€æ­¥**ä¼˜åŒ–æ€§èƒ½**ã€**å‡å°‘æ•°æ®åº“æ‰«æé‡æˆ–å†…å­˜æ¶ˆè€—**ï¼Œå¯ä»¥è€ƒè™‘å¦‚ä¸‹å‡ ä¸ªæ–¹å‘ã€‚

------

## âœ… å½“å‰ä¼˜åŒ–ç¨‹åº¦å›é¡¾

ä½ å½“å‰æ–¹æ¡ˆå·²ç»æœ‰ä»¥ä¸‹ä¼˜åŒ–ç‚¹ï¼š

| ä¼˜åŒ–ç‚¹             | æ˜¯å¦å…·å¤‡ | è¯´æ˜                                       |
| ------------------ | -------- | ------------------------------------------ |
| åªåŠ è½½å¿…è¦å­—æ®µ     | âœ…        | `.only('name')` é™å®šå­—æ®µ                   |
| æ‰¹é‡é¢„åŠ è½½         | âœ…        | `prefetch_related(Prefetch(...))` é¿å… N+1 |
| ç»“æ„å¯¹æ¯”ä¼˜åŒ–       | âœ…        | ç”¨ `set()` å‡å°‘æ’åºç­‰é¢å¤–è¿ç®—              |
| æå‰æ’é™¤ä¸ç­‰é•¿é›†åˆ | âœ…        | `len(names) != target_count`               |

------

## ğŸš€ å¯é€‰ä¼˜åŒ–æ–¹å‘ï¼ˆè¿›é˜¶ï¼‰

### 1. âœ… **é™åˆ¶å€™é€‰ç»„èŒƒå›´ï¼ˆç”¨ annotation èšåˆè¿‡æ»¤ï¼‰**

> ä¸ç”¨åŠ è½½æ‰€æœ‰ groupï¼ŒåªåŠ è½½â€œå¯èƒ½åŒ¹é…â€çš„ groupï¼Œæå‰ç”¨æ•°æ®åº“è¿‡æ»¤æ‰æ•°é‡ä¸å¯¹çš„ groupã€‚

ç¤ºä¾‹ï¼š

```python
from django.db.models import Count

# å…ˆè¿‡æ»¤å‡ºæ ‡ç­¾æ•°é‡ç›¸ç­‰çš„ç»„ï¼ˆå‡å°‘ prefetch çš„é‡ï¼‰
groups = TagGroup.objects.annotate(tag_count=Count('details')).filter(tag_count=target_count)
groups = groups.prefetch_related(Prefetch('details', queryset=TagDetail.objects.only('name')))
```

è¿™æ ·ä½ åª prefetch æ•°é‡ç›¸åŒçš„ç»„ï¼Œ**æ˜¾è‘—å‡å°‘å†…å­˜éå†å’Œè¯·æ±‚é‡**ã€‚

------

### 2. âœ… **æ’åº + tuple æ¯”è¾ƒï¼ˆé¿å… set æ„é€ å¼€é”€ï¼‰**

å¦‚æœä½ ä¿è¯æ ‡ç­¾åç§°åœ¨æ¯ç»„å†…å”¯ä¸€ï¼Œ**ä¸”æ•°é‡ä¸å¤§**ï¼Œä½ ä¹Ÿå¯ä»¥å°†æ ‡ç­¾å**æ’åºä¸ºå…ƒç»„**è¿›è¡Œå¯¹æ¯”ï¼ˆåŠ å¿« hash æ¯”è¾ƒï¼‰ï¼š

```python
target_signature = tuple(sorted(target_names))

for group in groups:
    signature = tuple(sorted(d.name for d in group.details.all()))
    if signature == target_signature:
        matched_group_ids.append(group.id)
```

è¿™ç§æ–¹å¼å¯¹æ¯”ä¸¤ä¸ªå…ƒç»„æ¯”å¯¹ä¸¤ä¸ª set æ›´å¿«ï¼Œå°¤å…¶æ˜¯åœ¨æ ‡ç­¾æ•°é‡è¾ƒå°æ—¶ï¼ˆ5-30 ä¸ªä»¥å†…ï¼‰ï¼Œé€Ÿåº¦å¯èƒ½å¿«ä¸€å€å·¦å³ã€‚

------

### 3. âœ… **æå‰ç¼“å­˜ç›®æ ‡ç­¾å**

é¿å…å¤šæ¬¡æ„å»º target æ•°æ®ç»“æ„ï¼Œå°¤å…¶ä½ åç»­å¯èƒ½è¦å¤šæ¬¡ç”¨ï¼š

```python
# å·²æœ‰ï¼štarget_names = set(...)
target_signature = tuple(sorted(target_names))
```

------

### 4. âœ… **å°†ç»“æœæ”¹ä¸º generatorï¼ˆæµå¼éå†ï¼‰**

å¦‚æœä½ ä¸éœ€è¦ä¸€æ¬¡æ€§æ‹¿åˆ°æ‰€æœ‰ IDï¼Œè€Œæ˜¯é€ä¸ªè¿”å›ï¼Œå¯ä»¥å°†å…¶æ”¹ä¸ºç”Ÿæˆå™¨ï¼š

```python
def get_groups_with_same_tag_names(group_id):
    ...
    for group in groups:
        ...
        if names == target_names:
            yield group.id
```

ç„¶åè°ƒç”¨å¤„ä½¿ç”¨ï¼š

```python
for group_id in get_groups_with_same_tag_names(...):
    print(group_id)
```

è¿™æ ·å¯ä»¥èŠ‚çœå¤§é‡å†…å­˜ï¼ˆé€‚ç”¨äºç™¾ä¸‡ç»„ä»¥ä¸Šçš„æå¤§æ•°æ®é‡ï¼‰ã€‚

------

### 5. âŒ ä¸æ¨èçš„ä¼˜åŒ–ï¼šhash è¿›æ•°æ®åº“

ä½ å¯èƒ½ä¼šè€ƒè™‘ç»™æ¯ä¸ª TagGroup çš„æ ‡ç­¾åé›†åˆåŠ ä¸Š hashï¼ˆå¦‚ `md5(sorted(tag_names))`ï¼‰æ¥åŠ é€Ÿè¿‡æ»¤ï¼Œä½†è¿™å±äºï¼š

- å†™æ—¶å¢åŠ é¢å¤–ç»´æŠ¤è´Ÿæ‹…ï¼›
- æ ‡ç­¾å˜æ›´æ—¶åŒæ­¥ç»´æŠ¤å¤æ‚ï¼›
- ä¸å¦‚çº¯ Python å¤„ç†çµæ´»ã€‚

ä»…åœ¨è¶…å¤§è§„æ¨¡æ•°æ®ï¼ˆåƒä¸‡ä»¥ä¸Šï¼‰éœ€è¦è€ƒè™‘ã€‚

------

## âœ… æ¨èæœ€ç»ˆä¼˜åŒ–ç‰ˆï¼ˆç»„åˆ Count + Prefetchï¼‰

```python
from django.db.models import Count, Prefetch
from .models import TagGroup, TagDetail

def get_groups_with_same_tag_names(group_id):
    target_names = set(
        TagDetail.objects.filter(tag_group_id=group_id).values_list('name', flat=True)
    )
    target_count = len(target_names)
    target_signature = tuple(sorted(target_names))

    groups = TagGroup.objects.annotate(tag_count=Count('details')).filter(tag_count=target_count)
    groups = groups.prefetch_related(
        Prefetch('details', queryset=TagDetail.objects.only('name'))
    )

    matched_group_ids = []

    for group in groups:
        signature = tuple(sorted(d.name for d in group.details.all()))
        if signature == target_signature:
            matched_group_ids.append(group.id)

    return matched_group_ids
```

------

å¦‚ä½ å¸Œæœ›æŠŠè¿™å°è£…ä¸ºå¯é“¾å¼ä½¿ç”¨çš„ ORM æ–¹æ³•ï¼ˆå¦‚ `.with_same_tag_names_as(group_id)`ï¼‰ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ åšè‡ªå®šä¹‰ `QuerySet`ã€‚

æ˜¯å¦éœ€è¦æˆ‘å¸®ä½ å°è£…ä¸ºæ›´é€šç”¨çš„å·¥å…·ï¼Ÿ
