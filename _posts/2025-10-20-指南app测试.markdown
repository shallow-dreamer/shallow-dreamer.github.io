---
layout:     post
title:      "æŒ‡å—appæµ‹è¯•"
subtitle:   ""
date:       2025-10-20
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - Django
---

```python
from django.db import models


class HelpCategory(models.Model):
    """
    åˆ†çº§åˆ†ç±»è¡¨ï¼Œæ”¯æŒæ— é™å±‚çº§çš„åˆ†ç±»æ ‘ã€‚
    """
    name = models.CharField(max_length=100, verbose_name="åˆ†ç±»åç§°")
    parent = models.ForeignKey(
        "self",
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name="children",
        verbose_name="çˆ¶åˆ†ç±»",
    )
    description = models.TextField(blank=True, null=True, verbose_name="åˆ†ç±»è¯´æ˜")

    class Meta:
        verbose_name = "å¸®åŠ©åˆ†ç±»"
        verbose_name_plural = "å¸®åŠ©åˆ†ç±»"

    def __str__(self):
        return self.name

    @property
    def level(self):
        """è¿”å›å½“å‰åˆ†ç±»çš„å±‚çº§ï¼ˆæ ¹ä¸º1ï¼‰"""
        level = 1
        parent = self.parent
        while parent:
            level += 1
            parent = parent.parent
        return level


class HelpFile(models.Model):
    """
    å¸®åŠ©æ–‡ä»¶è¡¨ï¼Œæ”¯æŒå¤šåˆ†ç±»å…³è”ã€‚
    """
    title = models.CharField(max_length=200, verbose_name="æ–‡ä»¶æ ‡é¢˜")
    description = models.TextField(blank=True, null=True, verbose_name="æ–‡ä»¶ç®€ä»‹")
    file = models.FileField(upload_to="help_files/", verbose_name="æ–‡ä»¶å†…å®¹")
    category = models.ForeignKey(
        HelpCategory,
        on_delete=models.CASCADE,
        related_name="files",
        verbose_name="æ‰€å±åˆ†ç±»",
    )
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="åˆ›å»ºæ—¶é—´")
    updated_at = models.DateTimeField(auto_now=True, verbose_name="æ›´æ–°æ—¶é—´")

    class Meta:
        verbose_name = "å¸®åŠ©æ–‡ä»¶"
        verbose_name_plural = "å¸®åŠ©æ–‡ä»¶"
        indexes = [
            models.Index(fields=["category", "created_at"]),
        ]

    def __str__(self):
        return self.title

```

```python
from rest_framework import serializers
from .models import HelpCategory, HelpFile

class HelpFileSerializer(serializers.ModelSerializer):
    class Meta:
        model = HelpFile
        fields = ["id", "title", "file", "created_at"]

class HelpCategoryNestedSerializer(serializers.ModelSerializer):
    files = serializers.SerializerMethodField()
    page = serializers.SerializerMethodField()
    total = serializers.SerializerMethodField()

    class Meta:
        model = HelpCategory
        fields = ["id", "name", "parent", "files", "page", "total"]

    def get_files(self, obj):
        files = self.context.get("files")
        if files is not None:
            return HelpFileSerializer(files, many=True).data
        return HelpFileSerializer(obj.files.all(), many=True).data

    def get_page(self, obj):
        return self.context.get("page", 1)

    def get_total(self, obj):
        return self.context.get("total", obj.files.count())

```

```python
from django.test import TestCase
from django.core.paginator import Paginator
from .models import HelpCategory, HelpFile
from django.core.files.base import ContentFile

from lock_test_project.guide.serializers import HelpCategoryNestedSerializer


class HelpCenterModelTest(TestCase):
    @classmethod
    def setUpTestData(cls):
        # åˆ›å»ºåˆ†ç±»ç»“æ„ï¼ˆä¸‰çº§ï¼‰
        cls.root = HelpCategory.objects.create(name="ç”¨æˆ·æŒ‡å—")
        cls.sub1 = HelpCategory.objects.create(name="å®‰è£…æ•™ç¨‹", parent=cls.root)
        cls.sub2 = HelpCategory.objects.create(name="ä½¿ç”¨æ•™ç¨‹", parent=cls.root)
        cls.sub11 = HelpCategory.objects.create(name="Windows å®‰è£…", parent=cls.sub1)
        cls.sub12 = HelpCategory.objects.create(name="Mac å®‰è£…", parent=cls.sub1)

        # ä¸ºæ¯ä¸ªåˆ†ç±»åˆ›å»ºä¸€äº›æ–‡ä»¶
        for i in range(25):
            file = HelpFile.objects.create(
                category=cls.sub11,
                title=f"Windows å®‰è£…æ–‡æ¡£ {i+1}",
                file=ContentFile(b"Fake content", name=f"win_install_{i+1}.pdf"),
            )
        for i in range(8):
            file = HelpFile.objects.create(
                category=cls.sub12,
                title=f"Mac å®‰è£…æ–‡æ¡£ {i+1}",
                file=ContentFile(b"Fake content", name=f"mac_install_{i+1}.pdf"),
            )
        for i in range(10):
            file = HelpFile.objects.create(
                category=cls.sub2,
                title=f"ä½¿ç”¨è¯´æ˜ {i+1}",
                file=ContentFile(b"Fake content", name=f"use_tutorial_{i+1}.pdf"),
            )

    def test_category_hierarchy(self):
        """æµ‹è¯•åˆ†ç±»çš„å±‚çº§ç»“æ„"""
        all_objs = HelpCategory.objects.filter(parent__isnull=True).all()
        data = HelpCategoryNestedSerializer(all_objs, many=True).data
        print(data)
        self.assertEqual(self.root.children.count(), 2)
        self.assertEqual(self.sub1.children.count(), 2)
        self.assertEqual(self.sub2.children.count(), 0)
        self.assertEqual(self.sub11.parent.name, "å®‰è£…æ•™ç¨‹")

    def paginate_category_files(self, category, page=1, page_size=10):
        """ä»åˆ†ç±»å‘èµ·çš„åˆ†é¡µæŸ¥è¯¢ï¼ˆæ¨èç”¨æ³•ï¼‰"""
        queryset = category.files.all().order_by("id")
        paginator = Paginator(queryset, page_size)
        page_obj = paginator.get_page(page)
        return {
            "category": category,
            "page": page,
            "page_size": page_size,
            "total": paginator.count,
            "total_pages": paginator.num_pages,
            "files": page_obj.object_list,
        }

    def test_category_pagination_from_category_side(self):
        """æµ‹è¯•åˆ†é¡µä»åˆ†ç±»ä¾§å‘èµ·"""
        category = self.sub11

        # æ¨¡æ‹Ÿå‰ç«¯è¯·æ±‚ç¬¬ä¸€é¡µã€ç¬¬äºŒé¡µã€ç¬¬ä¸‰é¡µ
        for page in [1, 2, 3]:
            data = self.paginate_category_files(category, page)
            print(f"\n=== ç¬¬ {page} é¡µæ•°æ® ===")
            print(f"æ€»æ–‡ä»¶æ•°ï¼š{data['total']}, æ€»é¡µæ•°ï¼š{data['total_pages']}")

            # ä½¿ç”¨åˆ†ç±»åºåˆ—åŒ–å™¨è¾“å‡ºï¼ˆå¸¦åˆ†é¡µæ–‡ä»¶ï¼‰
            serialized = HelpCategoryNestedSerializer(
                data["category"],
                context={"files": data["files"], "page": page, "total": data["total"]},
            )
            print(serialized.data)

        # éªŒè¯åˆ†é¡µé€»è¾‘
        first_page = self.paginate_category_files(category, 1)
        print(first_page)
        self.assertEqual(first_page["total"], 25)
        self.assertEqual(first_page["total_pages"], 3)
        self.assertEqual(len(first_page["files"]), 10)

    def test_fetch_all_subcategory_files(self):
        """æµ‹è¯•è·å–æŸåˆ†ç±»ä¸‹æ‰€æœ‰å­åˆ†ç±»çš„æ–‡ä»¶"""
        def get_all_files(category):
            # é€’å½’å–å‡ºæ‰€æœ‰å­åˆ†ç±»æ–‡ä»¶
            files = list(category.files.all())
            for sub in category.children.all():
                files.extend(get_all_files(sub))
            return files

        all_files = get_all_files(self.root)
        print(f"\nâ€˜ç”¨æˆ·æŒ‡å—â€™ä¸‹æ‰€æœ‰æ–‡ä»¶æ•°ï¼š{len(all_files)}")
        self.assertEqual(len(all_files), 43)  # 25 + 8 + 10

    def test_performance(self):
        """æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡æŸ¥è¯¢"""
        import time
        start = time.time()
        files = HelpFile.objects.select_related("category").all()
        _ = [f.title for f in files]
        end = time.time()
        print(f"\næ‰¹é‡åŠ è½½ {len(files)} æ¡æ–‡ä»¶è€—æ—¶ï¼š{end - start:.4f}s")

        self.assertTrue(end - start < 1.0)

```

éå¸¸å¥½ ğŸ‘ï¼Œä¸ºâ€œä½¿ç”¨å¸®åŠ©ï¼ˆæŒ‡å—ï¼‰â€æ¨¡å—æ·»åŠ åˆ†ç±»æ’åºæ˜¯ä¸€ä¸ªéå¸¸è‡ªç„¶çš„æ‰©å±•éœ€æ±‚ã€‚
 æˆ‘ä»¬å¯ä»¥è®©åŒä¸€å±‚çº§ä¸‹çš„åˆ†ç±»æ‹¥æœ‰å¯æ§çš„æ˜¾ç¤ºé¡ºåºï¼Œè¿™æ ·å‰ç«¯å±•ç¤ºæˆ–åå°ç®¡ç†æ—¶å°±èƒ½çµæ´»è°ƒæ•´é¡ºåºã€‚

------

## âœ… ä¸€ã€æ¨¡å‹ä¿®æ”¹ï¼ˆ`models.py`ï¼‰

åœ¨ `HelpCategory` æ¨¡å‹ä¸­æ·»åŠ ä¸€ä¸ª `order` å­—æ®µï¼Œç”¨äºåŒçº§åˆ†ç±»é—´æ’åºï¼š

```python
from django.db import models

class HelpCategory(models.Model):
    name = models.CharField(max_length=100, verbose_name="åˆ†ç±»åç§°")
    parent = models.ForeignKey(
        "self",
        null=True,
        blank=True,
        related_name="children",
        on_delete=models.CASCADE,
        verbose_name="çˆ¶åˆ†ç±»"
    )
    order = models.PositiveIntegerField(default=0, verbose_name="æ’åºå€¼")

    class Meta:
        verbose_name = "å¸®åŠ©åˆ†ç±»"
        verbose_name_plural = "å¸®åŠ©åˆ†ç±»"
        ordering = ["parent__id", "order", "id"]  # é»˜è®¤æŒ‰çˆ¶çº§ã€æ’åºå€¼ã€ID æ’åº
        unique_together = ("parent", "order")  # åŒä¸€å±‚çº§æ’åºå€¼å”¯ä¸€ï¼ˆå¯é€‰ï¼‰

    def __str__(self):
        return f"{self.name} ({self.parent.name if self.parent else 'æ ¹åˆ†ç±»'})"
```

### âœ… å­—æ®µè§£é‡Š

| å­—æ®µå            | ç±»å‹                   | è¯´æ˜                                   |
| ----------------- | ---------------------- | -------------------------------------- |
| `order`           | `PositiveIntegerField` | ç”¨äºåŒçº§åˆ†ç±»çš„æ’åºï¼ˆä»å°åˆ°å¤§æ˜¾ç¤ºï¼‰     |
| `unique_together` | `("parent", "order")`  | é˜²æ­¢åŒä¸€å±‚çº§ä¸‹å‡ºç°é‡å¤çš„æ’åºå·ï¼ˆå¯é€‰ï¼‰ |
| `ordering`        | Django Meta æ’åº       | é»˜è®¤æŸ¥è¯¢æ—¶è‡ªåŠ¨æŒ‰ç…§çˆ¶çº§â†’æ’åºâ†’id æ’åº    |

------

## âœ… äºŒã€æ•°æ®è¿ç§»å‘½ä»¤

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åº”ç”¨å­—æ®µæ›´æ”¹ï¼š

```bash
python manage.py makemigrations
python manage.py migrate
```

------

## âœ… ä¸‰ã€ä½¿ç”¨ç¤ºä¾‹ï¼ˆåœ¨æµ‹è¯•æˆ–åå°ä¸­ï¼‰

```python
root = HelpCategory.objects.create(name="ç”¨æˆ·æŒ‡å—", order=1)
install = HelpCategory.objects.create(name="å®‰è£…æ•™ç¨‹", parent=root, order=2)
config = HelpCategory.objects.create(name="é…ç½®æŒ‡å—", parent=root, order=1)

# æŸ¥è¯¢æ—¶è‡ªåŠ¨æŒ‰ order æ’åº
for cat in HelpCategory.objects.filter(parent=root):
    print(cat.name)

# è¾“å‡ºï¼š
# é…ç½®æŒ‡å—
# å®‰è£…æ•™ç¨‹
```

------

## âœ… å››ã€åºåˆ—åŒ–ä¸æ’åºè¾“å‡ºï¼ˆ`serializers.py`ï¼‰

ä¸éœ€è¦ä¿®æ”¹åŸåºåˆ—åŒ–é€»è¾‘ï¼Œåªè¦ç¡®ä¿æŸ¥è¯¢æ—¶ä½¿ç”¨é»˜è®¤æ’åºå³å¯ï¼š

```python
class HelpCategoryNestedSerializer(serializers.ModelSerializer):
    children = serializers.SerializerMethodField()

    class Meta:
        model = HelpCategory
        fields = ["id", "name", "order", "parent", "children"]

    def get_children(self, obj):
        children = obj.children.all().order_by("order", "id")
        return HelpCategoryNestedSerializer(children, many=True).data
```

------

## âœ… äº”ã€æµ‹è¯•ç”¨ä¾‹ä¸­éªŒè¯æ’åºé€»è¾‘

```python
def test_category_ordering(self):
    root = HelpCategory.objects.create(name="æ ¹åˆ†ç±»")
    cat_a = HelpCategory.objects.create(name="Aç±»", parent=root, order=2)
    cat_b = HelpCategory.objects.create(name="Bç±»", parent=root, order=1)
    cat_c = HelpCategory.objects.create(name="Cç±»", parent=root, order=3)

    ordered = list(HelpCategory.objects.filter(parent=root))
    names = [c.name for c in ordered]
    self.assertEqual(names, ["Bç±»", "Aç±»", "Cç±»"])
```

------

## âœ… å…­ã€æ‰©å±•å»ºè®®

ä½ å¯ä»¥ä¸ºåå°ç®¡ç†ç•Œé¢æˆ– API æ·»åŠ æ’åºåŠŸèƒ½ï¼š

- **Django Admin**ï¼š
   åœ¨ `admin.py` ä¸­æ·»åŠ  `list_editable = ["order"]` æ”¯æŒæ‹–æ‹½æˆ–ç›´æ¥ç¼–è¾‘æ’åºå€¼ã€‚
- **REST API**ï¼š
   åœ¨è§†å›¾ä¸­ä½¿ç”¨ `ordering_fields = ["order"]`ï¼Œå…è®¸å‰ç«¯ä½¿ç”¨å‚æ•° `?ordering=order` æ§åˆ¶é¡ºåºã€‚

