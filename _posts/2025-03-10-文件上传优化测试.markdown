---
layout:     post
title:      "æ–‡ä»¶ä¸Šä¼ ä¼˜åŒ–æµ‹è¯•"
subtitle:   ""
date:       2025-03-10
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - æ–‡ä»¶ä¸Šä¼ 
---

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨çš„éœ€æ±‚å¯ä»¥æ€»ç»“ä¸ºï¼š

âœ… **å‰ç«¯éœ€è¦è¯»å–å’Œå¤„ç†å¤§é‡æ–‡ä»¶**
 âœ… **å¤„ç†åçš„æ•°æ®ä¸åŸå§‹æ–‡ä»¶ä¸€èµ·ä¸Šä¼ åˆ°åç«¯**
 âœ… **ä¿è¯æ€§èƒ½ï¼Œé¿å… UI å¡é¡¿æˆ–æµè§ˆå™¨å´©æºƒ**
 âœ… **ç¡®ä¿ä¸Šä¼ è¿‡ç¨‹ç¨³å®šï¼Œæ”¯æŒè¿›åº¦åé¦ˆã€æ–­ç‚¹ç»­ä¼ ç­‰æœºåˆ¶**

------

## ğŸ› ï¸ **æ¨èè§£å†³æ–¹æ¡ˆ**

### ğŸ”„ **æ•´ä½“æµç¨‹**

1. **é€‰æ‹©æ–‡ä»¶å¤¹å¹¶è·å–æ–‡ä»¶**
2. **åœ¨å‰ç«¯è¿›è¡Œæ–‡ä»¶é¢„å¤„ç†ï¼ˆå¦‚å‹ç¼©ã€åŠ å¯†ã€é‡å‘½åã€æå–å…ƒæ•°æ®ç­‰ï¼‰**
3. **å°†å¤„ç†åçš„æ•°æ®å’ŒåŸå§‹æ–‡ä»¶æ•´åˆï¼Œå‡†å¤‡ä¸Šä¼ **
4. **åˆ†ç‰‡ä¸Šä¼ ï¼ˆè‹¥æ–‡ä»¶è¾ƒå¤§ï¼‰**
5. **æä¾›è¿›åº¦åé¦ˆåŠå¤±è´¥é‡è¯•æœºåˆ¶**

------

## ğŸš€ **å®ç°æ­¥éª¤**

### **âœ… 1. é€‰æ‹©æ–‡ä»¶å¤¹å¹¶è·å–æ–‡ä»¶**

ä½¿ç”¨ `<input type="file" webkitdirectory multiple>` æ ‡ç­¾é€‰æ‹©æ–‡ä»¶å¤¹å¹¶è·å–æ–‡ä»¶åˆ—è¡¨ã€‚

```html
<input 
  type="file" 
  webkitdirectory 
  multiple 
  @change="handleFileSelection" 
/>
const MAX_BATCH_SIZE = 100; // æ¯æ¬¡å¤„ç†çš„æœ€å¤§æ–‡ä»¶æ•°

async function handleFileSelection(event) {
    const files = Array.from(event.target.files);

    if (!files.length) return;

    // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡
    for (let i = 0; i < files.length; i += MAX_BATCH_SIZE) {
        const batch = files.slice(i, i + MAX_BATCH_SIZE);
        await processBatch(batch);  
    }

    console.log("âœ… æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ");
}
```

------

### **âœ… 2. æ–‡ä»¶é¢„å¤„ç†**

åœ¨é¢„å¤„ç†é˜¶æ®µï¼Œæ‚¨å¯ä»¥ï¼š

- âœ… **å‹ç¼©å›¾ç‰‡**
- âœ… **è¯»å–æ–‡ä»¶å†…å®¹å¹¶ç”Ÿæˆæ‘˜è¦ï¼ˆå¦‚ MD5ã€SHA256ï¼‰**
- âœ… **æå–æ–‡ä»¶å…ƒæ•°æ®ï¼ˆå¦‚åˆ›å»ºæ—¶é—´ã€å¤§å°ï¼‰**
- âœ… **é‡æ–°å‘½åæˆ–è§„èŒƒåŒ–è·¯å¾„**

**ç¤ºä¾‹ä»£ç ï¼šå‹ç¼©å›¾ç‰‡**

```javascript
async function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);

        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;

            img.onload = () => {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                // é™ä½åˆ†è¾¨ç‡ä»¥å‹ç¼©
                canvas.width = img.width / 2;
                canvas.height = img.height / 2;

                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                canvas.toBlob((blob) => {
                    resolve(blob);
                }, "image/jpeg", 0.7);  // è´¨é‡ 70%
            };
        };
    });
}
```

------

### **âœ… 3. æ„é€ ä¸Šä¼ æ•°æ®**

å°†åŸå§‹æ–‡ä»¶ã€å¤„ç†åçš„æ•°æ®ã€é¢å¤–ä¿¡æ¯æ•´åˆä¸º `FormData` å¯¹è±¡ï¼Œä»¥ä¾¿ä¾¿æ·åœ°ä¸Šä¼ ã€‚

**ç¤ºä¾‹ä»£ç **

```javascript
async function buildFormData(files) {
    const formData = new FormData();

    for (const file of files) {
        // ç¤ºä¾‹ï¼šå‹ç¼©å›¾ç‰‡å¹¶é™„åŠ å…ƒæ•°æ®
        const compressedImage = await compressImage(file);
        formData.append("file", compressedImage, file.name);

        // é™„åŠ å…ƒæ•°æ®ä¿¡æ¯
        const metadata = {
            name: file.name,
            size: file.size,
            lastModified: file.lastModified,
            type: file.type,
        };

        formData.append(`metadata_${file.name}`, JSON.stringify(metadata));
    }

    return formData;
}
```

------

### **âœ… 4. åˆ†ç‰‡ä¸Šä¼ **

å½“æŸäº›æ–‡ä»¶è¾ƒå¤§æ—¶ï¼Œæ¨èä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ æé«˜ç¨³å®šæ€§ã€‚

**ç¤ºä¾‹ä»£ç **

```javascript
async function uploadInChunks(file, url, chunkSize = 5 * 1024 * 1024) {
    const totalChunks = Math.ceil(file.size / chunkSize);

    for (let i = 0; i < totalChunks; i++) {
        const start = i * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const chunk = file.slice(start, end);

        const formData = new FormData();
        formData.append("chunk", chunk);
        formData.append("index", i);
        formData.append("totalChunks", totalChunks);

        await axios.post(url, formData);
    }

    console.log(`âœ… ${file.name} ä¸Šä¼ å®Œæˆ`);
}
```

------

### **âœ… 5. æä¾›ä¸Šä¼ è¿›åº¦ä¸åé¦ˆ**

å®ç°è¿›åº¦æ¡ã€ä¸Šä¼ å®Œæˆæç¤ºã€å¤±è´¥é‡è¯•ç­‰åŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

**ç¤ºä¾‹ä»£ç **

```javascript
async function uploadWithProgress(formData, url) {
    await axios.post(url, formData, {
        onUploadProgress: (progressEvent) => {
            const percentCompleted = Math.round(
                (progressEvent.loaded * 100) / progressEvent.total
            );
            console.log(`è¿›åº¦: ${percentCompleted}%`);
        },
    });
}
```

------

### **âœ… 6. æ–­ç‚¹ç»­ä¼ ï¼ˆå¯é€‰ï¼‰**

å¯¹äºç‰¹åˆ«å¤§çš„æ•°æ®é›†ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

- âœ… ä¸ºæ¯ä¸ªæ–‡ä»¶ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ `MD5` æˆ– `UUID`ï¼‰
- âœ… è®°å½•å·²ä¸Šä¼ çš„åˆ†ç‰‡ç´¢å¼•
- âœ… å¤±è´¥æ—¶å¯ä»æ–­ç‚¹ç»§ç»­ä¸Šä¼ 

------

### **âœ… 7. åç«¯æ•°æ®å¤„ç†å»ºè®®**

åœ¨åç«¯ï¼Œæ‚¨å¯ä»¥ï¼š

1. è§£æ `FormData` æ•°æ®
2. æ ¹æ® `metadata` æå–æ–‡ä»¶ä¿¡æ¯
3. æ ¹æ®å‰ç«¯é€»è¾‘å°†å¤§æ–‡ä»¶åˆ†ç‰‡é‡æ–°åˆå¹¶

**Django ç¤ºä¾‹ä»£ç **

```python
from django.http import JsonResponse
from django.views import View
from django.core.files.storage import default_storage

class FileUploadView(View):
    def post(self, request):
        file = request.FILES.get("file")
        metadata = request.POST.get("metadata")

        if not file or not metadata:
            return JsonResponse({"error": "ç¼ºå°‘æ–‡ä»¶æˆ–å…ƒæ•°æ®"}, status=400)

        # ç¤ºä¾‹ï¼šä¿å­˜æ–‡ä»¶
        file_path = default_storage.save(f"uploads/{file.name}", file)

        # ç¤ºä¾‹ï¼šå¤„ç†å…ƒæ•°æ®
        metadata_dict = json.loads(metadata)
        print(f"æ–‡ä»¶å: {metadata_dict['name']}")
        print(f"å¤§å°: {metadata_dict['size']} å­—èŠ‚")

        return JsonResponse({"message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ", "path": file_path})
```

------

## ğŸ”¥ **å®Œæ•´æµç¨‹æ€»ç»“**

âœ… ä½¿ç”¨ `<input type="file" webkitdirectory>` é€‰æ‹©æ–‡ä»¶å¤¹
 âœ… ä½¿ç”¨ `Web Worker` è¿›è¡Œå¤æ‚é¢„å¤„ç†ï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡
 âœ… å°†å¤„ç†åçš„æ•°æ®å’ŒåŸå§‹æ–‡ä»¶æ•´åˆåˆ° `FormData` ä¸­
 âœ… ä½¿ç”¨ `åˆ†ç‰‡ä¸Šä¼ ` é¿å…è¶…å¤§æ–‡ä»¶çš„ä¸Šä¼ å¤±è´¥
 âœ… å®ç° `è¿›åº¦åé¦ˆ` æé«˜ç”¨æˆ·ä½“éªŒ
 âœ… å¯é€‰ï¼šç»“åˆ `æ–­ç‚¹ç»­ä¼ ` æå‡ç¨³å®šæ€§

è¿™å¥—æ–¹æ¡ˆå…¼å…·**æ€§èƒ½**ã€**ç¨³å®šæ€§**ã€**æ˜“ç»´æŠ¤æ€§**ï¼Œå¹¶ç¡®ä¿åœ¨æ–‡ä»¶æ•°é‡åºå¤§æ—¶ä»èƒ½é«˜æ•ˆå®Œæˆä»»åŠ¡ã€‚å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–æŸä¸€ç¯èŠ‚ï¼Œæ¬¢è¿ç»§ç»­æ¢è®¨ã€‚ ğŸ˜Š

