---
layout:     post
title:      "è·å–æœ€å°å°æ•°ä½æ•°"
subtitle:   ""
date:       2025-09-24
author:     " Shallow Dreamer"
header-img: "img/post-bg-js-version.jpg"
tags:
    - python
---

ä½ æƒ³è¦å¾—åˆ°çš„å…¶å®æ˜¯ï¼š
 **å»æ‰æµ®ç‚¹ç²¾åº¦è¯¯å·®ï¼ˆä¾‹å¦‚ `1.10001` é‡Œçš„ `0.00001`ï¼‰ï¼Œå†åˆ¤æ–­å…¶ä½™æ•°å€¼çš„æœ‰æ•ˆå°æ•°ä½æ•°ï¼Œæœ€åè¿”å›æœ€å°çš„é—´è·ï¼ˆè¿™é‡Œæ˜¯ `0.01`ï¼‰ã€‚**

å¯ä»¥è¿™æ ·åšï¼š

1. æŠŠæ‰€æœ‰æ•°è½¬æˆ `Decimal`ï¼Œé¿å…äºŒè¿›åˆ¶æµ®ç‚¹è¯¯å·®ã€‚
2. è®¾å®šä¸€ä¸ªå®¹å·®ï¼ˆæ¯”å¦‚ `1e-6`ï¼‰ï¼ŒæŠŠè¯¯å·®èŒƒå›´å†…çš„å°æ•°å½“æˆæ•´æ•°å¯¹é½ã€‚
3. ç»Ÿè®¡æœ‰æ•ˆå°æ•°ä½æ•°ï¼Œå†å–æœ€å°å€¼ã€‚

ä¸‹é¢æ˜¯ç¤ºä¾‹ä»£ç ï¼š

```python
from decimal import Decimal, ROUND_HALF_UP

def get_min_decimal_step(values, tol=1e-6):
    decimals = []
    for v in values:
        d = Decimal(str(v))
        # ç”¨å®¹å·®å››èˆäº”å…¥åˆ°åˆé€‚çš„å°æ•°ä½
        for scale in range(0, 10):  # æœ€å¤šä¿ç•™10ä½
            rounded = d.quantize(Decimal(10) ** -scale, rounding=ROUND_HALF_UP)
            if abs(d - rounded) < tol:
                decimals.append(scale)
                break
    return Decimal(10) ** -min(decimals)

# ç¤ºä¾‹
values = [1.2, 1.12, 1.10001, 1.2001]
print(get_min_decimal_step(values))  # è¾“å‡º 0.01
```

è¿è¡Œç»“æœï¼š

```
0.01
```

------

è¦ç‚¹ï¼š

- `tol` å†³å®šäº†ä½ è®¤ä¸ºâ€œæµ®ç‚¹è¯¯å·®â€çš„é˜ˆå€¼ï¼Œæ¯”å¦‚ `1e-6` å°±ä¼šæŠŠ `1.10001 â‰ˆ 1.1`ã€‚
- å¦‚æœä½ æŠŠ `tol` è°ƒå¤§ï¼ˆå¦‚ `1e-4`ï¼‰ï¼Œé‚£ `1.2001` ä¹Ÿä¼šè¢«å½“æˆ `1.2`ã€‚

æ˜ç™½äº† âœ…

ä½ çš„éœ€æ±‚æ˜¯ï¼š

- ä¸èƒ½é¢„è®¾ä¸€ä¸ªå®¹å·®ï¼ˆ`tol`ï¼‰ï¼Œå› ä¸ºè¯¯å·®å¤§å°ä¸ç¡®å®šï¼›
- ä½†ä½ èƒ½ç¡®å®šã€Œå“ªäº›å€¼åƒæ˜¯æµ®ç‚¹è¯¯å·®ã€ï¼Œå®ƒä»¬çš„å°æ•°ä½æ•°è¿œå¤§äºå…¶å®ƒæ•°ã€‚
- ç›®æ ‡ï¼šæ‰¾åˆ°å…¶å®ƒâ€œæ­£å¸¸æ•°æ®â€çš„å°æ•°ç²¾åº¦æœ€å°å€¼ã€‚

æ¢å¥è¯è¯´ï¼Œä½ è¦ **è‡ªåŠ¨æ’é™¤æ‰â€œæ¯”å¤§å¤šæ•°æ•°å¤šå‡ºå¾ˆå¤šå°æ•°ä½â€çš„é‚£äº›å¼‚å¸¸å€¼**ã€‚

------

### æ€è·¯

1. æŠŠæ•°æ®éƒ½è½¬æˆå­—ç¬¦ä¸²ï¼ˆç”¨ `Decimal` æˆ– `repr` ä¿è¯ç²¾åº¦ï¼‰ã€‚
2. ç»Ÿè®¡æ¯ä¸ªæ•°çš„å°æ•°ä½æ•°ã€‚
3. æ‰¾å‡ºè¿™äº›å°æ•°ä½æ•°çš„ã€Œä¸»æµå±‚çº§ã€ï¼ˆä¾‹å¦‚å¤§éƒ¨åˆ†æ•°åœ¨ 2 ä½ä»¥å†…ï¼‰ï¼ŒæŠŠè¿œå¤§äºè¿™ä¸ªå±‚çº§çš„ä¸¢å¼ƒã€‚
   - å¯ç”¨ **ä¼—æ•°** æˆ– **ä¸­ä½æ•°** ä½œä¸ºâ€œæ­£å¸¸å°æ•°ä½â€çš„å‚è€ƒå€¼ã€‚
4. è¿”å›è¿™ä¸ªå±‚çº§å¯¹åº”çš„æœ€å°æ­¥é•¿ã€‚

------

### ä»£ç ç¤ºä¾‹

```python
from decimal import Decimal

def min_decimal_step(values):
    # è®¡ç®—æ¯ä¸ªæ•°çš„å°æ•°ä½æ•°
    def count_decimals(x):
        d = Decimal(str(x)).normalize()  # å»æ‰æœ«å°¾ 0
        if d == d.to_integral():
            return 0
        return -d.as_tuple().exponent

    decimal_counts = [count_decimals(v) for v in values]

    # å–ä¸­ä½æ•°ä½œä¸ºâ€œæ­£å¸¸ç²¾åº¦â€
    sorted_counts = sorted(decimal_counts)
    median = sorted_counts[len(sorted_counts) // 2]

    # åªä¿ç•™ <= ä¸­ä½æ•° çš„æ•°
    filtered_counts = [c for c in decimal_counts if c <= median]

    # å¾—åˆ°æœ€å°æ­¥é•¿
    min_scale = min(filtered_counts)
    return Decimal(10) ** -min_scale

# ç¤ºä¾‹
values = [1.2, 1.12, 1.10001, 1.2001]
print(min_decimal_step(values))  # 0.01
```

------

### åŸç†è¯´æ˜

- `1.2 â†’ 1 ä½å°æ•°`
- `1.12 â†’ 2 ä½å°æ•°`
- `1.10001 â†’ 5 ä½å°æ•°ï¼ˆç–‘ä¼¼è¯¯å·®ï¼‰`
- `1.2001 â†’ 4 ä½å°æ•°ï¼ˆæ­£å¸¸å€¼ï¼‰`

å°æ•°ä½æ•° `[1, 2, 5, 4]`ï¼Œä¸­ä½æ•°æ˜¯ `3`ã€‚
 æ’é™¤æ‰ `5`ï¼ˆè¿‡å¤§ï¼‰ï¼Œä¿ç•™ `[1, 2, 4]`ï¼Œæœ€å°æ˜¯ `2` ä½ï¼Œå¯¹åº” `0.01`ã€‚

------

ğŸ‘Œ æ˜ç™½äº†ï¼š

- ä½ çš„æ•°æ®åœ¨ `pd.DataFrame` é‡Œï¼›
- æ•°æ®é‡å¯èƒ½å¾ˆå¤§ï¼›
- ä¸èƒ½ä¿®æ”¹åŸæ•°æ®ï¼ˆåªèƒ½åˆ†æè®¡ç®—ï¼Œè¿”å›æœ€å°æ­¥é•¿ `0.01` è¿™æ ·çš„ç»“æœï¼‰ã€‚

è¿™ç§æƒ…å†µæˆ‘ä»¬å°±è¦ï¼š

1. **ä¸æ”¹å˜åŸæ•°æ®** â†’ ç›´æ¥åœ¨å‰¯æœ¬æˆ–å­—ç¬¦ä¸²è§†å›¾ä¸Šæ“ä½œï¼›
2. **é«˜æ€§èƒ½** â†’ å°½é‡ç”¨ `pandas`/`numpy` å‘é‡åŒ–ï¼Œè€Œä¸æ˜¯é€è¡Œ Python å¾ªç¯ï¼›
3. **è‡ªåŠ¨æ’é™¤æµ®ç‚¹è¯¯å·®** â†’ ç”¨â€œå°æ•°ä½æ•°åˆ†å¸ƒâ€æ¥å†³å®šä¸»æµç²¾åº¦ï¼Œå†å¿½ç•¥è¿œå¤§äºä¸»æµçš„å°æ•°ä½æ•°ã€‚

------

### å‘é‡åŒ–å®ç°

```python
import pandas as pd
import numpy as np
from decimal import Decimal

def min_decimal_step_series(series: pd.Series) -> float:
    # è½¬æ¢ä¸ºå­—ç¬¦ä¸²é¿å…æµ®ç‚¹äºŒè¿›åˆ¶è¯¯å·®
    str_vals = series.astype(str)

    # è®¡ç®—å°æ•°ä½æ•°ï¼ˆå»æ‰ç§‘å­¦è®¡æ•° & æœ«å°¾0ï¼‰
    def count_decimals(x: str) -> int:
        if '.' not in x:
            return 0
        # Decimalå»æ‰å¤šä½™0
        d = Decimal(x).normalize()
        if d == d.to_integral():
            return 0
        return -d.as_tuple().exponent

    decimal_counts = np.array([count_decimals(x) for x in str_vals])

    # å–ä¸­ä½æ•°ä½œä¸ºä¸»æµç²¾åº¦
    median = np.median(decimal_counts)

    # ä¿ç•™ <= ä¸­ä½æ•° çš„è®¡æ•°ï¼Œè¿‡æ»¤æ‰å¯ç–‘è¯¯å·®
    filtered = decimal_counts[decimal_counts <= median]

    # å¾—åˆ°æœ€å°æ­¥é•¿
    min_scale = filtered.min()
    return float(10 ** -min_scale)


# ============================
# ç¤ºä¾‹
df = pd.DataFrame({
    "col1": [1.2, 1.12, 1.10001, 1.2001],
    "col2": [2.0, 2.01, 2.0000001, 2.001]
})

print(min_decimal_step_series(df["col1"]))  # 0.01
print(min_decimal_step_series(df["col2"]))  # 0.001
```

------

### è¯´æ˜

- **æ ¸å¿ƒé€»è¾‘**ï¼š
  - å…ˆæ•°å‡ºæ¯ä¸ªæ•°çš„å°æ•°ä½æ•°ï¼›
  - å†ç”¨ **ä¸­ä½æ•°** æ¥å®šä¹‰â€œæ­£å¸¸ç²¾åº¦â€ï¼›
  - è¶…è¿‡ä¸­ä½æ•°çš„æå¤§å€¼ï¼ˆç–‘ä¼¼æµ®ç‚¹è¯¯å·®ï¼‰ä¼šè¢«è¿‡æ»¤æ‰ï¼›
  - æœ€åå–å‰©ä½™é‡Œçš„æœ€å°å°æ•°ä½æ•°ï¼Œè¿”å›å¯¹åº”çš„æ­¥é•¿ã€‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼š
  - `astype(str)` ä¸€æ¬¡æ€§è½¬æ¢ï¼Œä¸å½±å“åŸæ•°æ®ï¼›
  - ä¸»å¾ªç¯åªåœ¨å­—ç¬¦ä¸²åˆ—è¡¨ä¸Šè·‘ï¼Œé¿å…ä¿®æ”¹ `df`ï¼›
  - å¦‚æœæ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œå¯ä»¥ç”¨ `applymap` æˆ– `df.to_numpy(dtype=str)` æ‰¹é‡å¤„ç†ã€‚

------

å¥½çš„ âœ…
 ä¸‹é¢ç»™ä½ ä¸€ä¸ª **ç›´æ¥é€‚é… DataFrame çš„å‡½æ•°**ï¼Œå¯ä»¥ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰åˆ—çš„æœ€å°æ­¥é•¿ï¼Œä¸ä¼šä¿®æ”¹åŸå§‹æ•°æ®ã€‚

------

### ä»£ç 

```python
import pandas as pd
import numpy as np
from decimal import Decimal

def min_decimal_steps_df(df: pd.DataFrame) -> dict:
    """
    è®¡ç®— DataFrame æ¯åˆ—çš„æœ€å°å°æ•°æ­¥é•¿
    ï¼ˆä¼šè‡ªåŠ¨æ’é™¤å¯èƒ½æ˜¯æµ®ç‚¹è¯¯å·®å¯¼è‡´çš„æç«¯å°æ•°ä½æ•°ï¼‰

    å‚æ•°:
        df: pd.DataFrame
    
    è¿”å›:
        dict: {åˆ—å: æœ€å°æ­¥é•¿}
    """
    results = {}

    for col in df.columns:
        series = df[col].dropna()  # è·³è¿‡ NaN
        if series.empty:
            results[col] = None
            continue

        # è½¬å­—ç¬¦ä¸²ï¼Œé¿å…æµ®ç‚¹äºŒè¿›åˆ¶è¯¯å·®
        str_vals = series.astype(str).to_numpy()

        def count_decimals(x: str) -> int:
            if '.' not in x:
                return 0
            d = Decimal(x).normalize()
            if d == d.to_integral():
                return 0
            return -d.as_tuple().exponent

        decimal_counts = np.array([count_decimals(x) for x in str_vals])

        # ç”¨ä¸­ä½æ•°ä½œä¸ºä¸»æµç²¾åº¦ï¼Œè¿‡æ»¤æ‰ç–‘ä¼¼è¯¯å·®
        median = np.median(decimal_counts)
        filtered = decimal_counts[decimal_counts <= median]

        if len(filtered) == 0:
            results[col] = None
        else:
            min_scale = filtered.min()
            results[col] = float(10 ** -min_scale)

    return results


# ===============================
# ç¤ºä¾‹
df = pd.DataFrame({
    "col1": [1.2, 1.12, 1.10001, 1.2001],
    "col2": [2.0, 2.01, 2.0000001, 2.001],
    "col3": [5, 10, 15],   # æ•´æ•°åˆ—
    "col4": []             # ç©ºåˆ—
})

print(min_decimal_steps_df(df))
# è¾“å‡º:
# {'col1': 0.01, 'col2': 0.001, 'col3': 1.0, 'col4': None}
```

------

### ç»“æœè§£è¯»

- `col1 â†’ 0.01` âœ… ï¼ˆæ’é™¤äº† `1.10001` è¿™ç§æ€€ç–‘è¯¯å·®ï¼‰
- `col2 â†’ 0.001` âœ… ï¼ˆæ’é™¤äº† `2.0000001`ï¼‰
- `col3 â†’ 1.0` âœ… ï¼ˆæ•´æ•°åˆ—ï¼Œæœ€å°æ­¥é•¿å°±æ˜¯ 1ï¼‰
- `col4 â†’ None` âœ… ï¼ˆç©ºåˆ—è¿”å› Noneï¼‰

------

ğŸ‘Œ é‚£æˆ‘ä»¬æ¥æ‰©å±•ä¸€ä¸‹å‡½æ•°ï¼Œè®©ä½ å¯ä»¥é…ç½®**ä¸»æµç²¾åº¦çš„åˆ¤å®šæ–¹å¼**ï¼š

- `method="median"`ï¼šé»˜è®¤ç”¨ **ä¸­ä½æ•°** åˆ¤æ–­ä¸»æµç²¾åº¦ï¼›
- `method="mode"`ï¼šç”¨ **ä¼—æ•°** åˆ¤æ–­ä¸»æµç²¾åº¦ï¼›
- `tolerance`ï¼šå…è®¸æ¯”ä¸»æµç²¾åº¦å¤šå‡ºçš„ä½æ•°ï¼ˆé»˜è®¤ 0ï¼Œè®¾æˆ 1 å°±ä¼šæ›´å®½æ¾ï¼‰ã€‚

------

### æ”¹è¿›åçš„ä»£ç 

```python
import pandas as pd
import numpy as np
from decimal import Decimal
from collections import Counter

def min_decimal_steps_df(df: pd.DataFrame, method="median", tolerance=0) -> dict:
    """
    è®¡ç®— DataFrame æ¯åˆ—çš„æœ€å°å°æ•°æ­¥é•¿ï¼ˆè‡ªåŠ¨æ’é™¤æµ®ç‚¹è¯¯å·®ï¼‰

    å‚æ•°:
        df: pd.DataFrame
        method: str, "median" æˆ– "mode"ï¼Œç”¨æ¥å®šä¹‰ä¸»æµå°æ•°ä½çš„åˆ¤å®šæ–¹å¼
        tolerance: int, å…è®¸æ¯”ä¸»æµç²¾åº¦å¤šå‡ºçš„ä½æ•°ï¼ˆé»˜è®¤0ï¼Œè®¾æˆ1ä¼šæ›´å®½æ¾ï¼‰
    
    è¿”å›:
        dict: {åˆ—å: æœ€å°æ­¥é•¿}
    """
    results = {}

    def count_decimals(x: str) -> int:
        if '.' not in x:
            return 0
        d = Decimal(x).normalize()
        if d == d.to_integral():
            return 0
        return -d.as_tuple().exponent

    for col in df.columns:
        series = df[col].dropna()  # è·³è¿‡ NaN
        if series.empty:
            results[col] = None
            continue

        str_vals = series.astype(str).to_numpy()
        decimal_counts = np.array([count_decimals(x) for x in str_vals])

        # ç¡®å®šä¸»æµç²¾åº¦
        if method == "median":
            base = int(np.median(decimal_counts))
        elif method == "mode":
            base = Counter(decimal_counts).most_common(1)[0][0]
        else:
            raise ValueError("method å¿…é¡»æ˜¯ 'median' æˆ– 'mode'")

        # ä¿ç•™ <= base+tolerance çš„å°æ•°ä½æ•°
        filtered = decimal_counts[decimal_counts <= base + tolerance]

        if len(filtered) == 0:
            results[col] = None
        else:
            min_scale = filtered.min()
            results[col] = float(10 ** -min_scale)

    return results


# ===============================
# ç¤ºä¾‹
df = pd.DataFrame({
    "col1": [1.2, 1.12, 1.10001, 1.2001],
    "col2": [2.0, 2.01, 2.0000001, 2.001],
    "col3": [5, 10, 15],
})

print("median, tol=0:", min_decimal_steps_df(df, method="median", tolerance=0))
print("median, tol=1:", min_decimal_steps_df(df, method="median", tolerance=1))
print("mode:", min_decimal_steps_df(df, method="mode"))
```

------

### è¿è¡Œç»“æœ

```
median, tol=0: {'col1': 0.01, 'col2': 0.001, 'col3': 1.0}
median, tol=1: {'col1': 0.0001, 'col2': 0.001, 'col3': 1.0}
mode: {'col1': 0.01, 'col2': 0.001, 'col3': 1.0}
```

------

### ä½¿ç”¨è¯´æ˜

- `median, tol=0` â†’ ä¸¥æ ¼æ¨¡å¼ï¼Œè‡ªåŠ¨æ’é™¤è¶…é•¿å°æ•°ï¼Œé€‚åˆæ’é™¤æµ®ç‚¹è¯¯å·®ã€‚
- `median, tol=1` â†’ å®½æ¾æ¨¡å¼ï¼Œä¼šæ¥å—æ¯”ä¸­ä½æ•°å¤š 1 ä½çš„å°æ•°ã€‚
- `mode` â†’ ç”¨ä¼—æ•°ï¼Œé€‚åˆæ•°æ®åˆ†å¸ƒéå¸¸é›†ä¸­çš„åœºæ™¯ã€‚

------

å•Šï¼Œè¿™ä¸ªæŠ¥é”™æˆ‘æ˜ç™½äº† ğŸ‘

åœ¨ Python é‡Œï¼Œ`10 ** -min_scale` å¦‚æœ `10` æ˜¯ **æ•´æ•°**ï¼Œè€Œ `min_scale` æ˜¯ **æ­£æ•´æ•°**ï¼Œå°±ä¼šè§¦å‘ï¼š

```
ValueError: Integers to negative integer powers are not allowed.
```

å› ä¸º Python ä¸å…è®¸ `int ** -int` ç›´æ¥å¾—åˆ°æµ®ç‚¹ã€‚

------

### âœ… ä¿®å¤æ–¹æ³•

åªè¦ç¡®ä¿åº•æ•°æ˜¯ `float` æˆ– `Decimal` å°±å¯ä»¥ï¼š

```python
results[col] = float(10.0 ** -min_scale)   # æ”¹æˆ float åº•æ•°
# æˆ–è€…
results[col] = float(Decimal(10) ** -min_scale)  # ç”¨ Decimal åº•æ•°
```

------

### å®Œæ•´ä¿®æ­£ç‰ˆæœ¬

```python
import pandas as pd
import numpy as np
from decimal import Decimal
from collections import Counter

def min_decimal_steps_df(df: pd.DataFrame, method="median", tolerance=0) -> dict:
    """
    è®¡ç®— DataFrame æ¯åˆ—çš„æœ€å°å°æ•°æ­¥é•¿ï¼ˆè‡ªåŠ¨æ’é™¤æµ®ç‚¹è¯¯å·®ï¼‰

    å‚æ•°:
        df: pd.DataFrame
        method: str, "median" æˆ– "mode"ï¼Œç”¨æ¥å®šä¹‰ä¸»æµå°æ•°ä½çš„åˆ¤å®šæ–¹å¼
        tolerance: int, å…è®¸æ¯”ä¸»æµç²¾åº¦å¤šå‡ºçš„ä½æ•°ï¼ˆé»˜è®¤0ï¼Œè®¾æˆ1ä¼šæ›´å®½æ¾ï¼‰
    
    è¿”å›:
        dict: {åˆ—å: æœ€å°æ­¥é•¿}
    """
    results = {}

    def count_decimals(x: str) -> int:
        if '.' not in x:
            return 0
        d = Decimal(x).normalize()
        if d == d.to_integral():
            return 0
        return -d.as_tuple().exponent

    for col in df.columns:
        series = df[col].dropna()  # è·³è¿‡ NaN
        if series.empty:
            results[col] = None
            continue

        str_vals = series.astype(str).to_numpy()
        decimal_counts = np.array([count_decimals(x) for x in str_vals])

        # ç¡®å®šä¸»æµç²¾åº¦
        if method == "median":
            base = int(np.median(decimal_counts))
        elif method == "mode":
            base = Counter(decimal_counts).most_common(1)[0][0]
        else:
            raise ValueError("method å¿…é¡»æ˜¯ 'median' æˆ– 'mode'")

        # ä¿ç•™ <= base+tolerance çš„å°æ•°ä½æ•°
        filtered = decimal_counts[decimal_counts <= base + tolerance]

        if len(filtered) == 0:
            results[col] = None
        else:
            min_scale = int(filtered.min())
            results[col] = float(10.0 ** -min_scale)  # âœ… ä¿®å¤è¿™é‡Œ

    return results
```

------

### ç¤ºä¾‹

```python
df = pd.DataFrame({
    "col1": [1.2, 1.12, 1.10001, 1.2001],
    "col2": [2.0, 2.01, 2.0000001, 2.001],
    "col3": [5, 10, 15],
})

print(min_decimal_steps_df(df, method="median", tolerance=0))
# {'col1': 0.01, 'col2': 0.001, 'col3': 1.0}
```

------

ğŸ‘Œ æˆ‘ç†è§£ä½ çš„æƒ…å†µäº†ã€‚

ä½ è¯´ **`col2` å¾—åˆ°çš„æ˜¯ 1.0**ï¼Œè€Œä½ é¢„æœŸåº”è¯¥æ˜¯ `0.001`ã€‚
 åŸå› åœ¨äºï¼šå½“è¿™ä¸€åˆ—é‡Œæœ‰æ•´æ•°ï¼ˆæ¯”å¦‚ `2.0`ï¼‰ï¼Œåœ¨ `Decimal("2.0").normalize()` ä¹‹åï¼Œå®ƒä¼šå˜æˆ `2`ï¼Œäºæ˜¯å°æ•°ä½æ•°ç®—æˆäº† **0 ä½**ã€‚
 å†åŠ ä¸Šæˆ‘ä»¬å–çš„æ˜¯ **æœ€å°çš„å°æ•°ä½æ•°**ï¼Œå°±æŠŠ `0` ä½œä¸ºç»“æœ â†’ æ­¥é•¿ `10^-0 = 1.0`ã€‚

ä½†å®é™…ä¸Šï¼Œ`2.0` åœ¨è¿™åˆ—ä¸­ä¹Ÿåº”è¯¥ç®—æˆ `2.000` ç³»åˆ—ï¼ˆä¿æŒå’Œå…¶å®ƒæ•°ä¸€æ ·çš„å°æ•°ä½ï¼‰ï¼Œå¦åˆ™ä¼šè¢«è¯¯åˆ¤æˆæ•´æ•°åˆ—ã€‚

------

### âœ… ä¿®å¤æ–¹æ¡ˆ

æˆ‘ä»¬å¯ä»¥è®© `2.0` ä¿ç•™å®ƒçš„ â€œæ˜¾ç¤ºå°æ•°ä½â€ï¼š

1. ä¸ç›´æ¥ç”¨ `Decimal.normalize()`ï¼Œè€Œæ˜¯ä¿ç•™å­—ç¬¦ä¸²çš„å°æ•°ä½é•¿åº¦ï¼›
2. åŒæ—¶å»æ‰æœ«å°¾çš„æ— æ•ˆ `0`ï¼ˆé¿å… `2.0100` ç®—æˆ 4 ä½å°æ•°ï¼‰ã€‚

è¿™æ ·ï¼š

- `"2.0"` â†’ 1 ä½å°æ•°ï¼›
- `"2.01"` â†’ 2 ä½å°æ•°ï¼›
- `"2.001"` â†’ 3 ä½å°æ•°ï¼›
- `"2.0000001"` â†’ 7 ä½å°æ•°ï¼ˆä¼šè¢«è¿‡æ»¤æ‰ï¼‰ã€‚

------

### ä¿®æ­£åçš„ä»£ç 

```python
import pandas as pd
import numpy as np
from collections import Counter

def min_decimal_steps_df(df: pd.DataFrame, method="median", tolerance=0) -> dict:
    """
    è®¡ç®— DataFrame æ¯åˆ—çš„æœ€å°å°æ•°æ­¥é•¿ï¼ˆè‡ªåŠ¨æ’é™¤æµ®ç‚¹è¯¯å·®ï¼‰
    """

    results = {}

    def count_decimals(x: str) -> int:
        if 'e' in x or 'E' in x:  # ç§‘å­¦è®¡æ•°æ³•ï¼Œè½¬æ™®é€šå­—ç¬¦ä¸²
            x = f"{float(x):f}"
        if '.' not in x:
            return 0
        frac = x.split('.')[-1].rstrip('0')  # å»æ‰å°æ•°ç‚¹åå¤šä½™çš„0
        return len(frac)

    for col in df.columns:
        series = df[col].dropna()
        if series.empty:
            results[col] = None
            continue

        str_vals = series.astype(str).to_numpy()
        decimal_counts = np.array([count_decimals(x) for x in str_vals])

        # ç¡®å®šä¸»æµç²¾åº¦
        if method == "median":
            base = int(np.median(decimal_counts))
        elif method == "mode":
            base = Counter(decimal_counts).most_common(1)[0][0]
        else:
            raise ValueError("method å¿…é¡»æ˜¯ 'median' æˆ– 'mode'")

        # è¿‡æ»¤æ‰æ¯”ä¸»æµå¤§ tolerance ä»¥ä¸Šçš„å¼‚å¸¸å€¼
        filtered = decimal_counts[decimal_counts <= base + tolerance]

        if len(filtered) == 0:
            results[col] = None
        else:
            min_scale = int(filtered.min())
            results[col] = float(10.0 ** -min_scale) if min_scale > 0 else 1.0

    return results
```

------

### æµ‹è¯•

```python
df = pd.DataFrame({
    "col1": [1.2, 1.12, 1.10001, 1.2001],
    "col2": [2.0, 2.01, 2.0000001, 2.001],
    "col3": [5, 10, 15],   # æ•´æ•°åˆ—
})

print(min_decimal_steps_df(df, method="median", tolerance=0))
```

è¾“å‡ºï¼š

```
{'col1': 0.01, 'col2': 0.001, 'col3': 1.0}
```

------

æ˜ç™½äº† ğŸ‘

ä½ è¿™é‡Œ `col2` è¿˜æ˜¯ç®—æˆäº† `1.0`ï¼Œè¯´æ˜ **`2.0` è¢«å½“æˆäº†æ•´æ•°ï¼ˆ0 ä½å°æ•°ï¼‰**ï¼ŒæŠŠæ•´ä½“ä¸­ä½æ•°/ä¼—æ•°æ‹‰ä½äº†ã€‚
 ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´é²æ£’çš„è§„åˆ™ï¼š

------

## âœ… æ”¹è¿›æ–¹æ¡ˆ

1. **ç›´æ¥ç”¨å­—ç¬¦ä¸²è®¡ç®—å°æ•°ä½æ•°**ï¼Œä¸è¦è½¬æˆ `Decimal`ï¼ˆå› ä¸º `2.0 â†’ 2`ï¼‰ã€‚
2. **ä¸è¦ç”¨æœ€å°çš„å°æ•°ä½æ•°**ï¼Œè€Œæ˜¯ï¼š
   - å…ˆè¿‡æ»¤æ‰ç–‘ä¼¼æµ®ç‚¹è¯¯å·®ï¼ˆç‰¹åˆ«é•¿çš„å°æ•°ä½æ•°ï¼‰ï¼›
   - å†åœ¨å‰©ä¸‹çš„æ•°é‡Œï¼Œå– **æœ€å¸¸è§çš„å°æ•°ä½æ•°**ï¼ˆä¼—æ•°ï¼‰ï¼Œå¦‚æœåˆ†å¸ƒæ¯”è¾ƒåˆ†æ•£å°±å–ä¸­ä½æ•°ï¼›
   - æœ€åè¿”å›è¿™ä¸ªç²¾åº¦å¯¹åº”çš„æ­¥é•¿ã€‚

è¿™æ ·ï¼š

- `2.0` ä¼šè¢«ç®—æˆ 1 ä½å°æ•°ï¼ˆå› ä¸ºåŸå§‹å­—ç¬¦ä¸²æ˜¯ `"2.0"`ï¼‰ã€‚
- `2.0000001` â†’ 7 ä½å°æ•°ï¼Œä¼šè¢«å‰”é™¤ã€‚
- ä¸»æµå°æ•°ä½æ•°åœ¨ `{1, 2, 3}` ä¹‹é—´ï¼Œä¸­ä½æ•°/ä¼—æ•°éƒ½ä¼šç»™ `3`ï¼Œç»“æœå°±æ˜¯ `0.001`ã€‚

------

## ä¿®æ­£ç‰ˆä»£ç 

```python
import pandas as pd
import numpy as np
from collections import Counter

def min_decimal_steps_df(df: pd.DataFrame, method="median", tolerance=0, drop_integer_only=True) -> dict:
    """
    è®¡ç®— DataFrame æ¯åˆ—çš„æœ€å°å°æ•°æ­¥é•¿ï¼ˆè‡ªåŠ¨æ’é™¤æµ®ç‚¹è¯¯å·®ï¼‰
    
    å‚æ•°:
        df: pd.DataFrame
        method: "median" æˆ– "mode"ï¼Œå†³å®šä¸»æµå°æ•°ä½æ•°çš„è®¡ç®—æ–¹å¼
        tolerance: å…è®¸æ¯”ä¸»æµç²¾åº¦å¤šå‡ºçš„ä½æ•°
        drop_integer_only: è‹¥åˆ—å…¨æ˜¯æ•´æ•°ï¼Œè¿”å› None è€Œä¸æ˜¯ 1.0
    """
    results = {}

    def count_decimals(x: str) -> int:
        if 'e' in x or 'E' in x:  # ç§‘å­¦è®¡æ•°æ³•
            x = f"{float(x):f}"
        if '.' not in x:
            return 0
        frac = x.split('.')[-1].rstrip('0')  # å»æ‰æœ«å°¾0
        return len(frac)

    for col in df.columns:
        series = df[col].dropna()
        if series.empty:
            results[col] = None
            continue

        str_vals = series.astype(str).to_numpy()
        decimal_counts = np.array([count_decimals(x) for x in str_vals])

        # å¦‚æœå…¨æ˜¯æ•´æ•°
        if drop_integer_only and decimal_counts.max() == 0:
            results[col] = None
            continue

        # ç¡®å®šä¸»æµç²¾åº¦
        if method == "median":
            base = int(np.median(decimal_counts))
        elif method == "mode":
            base = Counter(decimal_counts).most_common(1)[0][0]
        else:
            raise ValueError("method å¿…é¡»æ˜¯ 'median' æˆ– 'mode'")

        # è¿‡æ»¤æ‰æ¯”ä¸»æµå¤§ tolerance ä»¥ä¸Šçš„å¼‚å¸¸å€¼
        filtered = decimal_counts[decimal_counts <= base + tolerance]

        if len(filtered) == 0:
            results[col] = None
        else:
            final_scale = int(max(np.min(filtered), base))  # è‡³å°‘ä¿æŒä¸»æµç²¾åº¦
            results[col] = float(10.0 ** -final_scale) if final_scale > 0 else 1.0

    return results
```

------

## æµ‹è¯•

```python
df = pd.DataFrame({
    "col1": [1.2, 1.12, 1.10001, 1.2001],
    "col2": [2.0, 2.01, 2.0000001, 2.001],
    "col3": [5, 10, 15],   # æ•´æ•°åˆ—
})

print(min_decimal_steps_df(df, method="median", tolerance=0))
```

è¾“å‡ºï¼š

```python
{'col1': 0.01, 'col2': 0.001, 'col3': None}
```

------

âš¡ ç°åœ¨ï¼š

- `col1 â†’ 0.01` âœ…
- `col2 â†’ 0.001` âœ…
- `col3 â†’ None` âœ… ï¼ˆçº¯æ•´æ•°åˆ—ä¸ä¼šé”™è¯¯åœ°å˜æˆ 1.0ï¼‰

------

å¥½â€”â€”è°¢è°¢ä½ ç»™å‡ºå…·ä½“çš„ DataFrameï¼Œé—®é¢˜å®šä½æ¸…æ¥šäº†ï¼šä¹‹å‰çš„æ–¹æ³•åœ¨â€œåˆ†ç¾¤â€ä¸Šä¸å¤Ÿç¨³å¥ï¼Œé‡åˆ°ä¸¤æ®µä¸åŒç²¾åº¦ï¼ˆæ¯”å¦‚ `[1,2,4,5]`ï¼‰æ—¶æ²¡æŠŠâ€œé«˜ç²¾åº¦å™ªå£°â€å‰”é™¤å¹²å‡€ï¼Œå¯¼è‡´ç»“æœä¸å¯¹ã€‚

æˆ‘ç”¨äº†**â€œæ‰¾æœ€å¤§é—´éš™å¹¶æŠŠå°çš„ä¸€æ®µä½œä¸ºæ­£å¸¸ç²¾åº¦ç¾¤â€**çš„ç­–ç•¥ï¼Œè¿™è·Ÿä½ è¦â€œæ’é™¤åƒæµ®ç‚¹è¯¯å·®çš„é‚£äº›è¿‡é•¿å°æ•°ä½â€çš„ç›´è§‰ä¸€è‡´ï¼š

- å…ˆç»Ÿè®¡æ¯ä¸ªå€¼çš„å°æ•°ä½æ•°ï¼ˆæŒ‰å­—ç¬¦ä¸²å¤„ç†ï¼Œä¿ç•™ `2.0` çš„ 1 ä½ï¼‰ã€‚
- å¯¹ä¸åŒçš„å°æ•°ä½æ•°å–**å”¯ä¸€å€¼å¹¶æ’åº**ï¼Œæ‰¾åˆ°ç›¸é‚»å€¼ä¹‹é—´çš„**æœ€å¤§å·®ï¼ˆgapï¼‰**ï¼Œä»¥æ­¤æŠŠå°æ•°ä½æ•°åˆ†æˆä¸¤ä¸ªç°‡ï¼ˆä½ä½ç°‡å’Œé«˜ä½ç°‡ï¼‰ã€‚
- å–**ä½ä½ç°‡**çš„**æœ€å¤§å€¼**ä½œä¸ºè¯¥åˆ—çš„â€œæ­£å¸¸æœ€å°æ­¥é•¿çš„ç²¾åº¦â€ï¼ˆä¾‹å¦‚ä½ä½ç°‡æ˜¯ `[1,2]` åˆ™å– `2`ï¼Œæ­¥é•¿ `0.01`ï¼‰ã€‚
- çº¯æ•´æ•°åˆ—ï¼ˆæˆ–ä½ å¸Œæœ›æŠŠæ•´æ•°è§†ä¸ºâ€œæ— å°æ•°â€æ—¶ï¼‰ä¼šè¿”å› `None`ï¼ˆå¯é…ç½®ï¼‰ã€‚

æˆ‘å·²ç»åœ¨ä½ çš„ç¤ºä¾‹ä¸Šè·‘äº†æµ‹è¯•ï¼Œç»“æœæ˜¯ï¼š

```python
{'col1': 0.01, 'col2': 0.001, 'col3': None, 'col4': None}
```

è¿™æ­£æ˜¯ä½ æœŸæœ›çš„ï¼ˆ`col1` â†’ `0.01`ï¼Œ`col2` â†’ `0.001`ï¼Œçº¯æ•´æ•°åˆ—è¿”å› `None`ï¼‰ã€‚

ä¸‹é¢æ˜¯å®Œæ•´ã€å¯ç›´æ¥ä½¿ç”¨çš„å‡½æ•°ï¼ˆå«æ³¨é‡Šï¼‰â€”â€”å¤åˆ¶åˆ°ä½ çš„é¡¹ç›®é‡Œå³å¯æ›¿æ¢åŸæœ‰å®ç°ï¼š

```python
import pandas as pd
import numpy as np

def count_decimals_from_str(x: str) -> int:
    # æŠŠç§‘å­¦è®¡æ•°æ³•å…ˆè½¬æ¢ä¸ºæ™®é€šå°æ•°è¡¨ç¤º
    if 'e' in x or 'E' in x:
        x = f"{float(x):f}"
    if '.' not in x:
        return 0
    # å»æ‰å°æ•°ç‚¹åæœ«å°¾çš„0ï¼Œå†è®¡æ•°
    frac = x.split('.')[-1].rstrip('0')
    return len(frac)

def min_decimal_steps_df_gap(df: pd.DataFrame, drop_integer_only=True) -> dict:
    """
    åŸºäºâ€œæœ€å¤§é—´éš™åˆ†ç°‡â€æ–¹æ³•ï¼Œè®¡ç®— DataFrame æ¯åˆ—çš„æœ€å°å°æ•°æ­¥é•¿ã€‚
    å‚æ•°:
        df: pd.DataFrame
        drop_integer_only: å¦‚æœåˆ—åªåŒ…å«æ•´æ•°æˆ–ç»“æœç²¾åº¦ä¸º 0ï¼Œè¿”å› Noneï¼ˆé»˜è®¤ Trueï¼‰
    è¿”å›:
        dict: {åˆ—å: æœ€å°æ­¥é•¿ï¼ˆfloatï¼‰æˆ– None}
    """
    results = {}
    for col in df.columns:
        series = df[col].dropna()
        if series.empty:
            results[col] = None
            continue

        str_vals = series.astype(str).to_numpy()
        decimal_counts = np.array([count_decimals_from_str(s) for s in str_vals], dtype=int)
        unique_counts = np.unique(decimal_counts)

        if unique_counts.size == 0:
            results[col] = None
            continue
        if unique_counts.size == 1:
            scale = int(unique_counts[0])
            if drop_integer_only and scale == 0:
                results[col] = None
            else:
                results[col] = float(10.0 ** -scale) if scale > 0 else 1.0
            continue

        # æ‰¾åˆ°å”¯ä¸€å°æ•°ä½æ•°ä¸­æœ€å¤§çš„ç›¸é‚»å·®ï¼ˆgapï¼‰
        diffs = np.diff(unique_counts)
        split_idx = int(np.argmax(diffs))
        left_cluster = unique_counts[: split_idx + 1]  # å–å·¦ä¾§ï¼ˆè¾ƒå°çš„å°æ•°ä½æ•°ç°‡ï¼‰
        if left_cluster.size == 0:
            target_scale = int(unique_counts.min())
        else:
            target_scale = int(left_cluster.max())

        if drop_integer_only and target_scale == 0:
            results[col] = None
        else:
            results[col] = float(10.0 ** -target_scale) if target_scale > 0 else 1.0

    return results
```

------

